# Smart Campus 共享数据库配置指南

## 服务器信息

- **计算机名**: `DESKTOP-2QVAB5J`
- **共享文件夹**: `\\\\DESKTOP-2QVAB5J\\h2-shared`
- **数据库名称**: `smartcampus`

## 客户端配置

### 1. 修改 application.yml

在设备的 `src/main/resources/application.yml` 中修改数据库连接:

```yaml
spring:
  datasource:
    url: jdbc:h2:tcp://DESKTOP-2QVAB5J:9092/smartcampus;DB_CLOSE_DELAY=-1;MODE=MYSQL;DATABASE_TO_LOWER=TRUE
    username: sa
    password:
    driver-class-name: org.h2.Driver
```

### 2. 修改 application.properties

在设备的 `src/main/resources/application.properties` 中修改数据库连接:

```properties
spring.datasource.url=jdbc:h2:tcp://DESKTOP-2QVAB5J:9092/smartcampus
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```

## H2 控制台访问

### 服务器端访问

直接访问: http://localhost:8081/h2-console

连接配置:
- Saved Settings: Generic H2(Server)
- JDBC URL: `jdbc:h2:\\DESKTOP-2QVAB5J\h2-shared\smartcampus`
- 用户名: `sa`
- 密码: (空)

### 客户端访问

客户端访问 H2 控制台需要修改 application.yml:

```yaml
spring:
  h2:
    console:
      enabled: true
      path: /h2-console
      settings:
        web-allow-others: true
```

然后访问: http://本机IP:8081/h2-console

连接配置:
- JDBC URL: `jdbc:h2:tcp://DESKTOP-2QVAB5J:9092/smartcampus`
- 用户名: `sa`
- 密码: (空)

## 计算机名说明

### 为什么使用计算机名而不是IP地址？

1. **动态适应**: IPv4地址可能会变化，但计算机名保持不变
2. **DNS解析**: Windows系统会自动将计算机名解析为当前的IP地址
3. **无需修改**: 客户端无需知道具体的IP地址，只需知道计算机名

### 如何获取服务器计算机名？

在服务器上执行以下命令:
```bash
hostname
```

### 客户端测试连接

在客户端的文件资源管理器地址栏输入:
```
\\\\DESKTOP-2QVAB5J\\h2-shared
```

如果能看到共享文件夹内容，说明网络连接正常。

## 常见问题

### Q1: 连接被拒绝

**原因**: 防火墙阻止连接

**解决方案**:
1. 在服务器上开放 9092 端口
2. 或临时关闭防火墙（不推荐）

### Q2: 数据库文件被锁定

**原因**: 多个进程同时访问数据库文件

**解决方案**:
1. 确保只有一个 H2 服务器实例运行
2. 使用 TCP 模式连接（而非直接文件访问）

### Q3: 找不到数据库文件

**原因**: 共享文件夹路径错误或未共享

**解决方案**:
1. 确认共享文件夹路径正确: `\\\\DESKTOP-2QVAB5J\\h2-shared`
2. 确认文件夹已设置为共享
3. 测试从其他设备访问共享文件夹

### Q4: 数据不同步

**原因**: 客户端使用了本地数据库

**解决方案**:
1. 确认 application.properties 中的 URL 以 `tcp://DESKTOP-2QVAB5J:9092` 开头
2. 确认 application.yml 中的 URL 也以 `tcp://DESKTOP-2QVAB5J:9092` 开头
3. 重启 Spring Boot 使配置生效

### Q5: 无法解析计算机名

**原因**: DNS解析失败或网络问题

**解决方案**:
1. 检查客户端和服务器是否在同一局域网
2. 尝试使用IP地址直接连接（临时方案）
3. 检查Windows防火墙设置
4. 确保网络发现已启用

## 数据库备份

### 方法1: 复制文件

直接复制共享文件夹中的 `smartcampus.mv.db` 文件。

### 方法2: H2 导出

访问 H2 控制台，执行:

```sql
BACKUP TO 'backup.zip';
```

### 方法3: SQL 导出

```bash
# 导出
java -cp h2*.jar org.h2.tools.Shell -url jdbc:h2:tcp://DESKTOP-2QVAB5J:9092/smartcampus -user sa -sql "SCRIPT TO 'backup.sql'"
```

## 联系人

如有问题，请联系系统管理员。

## 更新日志

| 日期 | 版本 | 说明 |
|------|------|------|
| 2025-12-26 | 1.1 | 使用计算机名代替IP地址，解决IPv4地址变化导致的连接问题 |
| 2025-01-25 | 1.0 | 初始版本 |
