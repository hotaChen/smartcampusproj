# Smart Campus 共享数据库配置指南

## 客户端配置

### 1. 修改 application.yml

在设备的 `src/main/resources/application.yml` 中修改数据库连接:

```yaml
spring:
  datasource:
    url: jdbc:h2:tcp://172.28.96.1:9092/smartcampus;DB_CLOSE_DELAY=-1;MODE=MYSQL;DATABASE_TO_LOWER=TRUE
    username: sa
    password:
    driver-class-name: org.h2.Driver
```

## H2 控制台访问

### 服务器端访问

直接访问: http://localhost:8081/h2-console

连接配置:
- Saved Settings: Generic H2(Server)
- JDBC URL: `jdbc:h2:\\172.28.96.1\h2-shared\smartcampus`
- 用户名: `sa`
- 密码: (空)

### 客户端访问

客户端访问 H2 控制台需要修改 application.yml:

```yaml
spring:
  h2:
    console:
      enabled: true
      path: /h2-console
      settings:
        web-allow-others: true
```

然后访问: http://本机IP:8081/h2-console

连接配置:
- JDBC URL: `jdbc:h2:tcp://172.28.96.1:9092/smartcampus`
- 用户名: `sa`
- 密码: (空)

## 常见问题

### Q1: 连接被拒绝

**原因**: 防火墙阻止连接

**解决方案**:
1. 在服务器上开放 9092 端口
2. 或临时关闭防火墙（不推荐）

### Q2: 数据库文件被锁定

**原因**: 多个进程同时访问数据库文件

**解决方案**:
1. 确保只有一个 H2 服务器实例运行
2. 使用 TCP 模式连接（而非直接文件访问）

### Q3: 找不到数据库文件

**原因**: 共享文件夹路径错误或未共享

**解决方案**:
1. 确认共享文件夹路径正确
2. 确认文件夹已设置为共享
3. 测试从其他设备访问共享文件夹

### Q4: 数据不同步

**原因**: 客户端使用了本地数据库

**解决方案**:
1. 确认 application.yml 中的 URL 以 `tcp://` 开头
2. 重启 Spring Boot 使配置生效

## 数据库备份

### 方法1: 复制文件

直接复制共享文件夹中的 `smartcampus.mv.db` 文件。

### 方法2: H2 导出

访问 H2 控制台，执行:

```sql
BACKUP TO 'backup.zip';
```

### 方法3: SQL 导出

```bash
# 导出
java -cp h2*.jar org.h2.tools.Shell -url jdbc:h2:tcp://172.28.96.1:9092/smartcampus -user sa -sql "SCRIPT TO 'backup.sql'"
```

## 联系人

如有问题，请联系系统管理员。

## 更新日志

| 日期 | 版本 | 说明 |
|------|------|------|
| 2025-01-25 | 1.0 | 初始版本 |
