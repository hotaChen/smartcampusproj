<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>助学金管理 - Egg University</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>

<div class="page-content">
    <h1 class="page-title">助学金管理</h1>
    
    <div class="toolbar">
        <button class="btn secondary" onclick="goBack()">返回财务管理</button>
    </div>

    <div class="form-card">
        <div class="form-card-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            <span>添加助学金记录</span>
        </div>
        <div class="form-card-body">
            <div class="form-row">
                <div class="form-group">
                    <label>学号</label>
                    <input type="text" id="studentNumber" class="input" placeholder="请输入学生学号">
                </div>
                <div class="form-group">
                    <label>助学金名称</label>
                    <input type="text" id="name" class="input" placeholder="请输入助学金名称">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>助学金类型</label>
                    <input type="text" id="type" class="input" placeholder="请输入助学金类型">
                </div>
                <div class="form-group">
                    <label>学期</label>
                    <input type="text" id="semester" class="input" placeholder="如：2024-2025学年第一学期">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>助学金金额</label>
                    <input type="number" id="amount" class="input" placeholder="请输入助学金金额" step="0.01">
                </div>
                <div class="form-group">
                    <label>获奖日期</label>
                    <input type="date" id="awardDate" class="input">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>申请原因</label>
                    <textarea id="reason" class="input textarea" placeholder="请输入申请原因"></textarea>
                </div>
                <div class="form-group">
                    <label>申请状态</label>
                    <select id="status" class="input">
                        <option value="0">待审批</option>
                        <option value="1">已批准</option>
                        <option value="2">已拒绝</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>备注描述</label>
                <textarea id="description" class="input textarea" placeholder="请输入备注描述（可选）"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn primary" onclick="addFinancialAid()">添加助学金记录</button>
            </div>
        </div>
    </div>

    <div class="info-card">
        <div class="info-card-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
            <span>助学金记录列表</span>
        </div>
        <div class="info-card-body">
            <div id="financialaid-list">
                <div class="empty-state">正在加载助学金信息...</div>
            </div>
        </div>
    </div>
</div>

<style>
.form-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    overflow: hidden;
    margin-bottom: 24px;
}

.form-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 20px 24px;
    background: linear-gradient(135deg, rgba(167, 243, 208, 0.15), rgba(16, 185, 129, 0.1));
    border-bottom: 1px solid rgba(167, 243, 208, 0.2);
    font-size: 18px;
    font-weight: 600;
    color: #a7f3d0;
}

.form-card-header svg {
    width: 24px;
    height: 24px;
    stroke: #10b981;
    stroke-width: 2;
    fill: none;
}

.form-card-body {
    padding: 24px;
}

.info-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    overflow: hidden;
}

.info-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 20px 24px;
    background: linear-gradient(135deg, rgba(167, 243, 208, 0.15), rgba(16, 185, 129, 0.1));
    border-bottom: 1px solid rgba(167, 243, 208, 0.2);
    font-size: 18px;
    font-weight: 600;
    color: #a7f3d0;
}

.info-card-header svg {
    width: 24px;
    height: 24px;
    stroke: #10b981;
    stroke-width: 2;
    fill: none;
}

.info-card-body {
    padding: 24px;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: var(--text);
    font-weight: 500;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.input {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    color: var(--text);
    font-size: 14px;
    transition: all 0.3s ease;
}

.input:focus {
    outline: none;
    border-color: rgba(16, 185, 129, 0.5);
    background: rgba(255, 255, 255, 0.12);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.textarea {
    min-height: 100px;
    resize: vertical;
}

select.input {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a7f3d0' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 40px;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 20px;
}

.data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.data-table th {
    background: rgba(167, 243, 208, 0.1);
    color: #a7f3d0;
    padding: 14px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    border-bottom: 1px solid rgba(167, 243, 208, 0.2);
}

.data-table th:first-child {
    border-radius: 12px 0 0 0;
}

.data-table th:last-child {
    border-radius: 0 12px 0 0;
}

.data-table td {
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    color: var(--text);
    font-size: 14px;
}

.data-table tr:last-child td {
    border-bottom: none;
}

.data-table tr:hover td {
    background: rgba(255, 255, 255, 0.05);
}

.data-table .empty-state {
    text-align: center;
    padding: 40px;
    color: rgba(255, 255, 255, 0.5);
}

.action-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s ease;
    margin-right: 8px;
}

.action-btn.edit {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
    color: #93c5fd;
    border: 1px solid rgba(59, 130, 246, 0.3);
}

.action-btn.edit:hover {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.3));
}

.action-btn.delete {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
    color: #fca5a5;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.action-btn.delete:hover {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.3));
}

.btn {
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn.primary {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
    color: #6ee7b7;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.btn.primary:hover {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3));
}

.btn.secondary {
    background: rgba(255, 255, 255, 0.08);
    color: var(--text);
    border: 1px solid rgba(255, 255, 255, 0.12);
}

.btn.secondary:hover {
    background: rgba(255, 255, 255, 0.12);
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
}

.status-success {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
    color: #6ee7b7;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.status-error {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
    color: #fca5a5;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.status-pending {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2));
    color: #fcd34d;
    border: 1px solid rgba(245, 158, 11, 0.3);
}
</style>

<script>
const statusMap = {
    '0': '待审批',
    '1': '已批准',
    '2': '已拒绝'
};

function getStatusText(status) {
    if (status === null || status === undefined) return '-';
    return statusMap[status.toString()] || status;
}

function formatAmount(amount) {
    if (amount === null || amount === undefined) return '-';
    const num = parseFloat(amount);
    if (isNaN(num)) return '-';
    return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

document.addEventListener('DOMContentLoaded', function() {
    SidebarManager.init({ 
        currentPage: 'financialaid-manage',
        onReady: function(user) {
            if (user.userType !== 'ADMIN') {
                document.querySelector('.page-title').textContent = '您没有权限访问此页面';
                document.querySelector('.page-title').style.color = '#f87171';
                document.querySelector('.form-card').style.display = 'none';
                document.querySelector('.info-card').style.display = 'none';
                return;
            }
            loadFinancialAidInfo();
        }
    });
    HeaderComponent.init();
});

function loadFinancialAidInfo() {
    apiRequest('/api/financial-aids')
        .then(resp => resp.json())
        .then(data => {
            let html = '<table class="data-table"><thead><tr>';
            html += '<th>助学金类型</th><th>学生姓名</th><th>学号</th><th>金额</th><th>申请状态</th><th>申请日期</th><th>审批日期</th><th>操作</th></tr>';
            
            if (data && data.length > 0) {
                data.forEach(financialAid => {
                    const statusClass = financialAid.status === 1 ? 'success' : financialAid.status === 2 ? 'error' : 'pending';
                    const statusText = financialAid.status === 0 ? '待审批' : financialAid.status === 1 ? '已批准' : financialAid.status === 2 ? '已拒绝' : '-';
                    const createDate = financialAid.createTime ? new Date(financialAid.createTime).toLocaleDateString('zh-CN') : '-';
                    const updateDate = financialAid.updateTime ? new Date(financialAid.updateTime).toLocaleDateString('zh-CN') : '-';
                    
                    html += `<tr>
                        <td>${financialAid.type || '-'}</td>
                        <td>${financialAid.studentName || '-'}</td>
                        <td>${financialAid.studentNumber || '-'}</td>
                        <td>${formatAmount(financialAid.amount)}</td>
                        <td><span class="status-badge status-${statusClass}">${statusText}</span></td>
                        <td>${createDate}</td>
                        <td>${updateDate}</td>
                        <td>
                            <button class="action-btn edit" onclick="editFinancialAid(${financialAid.id})">编辑</button>
                            <button class="action-btn delete" onclick="deleteFinancialAid(${financialAid.id})">删除</button>
                        </td>
                    </tr>`;
                });
            } else {
                html += '<tr><td colspan="8" class="empty-state">暂无助学金记录</td></tr>';
            }
            
            html += '</table>';
            document.getElementById('financialaid-list').innerHTML = html;
        })
        .catch(err => {
            console.error(err);
            document.getElementById('financialaid-list').innerHTML = '<div class="empty-state" style="color: #f87171;">加载助学金信息失败</div>';
        });
}

function addFinancialAid() {
    const studentNumber = document.getElementById('studentNumber').value;
    const name = document.getElementById('name').value;
    const type = document.getElementById('type').value;
    const semester = document.getElementById('semester').value;
    const amount = document.getElementById('amount').value;
    const awardDate = document.getElementById('awardDate').value;
    const reason = document.getElementById('reason').value;
    const description = document.getElementById('description').value;
    const status = document.getElementById('status').value;
    
    if (!studentNumber || !name || !type || !semester || !amount || !awardDate || !reason) {
        showToast('请填写完整信息（备注描述除外）');
        return;
    }
    
    const financialAidData = {
        studentNumber: studentNumber,
        name: name,
        type: type,
        semester: semester,
        amount: parseFloat(amount),
        awardDate: awardDate ? awardDate + 'T00:00:00' : null,
        reason: reason,
        description: description,
        status: parseInt(status)
    };
    
    apiRequest('/api/financial-aids', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(financialAidData)
    })
    .then(resp => resp.json())
    .then(data => {
        showToast('助学金记录添加成功');
        document.getElementById('studentNumber').value = '';
        document.getElementById('name').value = '';
        document.getElementById('type').value = '';
        document.getElementById('semester').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('awardDate').value = '';
        document.getElementById('reason').value = '';
        document.getElementById('description').value = '';
        document.getElementById('status').value = '0';
        loadFinancialAidInfo();
    })
    .catch(err => {
        console.error(err);
        showToast('添加助学金记录失败');
    });
}

function editFinancialAid(id) {
    apiRequest(`/api/financial-aids/${id}`)
        .then(resp => resp.json())
        .then(financialAid => {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:rgba(30,41,59,0.95);border-radius:10px;padding:0;max-width:360px;width:90%;border:1px solid rgba(255,255,255,0.1);box-shadow:0 20px 40px -8px rgba(0,0,0,0.6);">
                    <div style="padding:10px 14px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;color:#f1f5f9;font-size:14px;font-weight:600;">编辑助学金</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background:none;border:none;color:#94a3b8;cursor:pointer;font-size:20px;line-height:1;padding:0;">&times;</button>
                    </div>
                    <div style="padding:12px;">
                        <div class="form-group">
                            <label style="display:block;margin-bottom:4px;color:var(--text);font-weight:500;font-size:12px;">助学金名称</label>
                            <input type="text" id="edit-name" class="input" value="${financialAid.name || ''}" style="width:100%;padding:8px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:var(--text);font-size:12px;">
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                            <div class="form-group">
                                <label style="display:block;margin-bottom:4px;color:var(--text);font-weight:500;font-size:12px;">类型</label>
                                <input type="text" id="edit-type" class="input" value="${financialAid.type || ''}" style="width:100%;padding:8px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:var(--text);font-size:12px;">
                            </div>
                            <div class="form-group">
                                <label style="display:block;margin-bottom:4px;color:var(--text);font-weight:500;font-size:12px;">学期</label>
                                <input type="text" id="edit-semester" class="input" value="${financialAid.semester || ''}" placeholder="如：2024-2025第一学期" style="width:100%;padding:8px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:var(--text);font-size:12px;">
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                            <div class="form-group">
                                <label style="display:block;margin-bottom:4px;color:var(--text);font-weight:500;font-size:12px;">金额</label>
                                <input type="number" id="edit-amount" class="input" value="${financialAid.amount || ''}" step="0.01" style="width:100%;padding:8px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:var(--text);font-size:12px;">
                            </div>
                            <div class="form-group">
                                <label style="display:block;margin-bottom:4px;color:var(--text);font-weight:500;font-size:12px;">获奖日期</label>
                                <input type="date" id="edit-awardDate" class="input" value="${financialAid.awardDate ? financialAid.awardDate.substring(0, 10) : ''}" style="width:100%;padding:8px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:var(--text);font-size:12px;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="display:block;margin-bottom:4px;color:var(--text);font-weight:500;font-size:12px;">申请状态</label>
                            <select id="edit-status" class="input" style="width:100%;padding:8px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:var(--text);font-size:12px;cursor:pointer;appearance:none;background-image:url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a7f3d0' d='M6 8L1 3h10z'/%3E%3C/svg%3E\");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px;">
                                <option value="0" ${financialAid.status === 0 ? 'selected' : ''}>待审批</option>
                                <option value="1" ${financialAid.status === 1 ? 'selected' : ''}>已批准</option>
                                <option value="2" ${financialAid.status === 2 ? 'selected' : ''}>已拒绝</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="display:block;margin-bottom:4px;color:var(--text);font-weight:500;font-size:12px;">申请原因</label>
                            <textarea id="edit-reason" class="input textarea" style="width:100%;padding:8px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:var(--text);font-size:12px;min-height:50px;resize:vertical;">${financialAid.reason || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label style="display:block;margin-bottom:4px;color:var(--text);font-weight:500;font-size:12px;">备注描述</label>
                            <textarea id="edit-description" class="input textarea" style="width:100%;padding:8px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:var(--text);font-size:12px;min-height:50px;resize:vertical;">${financialAid.description || ''}</textarea>
                        </div>
                        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                            <button onclick="this.closest('.modal-overlay').remove()" class="btn secondary" style="padding:8px 14px;border-radius:6px;border:none;cursor:pointer;font-size:12px;font-weight:500;background:rgba(255,255,255,0.1);color:var(--text);">取消</button>
                            <button onclick="saveFinancialAid(${financialAid.id})" class="btn primary" style="padding:8px 14px;border-radius:6px;border:none;cursor:pointer;font-size:12px;font-weight:500;background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(5,150,105,0.2));color:#6ee7b7;border:1px solid rgba(16,185,129,0.3);">保存</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        })
        .catch(err => {
            console.error(err);
            showToast('获取助学金信息失败');
        });
}

function saveFinancialAid(id) {
    const name = document.getElementById('edit-name').value;
    const type = document.getElementById('edit-type').value;
    const semester = document.getElementById('edit-semester').value;
    const amount = document.getElementById('edit-amount').value;
    const awardDate = document.getElementById('edit-awardDate').value;
    const status = document.getElementById('edit-status').value;
    const reason = document.getElementById('edit-reason').value;
    const description = document.getElementById('edit-description').value;
    
    if (!name || !type || !semester || !amount || !awardDate || !reason) {
        showToast('请填写完整信息（备注描述除外）');
        return;
    }
    
    const financialAidData = {
        name: name,
        type: type,
        semester: semester,
        amount: parseFloat(amount),
        awardDate: awardDate ? awardDate + 'T00:00:00' : null,
        reason: reason,
        description: description,
        status: parseInt(status)
    };
    
    apiRequest(`/api/financial-aids/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(financialAidData)
    })
    .then(resp => resp.json())
    .then(data => {
        showToast('助学金记录更新成功');
        document.querySelector('.modal-overlay')?.remove();
        loadFinancialAidInfo();
    })
    .catch(err => {
        console.error(err);
        showToast('更新助学金记录失败');
    });
}

function deleteFinancialAid(id) {
    if (!confirm('确定要删除这条助学金记录吗？')) return;
    
    apiRequest(`/api/financial-aids/${id}`, {
        method: 'DELETE'
    })
    .then(resp => resp.text())
    .then(msg => {
        showToast('助学金记录删除成功');
        loadFinancialAidInfo();
    })
    .catch(err => {
        console.error(err);
        showToast('删除助学金记录失败');
    });
}

function goBack() {
    window.location.href = 'finance-index.html';
}

function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2500);
}
</script>
<div id="toast" class="toast"></div>
</body>
</html>
