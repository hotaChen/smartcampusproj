<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>缴费记录查询</title>
    <script src="../js/api.js"></script>
    <script src="/js/sidebar.js"></script>
</head>
<body>
    <h1>缴费记录查询</h1>
    
    <div>
        <h2>我的缴费记录</h2>
        <div id="payment-list">
            <p>正在加载缴费记录...</p>
        </div>
    </div>
    
    <div>
        <br>
        <button onclick="goBack()">返回财务管理</button>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    SidebarManager.init({ 
        currentPage: 'payment-view',
        onReady: function(user) {
            loadPaymentRecords(user);
        }
    });
});

function loadPaymentRecords(user) {
    let url;
    if (user.userType === 'STUDENT') {
        url = `/api/payment-records/student/${user.id}`;
    } else if (user.userType === 'TEACHER' || user.userType === 'ADMIN') {
        url = '/api/payment-records';
    }
    
    const tuitionId = localStorage.getItem('tuitionId');
    if (tuitionId) {
        url += `?tuitionId=${tuitionId}`;
        localStorage.removeItem('tuitionId');
    }
    
    apiRequest(url)
        .then(resp => resp.json())
        .then(data => {
            let html = '<table border="1" cellpadding="5" cellspacing="0">';
            html += '<tr><th>学生姓名</th><th>学号</th><th>缴费金额</th><th>缴费日期</th><th>缴费方式</th><th>交易号</th><th>缴费状态</th>';
            
            if (user.userType === 'ADMIN' || user.userType === 'TEACHER') {
                html += '<th>操作</th>';
            }
            
            html += '</tr>';
            
            if (data && data.length > 0) {
                data.forEach(payment => {
                    html += `<tr>
                        <td>${payment.studentName || '-'}</td>
                        <td>${payment.studentNumber || '-'}</td>
                        <td>${payment.amount || '-'}</td>
                        <td>${payment.paymentDate || '-'}</td>
                        <td>${payment.paymentMethod || '-'}</td>
                        <td>${payment.transactionId || '-'}</td>
                        <td>${payment.status || '-'}</td>`;
                    
                    if (user.userType === 'ADMIN' || user.userType === 'TEACHER') {
                        html += `<td>
                            <button onclick="editPayment(${payment.id})">编辑</button>
                            <button onclick="deletePayment(${payment.id})">删除</button>
                        </td>`;
                    }
                    
                    html += '</tr>';
                });
            } else {
                const colspan = user.userType === 'ADMIN' || user.userType === 'TEACHER' ? 8 : 7;
                html += `<tr><td colspan="${colspan}">暂无缴费记录</td></tr>`;
            }
            
            html += '</table>';
            document.getElementById('payment-list').innerHTML = html;
        })
        .catch(err => {
            console.error(err);
            document.getElementById('payment-list').innerHTML = '<p style="color:red;">加载缴费记录失败</p>';
        });
}

function editPayment(id) {
    alert('编辑功能待实现');
}

function deletePayment(id) {
    if (confirm('确定要删除这条缴费记录吗？')) {
        apiRequest(`/api/payment-records/${id}`, {
            method: 'DELETE'
        })
        .then(resp => resp.text())
        .then(msg => {
            alert('缴费记录删除成功');
            loadPaymentRecords();
        })
        .catch(err => {
            console.error(err);
            alert('删除缴费记录失败');
        });
    }
}

function goBack() {
    window.location.href = 'finance-index.html';
}
</script>
</body>
</html>