<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>缴费记录管理</title>
    <script src="../js/api.js"></script>
    <script src="/js/sidebar.js"></script>
</head>
<body>
    <h1>缴费记录管理</h1>
    
    <div>
        <h2>添加缴费记录</h2>
        <div>
            <label>学生ID:</label>
            <input type="number" id="studentId" placeholder="请输入学生ID">
            <br>
            <label>缴费金额:</label>
            <input type="number" id="amount" placeholder="请输入缴费金额" step="0.01">
            <br>
            <label>缴费日期:</label>
            <input type="date" id="paymentDate">
            <br>
            <label>缴费方式:</label>
            <select id="paymentMethod">
                <option value="现金">现金</option>
                <option value="银行转账">银行转账</option>
                <option value="在线支付">在线支付</option>
                <option value="刷卡">刷卡</option>
            </select>
            <br>
            <label>交易号:</label>
            <input type="text" id="transactionId" placeholder="请输入交易号（可选）">
            <br>
            <label>缴费状态:</label>
            <select id="status">
                <option value="已支付">已支付</option>
                <option value="待确认">待确认</option>
                <option value="已退款">已退款</option>
            </select>
            <br>
            <button onclick="addPayment()">添加缴费记录</button>
        </div>
    </div>
    
    <div>
        <h2>缴费记录列表</h2>
        <div id="payment-list">
            <p>正在加载缴费记录...</p>
        </div>
    </div>
    
    <div>
        <br>
        <button onclick="goBack()">返回财务管理</button>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    SidebarManager.init({ 
        currentPage: 'payment-manage',
        onReady: function(user) {
            if (user.userType !== 'ADMIN' && user.userType !== 'TEACHER') {
                document.querySelector('h1').innerHTML = '您没有权限访问此页面';
                document.querySelector('h1').style.color = 'red';
                return;
            }
            loadPaymentRecords();
        }
    });
});

function loadPaymentRecords() {
    apiRequest('/api/payment-records')
        .then(resp => resp.json())
        .then(data => {
            let html = '<table border="1" cellpadding="5" cellspacing="0">';
            html += '<tr><th>学生姓名</th><th>学号</th><th>缴费金额</th><th>缴费日期</th><th>缴费方式</th><th>交易号</th><th>缴费状态</th><th>操作</th></tr>';
            
            if (data && data.length > 0) {
                data.forEach(payment => {
                    html += `<tr>
                        <td>${payment.studentName || '-'}</td>
                        <td>${payment.studentNumber || '-'}</td>
                        <td>${payment.amount || '-'}</td>
                        <td>${payment.paymentDate || '-'}</td>
                        <td>${payment.paymentMethod || '-'}</td>
                        <td>${payment.transactionId || '-'}</td>
                        <td>${payment.status || '-'}</td>
                        <td>
                            <button onclick="editPayment(${payment.id})">编辑</button>
                            <button onclick="deletePayment(${payment.id})">删除</button>
                        </td>
                    </tr>`;
                });
            } else {
                html += '<tr><td colspan="8">暂无缴费记录</td></tr>';
            }
            
            html += '</table>';
            document.getElementById('payment-list').innerHTML = html;
        })
        .catch(err => {
            console.error(err);
            document.getElementById('payment-list').innerHTML = '<p style="color:red;">加载缴费记录失败</p>';
        });
}

function addPayment() {
    const studentId = document.getElementById('studentId').value;
    const amount = document.getElementById('amount').value;
    const paymentDate = document.getElementById('paymentDate').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const transactionId = document.getElementById('transactionId').value;
    const status = document.getElementById('status').value;
    
    if (!studentId || !amount || !paymentDate) {
        alert('请填写完整信息');
        return;
    }
    
    const paymentData = {
        studentId: parseInt(studentId),
        amount: parseFloat(amount),
        paymentDate: paymentDate,
        paymentMethod: paymentMethod,
        transactionId: transactionId,
        status: status
    };
    
    apiRequest('/api/payment-records', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(paymentData)
    })
    .then(resp => resp.json())
    .then(data => {
        alert('缴费记录添加成功');
        document.getElementById('studentId').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('paymentDate').value = '';
        document.getElementById('transactionId').value = '';
        document.getElementById('status').value = '已支付';
        loadPaymentRecords();
    })
    .catch(err => {
        console.error(err);
        alert('添加缴费记录失败');
    });
}

function editPayment(id) {
    alert('编辑功能待实现');
}

function deletePayment(id) {
    if (confirm('确定要删除这条缴费记录吗？')) {
        apiRequest(`/api/payment-records/${id}`, {
            method: 'DELETE'
        })
        .then(resp => resp.text())
        .then(msg => {
            alert('缴费记录删除成功');
            loadPaymentRecords();
        })
        .catch(err => {
            console.error(err);
            alert('删除缴费记录失败');
        });
    }
}

function goBack() {
    window.location.href = 'finance-index.html';
}
</script>
</body>
</html>