<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>奖学金查询 - Egg University</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">奖学金查询</h1>
    
    <div class="toolbar">
        <button class="btn secondary" onclick="goBack()">返回财务管理</button>
    </div>

    <div class="info-card">
        <div class="info-card-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="8" r="7"/>
                <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
            </svg>
            <span>我的奖学金信息</span>
        </div>
        <div class="info-card-body">
            <div id="scholarship-list">
                <div class="empty-state">正在加载奖学金信息...</div>
            </div>
        </div>
    </div>
</div>

<style>
.info-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    overflow: hidden;
    margin-top: 20px;
}

.info-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 20px 24px;
    background: linear-gradient(135deg, rgba(167, 243, 208, 0.15), rgba(16, 185, 129, 0.1));
    border-bottom: 1px solid rgba(167, 243, 208, 0.2);
    font-size: 18px;
    font-weight: 600;
    color: #a7f3d0;
}

.info-card-header svg {
    width: 24px;
    height: 24px;
    stroke: #10b981;
    stroke-width: 2;
    fill: none;
}

.info-card-body {
    padding: 24px;
}

.data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.data-table th {
    background: rgba(167, 243, 208, 0.1);
    color: #a7f3d0;
    padding: 14px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    border-bottom: 1px solid rgba(167, 243, 208, 0.2);
}

.data-table th:first-child {
    border-radius: 12px 0 0 0;
}

.data-table th:last-child {
    border-radius: 0 12px 0 0;
}

.data-table td {
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    color: var(--text);
    font-size: 14px;
}

.data-table tr:last-child td {
    border-bottom: none;
}

.data-table tr:hover td {
    background: rgba(255, 255, 255, 0.05);
}

.data-table .empty-state {
    text-align: center;
    padding: 40px;
    color: rgba(255, 255, 255, 0.5);
}

.action-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s ease;
    margin-right: 8px;
    white-space: nowrap;
}

.action-btn:hover {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.3));
}

.action-btn.view {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.2));
    color: #c4b5fd;
    border: 1px solid rgba(139, 92, 246, 0.3);
}

.action-btn.view:hover {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(124, 58, 237, 0.3));
    transform: translateY(-1px);
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
}

.status-success {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
    color: #6ee7b7;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.status-error {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
    color: #fca5a5;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.status-pending {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2));
    color: #fcd34d;
    border: 1px solid rgba(245, 158, 11, 0.3);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    SidebarManager.init({ 
        currentPage: 'scholarship-view',
        onReady: function(user) {
            loadScholarshipInfo(user);
        }
    });
    HeaderComponent.init();
});

function loadScholarshipInfo(user) {
    let url;
    if (user.userType === 'STUDENT') {
        url = `/api/scholarships/student/${user.id}`;
    } else if (user.userType === 'TEACHER' || user.userType === 'ADMIN') {
        url = '/api/scholarships';
    }
    
    apiRequest(url)
        .then(resp => resp.json())
        .then(data => {
            let html = '<table class="data-table"><thead><tr>';
            html += '<th>奖学金名称</th><th>学生姓名</th><th>学号</th><th>金额</th><th>奖学金类型</th><th>学期</th><th>状态</th><th>获奖日期</th>';
            
            if (user.userType === 'ADMIN' || user.userType === 'TEACHER') {
                html += '<th>操作</th>';
            }
            
            html += '</tr></thead><tbody>';
            
            if (data && data.length > 0) {
                data.forEach(scholarship => {
                    const statusClass = scholarship.statusDescription === '已批准' ? 'success' : scholarship.statusDescription === '已拒绝' ? 'error' : 'pending';
                    const awardDate = scholarship.awardDate ? new Date(scholarship.awardDate).toLocaleDateString('zh-CN') : '-';
                    
                    html += `<tr>
                        <td>${scholarship.name || '-'}</td>
                        <td>${scholarship.studentName || '-'}</td>
                        <td>${scholarship.studentNumber || '-'}</td>
                        <td>${scholarship.amount ? '¥' + scholarship.amount : '-'}</td>
                        <td>${scholarship.type || '-'}</td>
                        <td>${scholarship.semester || '-'}</td>
                        <td><span class="status-badge status-${statusClass}">${scholarship.statusDescription || '-'}</span></td>
                        <td>${awardDate}</td>`;
                    
                    if (user.userType === 'ADMIN' || user.userType === 'TEACHER') {
                        if (scholarship.statusDescription === '待审批') {
                            html += `<td>
                                <button class="action-btn" onclick="approveScholarship(${scholarship.id})">审批</button>
                            </td>`;
                        } else {
                            html += `<td>
                                <button class="action-btn view" onclick="viewScholarship(${scholarship.id})">查看</button>
                            </td>`;
                        }
                    }
                    
                    html += '</tr>';
                });
            } else {
                const colspan = user.userType === 'ADMIN' || user.userType === 'TEACHER' ? 9 : 8;
                html += `<tr><td colspan="${colspan}" class="empty-state">暂无奖学金记录</td></tr>`;
            }
            
            html += '</tbody></table>';
            document.getElementById('scholarship-list').innerHTML = html;
        })
        .catch(err => {
            console.error(err);
            document.getElementById('scholarship-list').innerHTML = '<div class="empty-state" style="color: #f87171;">加载奖学金信息失败</div>';
        });
}

function approveScholarship(id) {
    const reason = prompt('请输入审批意见（可选）:');
    const approvalData = {
        status: '已批准',
        approvalRemark: reason || '审批通过'
    };
    
    apiRequest(`/api/scholarships/${id}/approve`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(approvalData)
    })
    .then(resp => resp.json())
    .then(data => {
        showToast('奖学金审批成功');
        SidebarManager.getUser().then(user => loadScholarshipInfo(user));
    })
    .catch(err => {
        console.error(err);
        showToast('奖学金审批失败');
    });
}

function viewScholarship(id) {
    apiRequest(`/api/scholarships/${id}`)
        .then(resp => resp.json())
        .then(scholarship => {
            const details = `
                <div style="padding: 20px; color: var(--text);">
                    <p><strong>奖学金名称：</strong>${scholarship.name || '-'}</p>
                    <p><strong>学生姓名：</strong>${scholarship.studentName || '-'}</p>
                    <p><strong>学号：</strong>${scholarship.studentNumber || '-'}</p>
                    <p><strong>金额：</strong>${scholarship.amount ? '¥' + scholarship.amount : '-'}</p>
                    <p><strong>奖学金类型：</strong>${scholarship.type || '-'}</p>
                    <p><strong>学期：</strong>${scholarship.semester || '-'}</p>
                    <p><strong>状态：</strong>${scholarship.statusDescription || '-'}</p>
                    <p><strong>获奖日期：</strong>${scholarship.awardDate ? new Date(scholarship.awardDate).toLocaleDateString('zh-CN') : '-'}</p>
                    <p><strong>申请原因：</strong>${scholarship.reason || '-'}</p>
                    <p><strong>描述：</strong>${scholarship.description || '-'}</p>
                </div>
            `;
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000;';
            modal.innerHTML = `
                <div style="background:rgba(30,41,59,0.95);border-radius:16px;padding:0;max-width:500px;width:90%;border:1px solid rgba(255,255,255,0.1);box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);">
                    <div style="padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;color:#f1f5f9;font-size:18px;font-weight:600;">奖学金详情</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background:none;border:none;color:#94a3b8;cursor:pointer;font-size:24px;line-height:1;">&times;</button>
                    </div>
                    ${details}
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        })
        .catch(err => {
            console.error(err);
            showToast('获取奖学金详情失败');
        });
}

function goBack() {
    window.location.href = 'finance-index.html';
}

function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2500);
}
</script>
</body>
</html>
