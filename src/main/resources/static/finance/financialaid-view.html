<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>助学金查询</title>
    <script src="/js/sidebar.js"></script>
</head>
<body>
    <h1>助学金查询</h1>
    
    <div>
        <h2>我的助学金信息</h2>
        <div id="financialaid-list">
            <p>正在加载助学金信息...</p>
        </div>
    </div>
    
    <div>
        <br>
        <button onclick="goBack()">返回财务管理</button>
    </div>
    
    <script src="/js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            SidebarManager.init({ 
                currentPage: 'financialaid-view',
                onReady: function(user) {
                    loadFinancialAidInfo(user);
                }
            });
        });

        function loadFinancialAidInfo(user) {
            let url;
            if (user.userType === 'STUDENT') {
                url = `/api/financial-aid/student/${user.id}`;
            } else if (user.userType === 'TEACHER' || user.userType === 'ADMIN') {
                url = '/api/financial-aid';
            }
            
            apiRequest(url)
                .then(resp => resp.json())
                .then(data => {
                    let html = '<table border="1" cellpadding="5" cellspacing="0">';
                    html += '<tr><th>助学金类型</th><th>学生姓名</th><th>学号</th><th>金额</th><th>申请状态</th><th>申请日期</th><th>审批日期</th>';
                    
                    if (user.userType === 'ADMIN' || user.userType === 'TEACHER') {
                        html += '<th>操作</th>';
                    }
                    
                    html += '</tr>';
                    
                    if (data && data.length > 0) {
                        data.forEach(financialAid => {
                            html += `<tr>
                                <td>${financialAid.type || '-'}</td>
                                <td>${financialAid.studentName || '-'}</td>
                                <td>${financialAid.studentNumber || '-'}</td>
                                <td>${financialAid.amount || '-'}</td>
                                <td>${financialAid.status || '-'}</td>
                                <td>${financialAid.applicationDate || '-'}</td>
                                <td>${financialAid.approvalDate || '-'}</td>`;
                            
                            if (user.userType === 'ADMIN' || user.userType === 'TEACHER') {
                                if (financialAid.status === '待审批') {
                                    html += `<td>
                                        <button onclick="approveFinancialAid(${financialAid.id})">审批</button>
                                        <button onclick="rejectFinancialAid(${financialAid.id})">拒绝</button>
                                    </td>`;
                                } else {
                                    html += '<td>-</td>';
                                }
                            }
                            
                            html += '</tr>';
                        });
                    } else {
                        const colspan = user.userType === 'ADMIN' || user.userType === 'TEACHER' ? 8 : 7;
                        html += `<tr><td colspan="${colspan}">暂无助学金记录</td></tr>`;
                    }
                    
                    html += '</table>';
                    document.getElementById('financialaid-list').innerHTML = html;
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('financialaid-list').innerHTML = '<p style="color:red;">加载助学金信息失败</p>';
                });
        }

        function approveFinancialAid(id) {
            const reason = prompt('请输入审批意见（可选）:');
            const approvalData = {
                status: '已批准',
                approvalRemark: reason || '审批通过'
            };
            
            apiRequest(`/api/financial-aid/${id}/approve`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(approvalData)
            })
            .then(resp => resp.json())
            .then(data => {
                alert('助学金审批成功');
                SidebarManager.getUser().then(user => loadFinancialAidInfo(user));
            })
            .catch(err => {
                console.error(err);
                alert('助学金审批失败');
            });
        }

        function rejectFinancialAid(id) {
            const reason = prompt('请输入拒绝理由:');
            if (!reason) {
                alert('拒绝理由不能为空');
                return;
            }
            
            const approvalData = {
                status: '已拒绝',
                approvalRemark: reason
            };
            
            apiRequest(`/api/financial-aid/${id}/approve`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(approvalData)
            })
            .then(resp => resp.json())
            .then(data => {
                alert('助学金已拒绝');
                SidebarManager.getUser().then(user => loadFinancialAidInfo(user));
            })
            .catch(err => {
                console.error(err);
                alert('操作失败');
            });
        }

        function goBack() {
            window.location.href = 'finance-index.html';
        }
    </script>
</body>
</html>
