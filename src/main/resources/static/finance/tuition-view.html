<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>学费查询</title>
    <script src="../js/api.js"></script>
    <script src="/js/sidebar.js"></script>
</head>
<body>
    <h1>学费查询</h1>
    
    <div>
        <h2>我的学费信息</h2>
        <div id="tuition-list">
            <p>正在加载学费信息...</p>
        </div>
    </div>
    
    <div>
        <br>
        <button onclick="goBack()">返回财务管理</button>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    SidebarManager.init({ 
        currentPage: 'tuition-view',
        onReady: function(user) {
            loadTuitionInfo(user);
        }
    });
});

function loadTuitionInfo(user) {
    let url;
    if (user.userType === 'STUDENT') {
        url = `/api/tuition/student/${user.id}`;
    } else if (user.userType === 'TEACHER' || user.userType === 'ADMIN') {
        url = '/api/tuition';
    }
    
    apiRequest(url)
        .then(resp => resp.json())
        .then(data => {
            let html = '<table border="1" cellpadding="5" cellspacing="0">';
            html += '<tr><th>学生姓名</th><th>学号</th><th>学期</th><th>学费金额</th><th>缴费状态</th><th>缴费截止日期</th>';
            
            if (user.userType === 'ADMIN' || user.userType === 'TEACHER') {
                html += '<th>操作</th>';
            }
            
            html += '</tr>';
            
            if (data && data.length > 0) {
                data.forEach(tuition => {
                    html += `<tr>
                        <td>${tuition.studentName || '-'}</td>
                        <td>${tuition.studentNumber || '-'}</td>
                        <td>${tuition.semester || '-'}</td>
                        <td>${tuition.amount || '-'}</td>
                        <td>${tuition.paymentStatus || '-'}</td>
                        <td>${tuition.dueDate || '-'}</td>`;
                    
                    if (user.userType === 'ADMIN' || user.userType === 'TEACHER') {
                        html += `<td>
                            <button onclick="viewPaymentRecords(${tuition.id})">查看缴费记录</button>
                        </td>`;
                    }
                    
                    html += '</tr>';
                });
            } else {
                html += '<tr><td colspan="7">暂无学费记录</td></tr>';
            }
            
            html += '</table>';
            document.getElementById('tuition-list').innerHTML = html;
        })
        .catch(err => {
            console.error(err);
            document.getElementById('tuition-list').innerHTML = '<p style="color:red;">加载学费信息失败</p>';
        });
}

function viewPaymentRecords(tuitionId) {
    localStorage.setItem('tuitionId', tuitionId);
    window.location.href = 'payment-view.html';
}

function goBack() {
    window.location.href = 'finance-index.html';
}
</script>
</body>
</html>