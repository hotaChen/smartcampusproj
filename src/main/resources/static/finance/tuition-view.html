<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>学费查询</title>
</head>
<body>
    <h1>学费查询</h1>
    <div id="user-info"></div>
    
    <div>
        <h2>我的学费信息</h2>
        <div id="tuition-list">
            <p>正在加载学费信息...</p>
        </div>
    </div>
    
    <div>
        <br>
        <button onclick="goBack()">返回财务管理</button>
    </div>
    
    <script src="/js/api.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let currentUser = null;

        if (!token) {
            document.getElementById('user-info').innerHTML = '<p style="color:red;">未检测到登录信息，请重新登录</p>';
        } else {
            apiRequest(API_ENDPOINTS.USER_INFO + `?token=${token}`)
                .then(resp => resp.json())
                .then(user => {
                    currentUser = user;
                    document.getElementById('user-info').innerHTML = `<p>当前用户: ${user.realName} (${user.userType})</p>`;
                    
                    // 加载学费信息
                    loadTuitionInfo();
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('user-info').innerHTML = `<p style="color:red;">获取用户信息失败</p>`;
                });
        }

        function loadTuitionInfo() {
            // 根据用户类型加载不同的学费信息
            let url;
            if (currentUser.userType === 'STUDENT') {
                // 学生只能查看自己的学费
                url = `/api/tuition/student/${currentUser.id}`;
            } else if (currentUser.userType === 'TEACHER' || currentUser.userType === 'ADMIN') {
                // 教师和管理员可以查看所有学费
                url = '/api/tuition';
            }
            
            apiRequest(url)
                .then(resp => resp.json())
                .then(data => {
                    let html = '<table border="1" cellpadding="5" cellspacing="0">';
                    html += '<tr><th>学生姓名</th><th>学号</th><th>学期</th><th>学费金额</th><th>缴费状态</th><th>缴费截止日期</th>';
                    
                    if (currentUser.userType === 'ADMIN' || currentUser.userType === 'TEACHER') {
                        html += '<th>操作</th>';
                    }
                    
                    html += '</tr>';
                    
                    if (data && data.length > 0) {
                        data.forEach(tuition => {
                            html += `<tr>
                                <td>${tuition.studentName || '-'}</td>
                                <td>${tuition.studentNumber || '-'}</td>
                                <td>${tuition.semester || '-'}</td>
                                <td>${tuition.amount || '-'}</td>
                                <td>${tuition.paymentStatus || '-'}</td>
                                <td>${tuition.dueDate || '-'}</td>`;
                            
                            if (currentUser.userType === 'ADMIN' || currentUser.userType === 'TEACHER') {
                                html += `<td>
                                    <button onclick="viewPaymentRecords(${tuition.id})">查看缴费记录</button>
                                </td>`;
                            }
                            
                            html += '</tr>';
                        });
                    } else {
                        html += '<tr><td colspan="7">暂无学费记录</td></tr>';
                    }
                    
                    html += '</table>';
                    document.getElementById('tuition-list').innerHTML = html;
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('tuition-list').innerHTML = '<p style="color:red;">加载学费信息失败</p>';
                });
        }

        function viewPaymentRecords(tuitionId) {
            // 这里可以跳转到缴费记录页面，并传递学费ID作为参数
            localStorage.setItem('tuitionId', tuitionId);
            window.location.href = 'payment-view.html';
        }

        function goBack() {
            window.location.href = 'finance-index.html';
        }
    </script>
</body>
</html>