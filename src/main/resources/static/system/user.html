<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>用户管理</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
    <style>
        .tab-area {
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            background-color: rgba(255,255,255,0.1);
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            color: inherit;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }

        .tab-btn.active {
            background-color: #f59e0b;
            color: #fff;
        }

        .info-area {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            background-color: rgba(255,255,255,0.03);
            color: rgba(255,255,255,0.6);
        }

        .debug-item {
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
        }

        .debug-item:last-child {
            border-bottom: none;
        }

        .debug-title {
            font-weight: bold;
            color: rgba(255,255,255,0.9);
            margin-bottom: 5px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">用户管理</h1>
    
    <div class="toolbar">
        <button class="btn secondary" onclick="goBack()">返回首页</button>
    </div>

    <div class="tab-area">
        <button class="tab-btn active" onclick="switchTab('user-list-tab')">用户列表查询</button>
        <button class="tab-btn" onclick="switchTab('user-detail-tab')">用户详情查询</button>
        <button class="tab-btn" onclick="switchTab('debug-info-tab')">调试信息</button>
        <button class="tab-btn" onclick="switchTab('health-check-tab')">健康检查</button>
    </div>

    <div class="content-section">
        <div class="form-row" style="margin-bottom: 15px;">
            <label for="query-user-type">用户类型</label>
            <select id="query-user-type">
                <option value="">全部类型</option>
                <option value="STUDENT">学生</option>
                <option value="TEACHER">教师</option>
                <option value="ADMIN">管理员</option>
            </select>
        </div>
        <div class="form-actions" style="margin-bottom: 20px;">
            <button class="btn primary" onclick="getAllUsers()">获取所有用户</button>
            <button class="btn primary" onclick="getUsersByType()">按用户类型查询</button>
        </div>
    </div>

    <div id="user-list-tab" class="tab-content">
        <table class="data-table">
            <thead>
                <tr>
                    <th>用户ID</th>
                    <th>用户名</th>
                    <th>真实姓名</th>
                    <th>用户类型</th>
                    <th>角色</th>
                    <th>密码</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="user-tbody">
                <tr><td colspan="7" class="empty-state">正在加载用户信息...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="user-detail-tab" class="tab-content hidden">
        <div class="form-row">
            <label for="detail-user-id">用户ID</label>
            <input type="number" id="detail-user-id" placeholder="请输入用户ID" min="1">
        </div>
        <div class="form-actions" style="margin-bottom: 20px;">
            <button class="btn primary" onclick="getUserById()">按ID查询用户</button>
        </div>
        
        <div class="form-row">
            <label for="detail-username-input">用户名</label>
            <input type="text" id="detail-username-input" placeholder="请输入用户名">
        </div>
        <div class="form-actions" style="margin-bottom: 20px;">
            <button class="btn primary" onclick="getUserByUsername()">按用户名查询用户</button>
        </div>

        <div class="info-area" id="user-detail-content" style="display: none;">
            <div class="debug-item">
                <div class="debug-title">用户基本信息</div>
                <div>用户ID：<span id="detail-id-show"></span></div>
                <div>用户名：<span id="detail-username-show"></span></div>
                <div>真实姓名：<span id="detail-realname-show"></span></div>
                <div>用户类型：<span id="detail-usertype-show"></span></div>
                <div>角色：<span id="detail-role-show"></span></div>
                <div>密码：<span id="detail-password-show"></span></div>
            </div>
        </div>
    </div>

    <div id="debug-info-tab" class="tab-content hidden">
        <button class="btn primary" style="margin-bottom: 20px;" onclick="getDebugInfo()">获取调试信息</button>
        <div class="info-area" id="debug-info-content">
            点击上方按钮获取用户调试信息...
        </div>
    </div>

    <div id="health-check-tab" class="tab-content hidden">
        <button class="btn primary" style="margin-bottom: 20px;" onclick="healthCheck()">执行健康检查</button>
        <div class="info-area" id="health-check-content">
            点击上方按钮执行健康检查...
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    let currentUser = null;

    function goBack() { window.location.href = '../index.html'; }

    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(item => {
            item.classList.add('hidden');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(tabId).classList.remove('hidden');
        event.target.classList.add('active');
    }

    function getRequestHeaders() {
        const token = localStorage.getItem("token");
        return {
            "Content-Type": "application/json",
            "Authorization": token ? `Bearer ${token}` : ""
        };
    }

    document.addEventListener('DOMContentLoaded', function() {
        SidebarManager.init({ currentPage: 'user' });
        HeaderComponent.init();
    });

    if (!token) {
        document.getElementById('user-tbody').innerHTML = '<tr><td colspan="7" class="empty-state">未检测到登录信息，请重新登录</td></tr>';
    } else {
        apiRequest(API_ENDPOINTS.USER_INFO + `?token=${token}`)
            .then(resp => resp.json())
            .then(user => {
                currentUser = user;
                getAllUsers();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('user-tbody').innerHTML = '<tr><td colspan="7" class="empty-state">获取用户信息失败</td></tr>';
            });
    }

    function getAllUsers() {
        fetch('/api/users', {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 500) {
                        throw new Error("获取所有用户失败：服务器内部错误");
                    }
                    throw new Error(`获取所有用户失败：${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                renderUserTable(data);
            })
            .catch(err => {
                alert(err.message);
                document.getElementById("user-tbody").innerHTML = `<tr><td colspan="7" style="text-align: center; color: #999;">获取用户失败：${err.message}</td></tr>`;
            });
    }

    function getUsersByType() {
        const userType = document.getElementById("query-user-type").value;
        if (!userType) {
            alert("请选择用户类型！");
            return;
        }

        fetch(`/api/users/type/${userType}`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 500) {
                        throw new Error("按类型查询用户失败：服务器内部错误");
                    }
                    throw new Error(`按类型查询用户失败：${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                renderUserTable(data);
            })
            .catch(err => {
                alert(err.message);
                document.getElementById("user-tbody").innerHTML = `<tr><td colspan="7" style="text-align: center; color: #999;">获取用户失败：${err.message}</td></tr>`;
            });
    }

    function renderUserTable(userList) {
        const tbody = document.getElementById("user-tbody");
        tbody.innerHTML = "";

        if (!userList || userList.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="7" class="empty-state">暂无用户数据</td>`;
            tbody.appendChild(tr);
            return;
        }

        userList.forEach(user => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${user.id || ""}</td>
                <td>${user.username || ""}</td>
                <td>${user.realName || ""}</td>
                <td>${user.userType || ""}</td>
                <td>${user.role ? user.role.name || "无角色" : "无角色"}</td>
                <td>${user.password || "[PROTECTED]"}</td>
                <td>
                    <button class="action-btn edit" onclick="fillUserId(${user.id})">查看详情</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function fillUserId(userId) {
        document.getElementById("detail-user-id").value = userId;
        switchTab("user-detail-tab");
        getUserById();
    }

    function getUserById() {
        const userId = document.getElementById("detail-user-id").value;
        if (!userId) {
            alert("请输入用户ID！");
            return;
        }

        fetch(`/api/users/${userId}`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`未找到ID为${userId}的用户`);
                    }
                    throw new Error(`按ID查询用户失败：${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                showUserDetail(data);
            })
            .catch(err => {
                alert(err.message);
                document.getElementById("user-detail-content").style.display = "none";
            });
    }

    function getUserByUsername() {
        const username = document.getElementById("detail-username-input").value.trim();
        if (!username) {
            alert("请输入用户名！");
            return;
        }

        fetch(`/api/users/username/${username}`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`未找到用户名为${username}的用户`);
                    }
                    throw new Error(`按用户名查询用户失败：${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                showUserDetail(data);
            })
            .catch(err => {
                alert(err.message);
                document.getElementById("user-detail-content").style.display = "none";
            });
    }

    function showUserDetail(user) {
        const detailContent = document.getElementById("user-detail-content");
        detailContent.style.display = "block";

        document.getElementById("detail-id-show").innerText = user.id || "";
        document.getElementById("detail-username-show").innerText = user.username || "";
        document.getElementById("detail-realname-show").innerText = user.realName || "";
        document.getElementById("detail-usertype-show").innerText = user.userType || "";
        document.getElementById("detail-role-show").innerText = user.role ? user.role.name || "无角色" : "无角色";
        document.getElementById("detail-password-show").innerText = user.password || "[PROTECTED]";
    }

    function getDebugInfo() {
        fetch('/api/users/debug/info', {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`获取调试信息失败：${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                renderDebugInfo(data);
            })
            .catch(err => {
                alert(err.message);
                document.getElementById("debug-info-content").innerHTML = `<p style="color: red;">获取调试信息失败：${err.message}</p>`;
            });
    }

    function renderDebugInfo(debugData) {
        const debugContainer = document.getElementById("debug-info-content");
        let debugHtml = `
            <div class="debug-item">
                <div class="debug-title">基础信息</div>
                <div>提示信息：${debugData.message || ""}</div>
                <div>用户总数：${debugData.totalUsers || 0}</div>
                <div>查询时间：${debugData.timestamp || ""}</div>
            </div>
            <div class="debug-item">
                <div class="debug-title">用户列表</div>
        `;

        if (debugData.users && debugData.users.length > 0) {
            debugData.users.forEach((user, index) => {
                debugHtml += `<div style="margin-left: 20px; margin-top: 5px;">用户${index+1}：ID=${user.id || ""}，用户名=${user.username || ""}，真实姓名=${user.realName || ""}，类型=${user.userType || ""}，角色=${user.role || "无角色"}</div>`;
            });
        } else {
            debugHtml += `<div style="margin-left: 20px;">暂无用户数据</div>`;
        }

        debugHtml += `</div>`;
        debugContainer.innerHTML = debugHtml;
    }

    function healthCheck() {
        fetch('/api/users/health', {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                return response.json().then(data => {
                    return { isOk: response.ok, data: data };
                });
            })
            .then(result => {
                renderHealthCheck(result.data, result.isOk);
            })
            .catch(err => {
                alert("健康检查请求异常：" + err.message);
                document.getElementById("health-check-content").innerHTML = `<p style="color: red;">健康检查失败：${err.message}</p>`;
            });
    }

    function renderHealthCheck(healthData, isOk) {
        const healthContainer = document.getElementById("health-check-content");
        let healthHtml = `
            <div class="debug-item">
                <div class="debug-title" style="color: ${isOk ? "#4CAF50" : "#f56c6c"}">健康状态：${healthData.status || (isOk ? "UP" : "DOWN")}</div>
                <div>服务名称：${healthData.service || "UserController"}</div>
                <div>用户总数：${healthData.userCount || 0}</div>
                <div>检查时间：${healthData.timestamp || ""}</div>
                <div>提示信息：${healthData.message || ""}</div>
        `;

        if (!isOk) {
            healthHtml += `<div style="color: #f56c6c; margin-top: 5px;">错误信息：${healthData.error || ""}</div>`;
        }

        healthHtml += `</div>`;
        healthContainer.innerHTML = healthHtml;
    }
</script>
</body>
</html>