<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Smart Campus 用户管理</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        /* 用户管理页面特定样式 */
        .tab-area {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            background-color: #e9e9e9;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        .tab-btn.active {
            background-color: #409eff;
            color: #fff;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .form-group label {
            width: 120px;
            text-align: right;
            padding-right: 10px;
            color: #666;
        }

        .form-group input,
        .form-group select {
            flex: 1;
            max-width: 300px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #409eff;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: #fff;
            background-color: #409eff;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-default {
            background-color: #e9e9e9;
            color: #333;
        }

        .table-area {
            margin-top: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            border: 1px solid #eee;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f8f8f8;
            color: #333;
        }

        .info-area {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f8f8f8;
            color: #666;
        }

        .debug-item {
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
        }

        .debug-item:last-child {
            border-bottom: none;
        }

        .debug-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>Smart Campus 用户管理</h2>

    <!-- 标签切换区域 -->
    <div class="tab-area">
        <button class="tab-btn active" onclick="switchTab('user-list-tab')">用户列表查询</button>
        <button class="tab-btn" onclick="switchTab('user-detail-tab')">用户详情查询</button>
        <button class="tab-btn" onclick="switchTab('debug-info-tab')">调试信息</button>
        <button class="tab-btn" onclick="switchTab('health-check-tab')">健康检查</button>
    </div>

    <!-- 1. 用户列表查询标签页 -->
    <div id="user-list-tab" class="tab-content">
        <h3>用户列表与类型查询</h3>
        <div class="form-group">
            <label for="query-user-type">用户类型</label>
            <select id="query-user-type">
                <option value="">全部类型</option>
                <option value="STUDENT">学生</option>
                <option value="TEACHER">教师</option>
                <option value="ADMIN">管理员</option>
            </select>
        </div>
        <button class="btn" onclick="getAllUsers()">获取所有用户</button>
        <button class="btn" onclick="getUsersByType()">按用户类型查询</button>

        <!-- 用户列表表格 -->
        <div class="table-area">
            <table id="user-table">
                <thead>
                <tr>
                    <th>用户ID</th>
                    <th>用户名</th>
                    <th>真实姓名</th>
                    <th>用户类型</th>
                    <th>角色</th>
                    <th>密码</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="user-tbody">
                <!-- 数据将通过JS动态填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 2. 用户详情查询标签页 -->
    <div id="user-detail-tab" class="tab-content hidden">
        <h3>用户详情精准查询</h3>
        <div class="form-group">
            <label for="detail-user-id">用户ID</label>
            <input type="number" id="detail-user-id" placeholder="请输入用户ID" min="1">
        </div>
        <button class="btn" onclick="getUserById()">按ID查询用户</button>

        <div class="form-group" style="margin-top: 20px;">
            <label for="detail-username-input">用户名</label>
            <input type="text" id="detail-username-input" placeholder="请输入用户名">
        </div>
        <button class="btn" onclick="getUserByUsername()">按用户名查询用户</button>

        <!-- 用户详情展示区域（修复了id重复问题，所有span的id加了-show后缀） -->
        <div class="info-area" id="user-detail-content" style="display: none; margin-top: 20px;">
            <div class="debug-item">
                <div class="debug-title">用户基本信息</div>
                <div>用户ID：<span id="detail-id-show"></span></div>
                <div>用户名：<span id="detail-username-show"></span></div>
                <div>真实姓名：<span id="detail-realname-show"></span></div>
                <div>用户类型：<span id="detail-usertype-show"></span></div>
                <div>角色：<span id="detail-role-show"></span></div>
                <div>密码：<span id="detail-password-show"></span></div>
            </div>
        </div>
    </div>

    <!-- 3. 调试信息标签页 -->
    <div id="debug-info-tab" class="tab-content hidden">
        <h3>用户控制器调试信息</h3>
        <button class="btn" onclick="getDebugInfo()">获取调试信息</button>
        <div class="info-area" id="debug-info-content">
            点击上方按钮获取用户调试信息...
        </div>
    </div>

    <!-- 4. 健康检查标签页 -->
    <div id="health-check-tab" class="tab-content hidden">
        <h3>用户控制器健康检查</h3>
        <button class="btn" onclick="healthCheck()">执行健康检查</button>
        <div class="info-area" id="health-check-content">
            点击上方按钮执行健康检查...
        </div>
    </div>
</div>

<script>
    // 接口基础路径，与后端UserController一致
    const API_BASE_URL = "/api/users";

    // 1. 标签切换功能（与现有项目逻辑完全一致）
    function switchTab(tabId) {
        // 隐藏所有标签内容
        document.querySelectorAll('.tab-content').forEach(item => {
            item.classList.add('hidden');
        });
        // 移除所有标签激活状态
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        // 显示目标标签，激活目标按钮
        document.getElementById(tabId).classList.remove('hidden');
        event.target.classList.add('active');
    }

    // 2. 获取请求头（携带登录token，适配后端权限校验）
    function getRequestHeaders() {
        const token = localStorage.getItem("token");
        return {
            "Content-Type": "application/json",
            "Authorization": token ? `Bearer ${token}` : ""
        };
    }

    // 3. 用户列表相关查询方法
    // 获取所有用户
    function getAllUsers() {
        fetch(`${API_BASE_URL}`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 500) {
                        throw new Error("获取所有用户失败：服务器内部错误");
                    }
                    throw new Error(`获取所有用户失败：${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                renderUserTable(data);
            })
            .catch(err => {
                alert(err.message);
                // 清空表格
                document.getElementById("user-tbody").innerHTML = `<td colspan="7" style="text-align: center; color: #999;">获取用户失败：${err.message}</td>`;
            });
    }

    // 按用户类型查询
    function getUsersByType() {
        const userType = document.getElementById("query-user-type").value;
        if (!userType) {
            alert("请选择用户类型！");
            return;
        }

        fetch(`${API_BASE_URL}/type/${userType}`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 500) {
                        throw new Error("按类型查询用户失败：服务器内部错误");
                    }
                    throw new Error(`按类型查询用户失败：${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                renderUserTable(data);
            })
            .catch(err => {
                alert(err.message);
                // 清空表格
                document.getElementById("user-tbody").innerHTML = `<td colspan="7" style="text-align: center; color: #999;">获取用户失败：${err.message}</td>`;
            });
    }

    // 渲染用户列表表格
    function renderUserTable(userList) {
        const tbody = document.getElementById("user-tbody");
        tbody.innerHTML = ""; // 清空原有数据

        if (!userList || userList.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="7" style="text-align: center; color: #999;">暂无用户数据</td>`;
            tbody.appendChild(tr);
            return;
        }

        // 遍历用户数据渲染表格行
        userList.forEach(user => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                    <td>${user.id || ""}</td>
                    <td>${user.username || ""}</td>
                    <td>${user.realName || ""}</td>
                    <td>${user.userType || ""}</td>
                    <td>${user.role ? user.role.name || "无角色" : "无角色"}</td>
                    <td>${user.password || "[PROTECTED]"}</td>
                    <td>
                        <button class="btn btn-default" style="padding: 4px 8px;" onclick="fillUserId(${user.id})">查看详情</button>
                    </td>
                `;
            tbody.appendChild(tr);
        });
    }

    // 4. 用户详情相关查询方法
    // 填充用户ID并切换到详情标签页
    function fillUserId(userId) {
        document.getElementById("detail-user-id").value = userId;
        switchTab("user-detail-tab");
        getUserById(); // 自动查询详情
    }

    // 按ID查询用户
    function getUserById() {
        const userId = document.getElementById("detail-user-id").value;
        if (!userId) {
            alert("请输入用户ID！");
            return;
        }

        fetch(`${API_BASE_URL}/${userId}`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`未找到ID为${userId}的用户`);
                    }
                    throw new Error(`按ID查询用户失败：${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                showUserDetail(data);
            })
            .catch(err => {
                alert(err.message);
                document.getElementById("user-detail-content").style.display = "none";
            });
    }

    // 按用户名查询用户（同步修改input的id选择器）
    function getUserByUsername() {
        const username = document.getElementById("detail-username-input").value.trim();
        if (!username) {
            alert("请输入用户名！");
            return;
        }

        fetch(`${API_BASE_URL}/username/${username}`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`未找到用户名为${username}的用户`);
                    }
                    throw new Error(`按用户名查询用户失败：${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                showUserDetail(data);
            })
            .catch(err => {
                alert(err.message);
                document.getElementById("user-detail-content").style.display = "none";
            });
    }

    // 显示用户详情（同步修改为新的span id：加-show后缀）
    function showUserDetail(user) {
        const detailContent = document.getElementById("user-detail-content");
        detailContent.style.display = "block";

        // 填充详情数据（使用修复后的唯一id）
        document.getElementById("detail-id-show").innerText = user.id || "";
        document.getElementById("detail-username-show").innerText = user.username || "";
        document.getElementById("detail-realname-show").innerText = user.realName || "";
        document.getElementById("detail-usertype-show").innerText = user.userType || "";
        document.getElementById("detail-role-show").innerText = user.role ? user.role.name || "无角色" : "无角色";
        document.getElementById("detail-password-show").innerText = user.password || "[PROTECTED]";
    }

    // 5. 获取调试信息
    function getDebugInfo() {
        fetch(`${API_BASE_URL}/debug/info`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`获取调试信息失败：${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                renderDebugInfo(data);
            })
            .catch(err => {
                alert(err.message);
                document.getElementById("debug-info-content").innerHTML = `<p style="color: red;">获取调试信息失败：${err.message}</p>`;
            });
    }

    // 渲染调试信息
    function renderDebugInfo(debugData) {
        const debugContainer = document.getElementById("debug-info-content");
        let debugHtml = `
                <div class="debug-item">
                    <div class="debug-title">基础信息</div>
                    <div>提示信息：${debugData.message || ""}</div>
                    <div>用户总数：${debugData.totalUsers || 0}</div>
                    <div>查询时间：${debugData.timestamp || ""}</div>
                </div>
                <div class="debug-item">
                    <div class="debug-title">用户列表</div>
            `;

        // 渲染用户列表
        if (debugData.users && debugData.users.length > 0) {
            debugData.users.forEach((user, index) => {
                debugHtml += `
                        <div style="margin-left: 20px; margin-top: 5px;">
                            用户${index+1}：ID=${user.id || ""}，用户名=${user.username || ""}，真实姓名=${user.realName || ""}，类型=${user.userType || ""}，角色=${user.role || "无角色"}
                        </div>
                    `;
            });
        } else {
            debugHtml += `<div style="margin-left: 20px;">暂无用户数据</div>`;
        }

        debugHtml += `</div>`;
        debugContainer.innerHTML = debugHtml;
    }

    // 6. 健康检查
    function healthCheck() {
        fetch(`${API_BASE_URL}/health`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                // 无论成功还是失败，都获取响应体（后端异常时也返回JSON）
                return response.json().then(data => {
                    return {
                        isOk: response.ok,
                        data: data
                    };
                });
            })
            .then(result => {
                renderHealthCheck(result.data, result.isOk);
            })
            .catch(err => {
                alert("健康检查请求异常：" + err.message);
                document.getElementById("health-check-content").innerHTML = `<p style="color: red;">健康检查失败：${err.message}</p>`;
            });
    }

    // 渲染健康检查结果
    function renderHealthCheck(healthData, isOk) {
        const healthContainer = document.getElementById("health-check-content");
        let healthHtml = `
                <div class="debug-item">
                    <div class="debug-title" style="color: ${isOk ? "#4CAF50" : "#f56c6c"}">
                        健康状态：${healthData.status || (isOk ? "UP" : "DOWN")}
                    </div>
                    <div>服务名称：${healthData.service || "UserController"}</div>
                    <div>用户总数：${healthData.userCount || 0}</div>
                    <div>检查时间：${healthData.timestamp || ""}</div>
                    <div>提示信息：${healthData.message || ""}</div>
            `;

        if (!isOk) {
            healthHtml += `<div style="color: #f56c6c; margin-top: 5px;">错误信息：${healthData.error || ""}</div>`;
        }

        healthHtml += `</div>`;
        healthContainer.innerHTML = healthHtml;
    }

    // 页面加载完成后，默认获取所有用户
    window.onload = function() {
        getAllUsers();
    };
</script>
</body>
</html>