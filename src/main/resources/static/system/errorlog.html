<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>错误日志管理</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">错误日志管理</h1>
    
    <div class="macos-window">
        <div class="macos-window-header">
            <div class="macos-window-controls">
                <div class="macos-control macos-close"></div>
                <div class="macos-control macos-minimize"></div>
                <div class="macos-control macos-maximize"></div>
            </div>
        </div>
        
        <div class="macos-window-body">
            <div class="macos-sidebar">
                <div class="macos-nav-item active" data-tab="query-tab">
                    <div class="macos-nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>
                    <span>日志查询</span>
                </div>
                <div class="macos-nav-item" data-tab="detail-tab">
                    <div class="macos-nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>
                    <span>日志详情</span>
                </div>
                <div class="macos-nav-item" data-tab="stats-tab">
                    <div class="macos-nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
                    <span>错误统计</span>
                </div>
                <div class="macos-nav-item" data-tab="operate-tab">
                    <div class="macos-nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
                    <span>日志操作</span>
                </div>
            </div>
            
            <div class="macos-content">
                <div id="query-tab" class="macos-tab-content">
                    <div class="macos-section">
                        <h2 class="macos-section-title">查询条件</h2>
                        <div class="macos-form-grid">
                            <div class="macos-form-item">
                                <label>模块名称</label>
                                <input type="text" id="query-module" class="macos-input" placeholder="请输入模块名称">
                            </div>
                            <div class="macos-form-item">
                                <label>错误级别</label>
                                <select id="query-level" class="macos-input">
                                    <option value="">全部级别</option>
                                    <option value="INFO">INFO</option>
                                    <option value="WARN">WARN</option>
                                    <option value="ERROR">ERROR</option>
                                    <option value="FATAL">FATAL</option>
                                </select>
                            </div>
                            <div class="macos-form-item">
                                <label>页码</label>
                                <input type="number" id="query-page" class="macos-input" value="0" min="0">
                            </div>
                            <div class="macos-form-item">
                                <label>每页条数</label>
                                <input type="number" id="query-size" class="macos-input" value="20" min="1">
                            </div>
                        </div>
                        <div class="macos-actions">
                            <button class="macos-btn macos-btn-primary" onclick="queryErrorLogs()">通用条件查询</button>
                            <button class="macos-btn macos-btn-secondary" onclick="queryByModule()">按模块查询</button>
                            <button class="macos-btn macos-btn-secondary" onclick="queryByLevel()">按错误级别查询</button>
                            <button class="macos-btn macos-btn-secondary" onclick="queryByTimeRange()">按时间范围查询</button>
                            <button class="macos-btn macos-btn-secondary" onclick="getErrorLogList()">获取默认列表</button>
                        </div>
                    </div>
                    
                    <div class="macos-section">
                        <h2 class="macos-section-title">查询结果</h2>
                        <div class="macos-table-wrapper">
                            <table id="error-log-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>模块</th>
                                        <th>错误级别</th>
                                        <th>错误信息</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="error-log-tbody">
                                </tbody>
                            </table>
                        </div>
                        <div class="macos-pagination">
                            <button class="macos-btn macos-btn-secondary" onclick="changePage(-1)">上一页</button>
                            <span id="page-info">当前页码：0，总页数：0</span>
                            <button class="macos-btn macos-btn-secondary" onclick="changePage(1)">下一页</button>
                        </div>
                    </div>
                </div>

                <div id="detail-tab" class="macos-tab-content hidden">
                    <div class="macos-section">
                        <h2 class="macos-section-title">日志详情查询</h2>
                        <div class="macos-form-grid">
                            <div class="macos-form-item">
                                <label>日志ID</label>
                                <input type="number" id="detail-id" class="macos-input" placeholder="请输入日志ID" min="1">
                            </div>
                        </div>
                        <div class="macos-actions">
                            <button class="macos-btn macos-btn-primary" onclick="getErrorLogDetail()">查询详情</button>
                        </div>
                    </div>
                    
                    <div class="macos-section" id="log-detail-content" style="display: none;">
                        <h2 class="macos-section-title">详细信息</h2>
                        <div class="macos-detail-grid">
                            <div class="macos-detail-item">
                                <label>日志ID</label>
                                <span id="detail-log-id">-</span>
                            </div>
                            <div class="macos-detail-item">
                                <label>模块名称</label>
                                <span id="detail-module">-</span>
                            </div>
                            <div class="macos-detail-item">
                                <label>错误级别</label>
                                <span id="detail-level">-</span>
                            </div>
                            <div class="macos-detail-item">
                                <label>错误类型</label>
                                <span id="detail-error-type">-</span>
                            </div>
                            <div class="macos-detail-item">
                                <label>类名</label>
                                <span id="detail-class-name">-</span>
                            </div>
                            <div class="macos-detail-item">
                                <label>方法名</label>
                                <span id="detail-method-name">-</span>
                            </div>
                            <div class="macos-detail-item full-width">
                                <label>错误信息</label>
                                <div id="detail-message">-</div>
                            </div>
                            <div class="macos-detail-item full-width">
                                <label>错误堆栈</label>
                                <pre id="detail-stack"></pre>
                            </div>
                            <div class="macos-detail-item">
                                <label>请求URL</label>
                                <span id="detail-request-url">-</span>
                            </div>
                            <div class="macos-detail-item">
                                <label>请求方法</label>
                                <span id="detail-request-method">-</span>
                            </div>
                            <div class="macos-detail-item">
                                <label>客户端IP</label>
                                <span id="detail-client-ip">-</span>
                            </div>
                            <div class="macos-detail-item full-width">
                                <label>请求参数</label>
                                <pre id="detail-request-params"></pre>
                            </div>
                            <div class="macos-detail-item">
                                <label>错误时间</label>
                                <span id="detail-error-time">-</span>
                            </div>
                            <div class="macos-detail-item">
                                <label>触发用户</label>
                                <span id="detail-username">-</span>
                            </div>
                            <div class="macos-detail-item">
                                <label>创建时间</label>
                                <span id="detail-create-time">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="stats-tab" class="macos-tab-content hidden">
                    <div class="macos-section">
                        <h2 class="macos-section-title">错误统计信息</h2>
                        <div class="macos-actions">
                            <button class="macos-btn macos-btn-primary" onclick="getErrorStatistics()">获取总统计</button>
                            <button class="macos-btn macos-btn-secondary" onclick="getModuleErrorStats()">获取模块统计</button>
                            <button class="macos-btn macos-btn-secondary" onclick="getLevelErrorStats()">获取级别统计</button>
                            <button class="macos-btn macos-btn-secondary" onclick="getErrorTrend()">获取错误趋势</button>
                        </div>
                        <div class="macos-form-grid">
                            <div class="macos-form-item">
                                <label>趋势天数</label>
                                <input type="number" id="trend-days" class="macos-input" value="7" min="1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="macos-section">
                        <div class="macos-stats-grid" id="stats-container">
                        </div>
                    </div>
                </div>

                <div id="operate-tab" class="macos-tab-content hidden">
                    <div class="macos-section">
                        <h2 class="macos-section-title">单条删除</h2>
                        <div class="macos-form-grid">
                            <div class="macos-form-item">
                                <label>日志ID</label>
                                <input type="number" id="delete-id" class="macos-input" placeholder="请输入要删除的日志ID" min="1">
                            </div>
                        </div>
                        <div class="macos-actions">
                            <button class="macos-btn macos-btn-danger" onclick="deleteErrorLog()">单条删除</button>
                        </div>
                    </div>
                    
                    <div class="macos-section">
                        <h2 class="macos-section-title">批量删除</h2>
                        <div class="macos-form-grid">
                            <div class="macos-form-item full-width">
                                <label>批量删除ID</label>
                                <input type="text" id="batch-ids" class="macos-input" placeholder="请输入多个ID，用英文逗号分隔（如1,2,3）">
                            </div>
                        </div>
                        <div class="macos-actions">
                            <button class="macos-btn macos-btn-danger" onclick="batchDeleteErrorLogs()">批量删除</button>
                        </div>
                    </div>
                    
                    <div class="macos-section">
                        <h2 class="macos-section-title">按时间清理</h2>
                        <div class="macos-form-grid">
                            <div class="macos-form-item">
                                <label>过期时间点</label>
                                <input type="datetime-local" id="cleanup-time" class="macos-input">
                            </div>
                        </div>
                        <div class="macos-actions">
                            <button class="macos-btn macos-btn-danger" onclick="cleanupExpiredErrorLogs()">按时间清理过期日志</button>
                        </div>
                    </div>
                    
                    <div class="macos-section">
                        <h2 class="macos-section-title">按天数清理</h2>
                        <div class="macos-form-grid">
                            <div class="macos-form-item">
                                <label>天数</label>
                                <input type="number" id="cleanup-days" class="macos-input" value="30" min="1">
                            </div>
                        </div>
                        <div class="macos-actions">
                            <button class="macos-btn macos-btn-danger" onclick="cleanupByDays()">按天数清理日志</button>
                            <button class="macos-btn macos-btn-danger" onclick="triggerMonthlyCleanup()">触发每月清理任务</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.macos-window {
    background: rgba(30, 30, 30, 0.85);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1);
    overflow: hidden;
    max-width: 1400px;
    margin: 0 auto;
}

.macos-window-header {
    background: rgba(40, 40, 40, 0.95);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: flex-start;
}

.macos-window-controls {
    display: flex;
    gap: 8px;
}

.macos-control {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    cursor: pointer;
    transition: opacity 0.2s;
}

.macos-control:hover {
    opacity: 0.8;
}

.macos-close {
    background: #ff5f57;
}

.macos-minimize {
    background: #febc2e;
}

.macos-maximize {
    background: #28c840;
}

.macos-window-body {
    display: flex;
    min-height: 600px;
}

.macos-sidebar {
    width: 220px;
    background: rgba(35, 35, 35, 0.8);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    padding: 16px 12px;
}

.macos-nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 8px;
    cursor: pointer;
    color: var(--text);
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    margin-bottom: 4px;
}

.macos-nav-item:hover {
    background: rgba(255, 255, 255, 0.1);
}

.macos-nav-item.active {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(245, 158, 11, 0.2));
    color: #fde68a;
}

.macos-nav-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.macos-nav-icon svg {
    width: 100%;
    height: 100%;
    stroke: currentColor;
}

.macos-content {
    flex: 1;
    padding: 32px;
    overflow-y: auto;
}

.macos-tab-content {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.macos-section {
    margin-bottom: 32px;
}

.macos-section-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.macos-form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.macos-form-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.macos-form-item.full-width {
    grid-column: 1 / -1;
}

.macos-form-item label {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    opacity: 0.8;
}

.macos-input {
    height: 44px;
    padding: 0 16px;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    background: rgba(255, 255, 255, 0.08);
    color: var(--text);
    font-size: 14px;
    transition: all 0.2s ease;
}

.macos-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    background: rgba(255, 255, 255, 0.12);
}

.macos-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 24px;
}

.macos-btn {
    height: 44px;
    padding: 0 24px;
    border-radius: 10px;
    border: none;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.macos-btn-primary {
    background: linear-gradient(135deg, #fde68a, #f59e0b);
    color: #1a1a1a;
}

.macos-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
}

.macos-btn-secondary {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text);
    border: 1px solid rgba(255, 255, 255, 0.15);
}

.macos-btn-secondary:hover {
    background: rgba(255, 255, 255, 0.18);
    transform: translateY(-2px);
}

.macos-btn-danger {
    background: linear-gradient(135deg, #f87171, #ef4444);
    color: #ffffff;
}

.macos-btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
}

.macos-table-wrapper {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 24px;
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

th, td {
    padding: 16px 20px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

th {
    background: rgba(245, 158, 11, 0.15);
    font-weight: 700;
    color: #fde68a;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

td {
    font-size: 14px;
    color: var(--text);
}

tbody tr:hover td {
    background: rgba(245, 158, 11, 0.08);
}

tbody tr:last-child td {
    border-bottom: none;
}

.macos-pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
}

.macos-pagination span {
    color: var(--text);
    font-size: 14px;
}

.macos-detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.macos-detail-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.08);
}

.macos-detail-item.full-width {
    grid-column: 1 / -1;
}

.macos-detail-item label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    opacity: 0.6;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.macos-detail-item > span,
.macos-detail-item > div {
    font-size: 14px;
    color: var(--text);
    word-break: break-word;
}

.macos-detail-item pre {
    background: rgba(0, 0, 0, 0.4);
    border-radius: 8px;
    padding: 16px;
    margin: 0;
    color: #94a3b8;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 13px;
    line-height: 1.6;
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-all;
}

.macos-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
}

.macos-stats-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 24px;
    border: 1px solid rgba(255, 255, 255, 0.08);
}

.macos-stats-card h4 {
    margin: 0 0 20px 0;
    color: #fde68a;
    font-size: 16px;
    font-weight: 600;
}

.macos-stats-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    margin-bottom: 10px;
    font-size: 14px;
    color: var(--text);
}

.macos-stats-item:last-child {
    margin-bottom: 0;
}

.macos-stats-item-group {
    margin-bottom: 16px;
}

.macos-stats-item-group:last-child {
    margin-bottom: 0;
}

.macos-stats-group-title {
    color: #fde68a;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 10px;
    padding: 8px 12px;
    background: rgba(245, 158, 11, 0.15);
    border-radius: 6px;
}

.macos-stats-item-group .macos-stats-item {
    margin-bottom: 8px;
}

.hidden {
    display: none;
}

@media (max-width: 1024px) {
    .macos-window-body {
        flex-direction: column;
    }
    
    .macos-sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        overflow-x: auto;
        padding: 12px;
    }
    
    .macos-nav-item {
        flex-shrink: 0;
        margin-bottom: 0;
        margin-right: 8px;
    }
    
    .macos-content {
        padding: 20px;
    }
}
</style>

<script>
let currentPage = 0;
let totalPages = 0;
const ERROR_LOGS_API = `${API_BASE_URL}/api/error-logs`;

document.addEventListener('DOMContentLoaded', function() {
    SidebarManager.init({ currentPage: 'errorlog' });
    initMacosNav();
    getErrorLogList();
});

function initMacosNav() {
    document.querySelectorAll('.macos-nav-item').forEach(item => {
        item.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            switchTab(tabId);
        });
    });
}

function switchTab(tabId) {
    document.querySelectorAll('.macos-tab-content').forEach(item => {
        item.classList.add('hidden');
    });
    document.querySelectorAll('.macos-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    document.getElementById(tabId).classList.remove('hidden');
    document.querySelector(`.macos-nav-item[data-tab="${tabId}"]`).classList.add('active');
}

function getRequestHeaders() {
    const token = localStorage.getItem("token");
    return {
        "Content-Type": "application/json",
        "Authorization": token ? `Bearer ${token}` : ""
    };
}

function queryErrorLogs() {
    const module = document.getElementById("query-module").value.trim();
    const level = document.getElementById("query-level").value;
    const page = parseInt(document.getElementById("query-page").value);
    const size = parseInt(document.getElementById("query-size").value);
    currentPage = page;

    const queryDTO = {
        module: module || undefined,
        level: level || undefined,
        page: page,
        size: size
    };

    fetch(`${ERROR_LOGS_API}/query`, {
        method: "POST",
        headers: getRequestHeaders(),
        body: JSON.stringify(queryDTO)
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("查询失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            renderErrorLogTable(data);
            updatePageInfo(data);
        })
        .catch(err => {
            showToast(err.message);
        });
}

function queryByModule() {
    const module = document.getElementById("query-module").value.trim();
    if (!module) {
        showToast("请输入模块名称！");
        return;
    }
    const page = parseInt(document.getElementById("query-page").value);
    const size = parseInt(document.getElementById("query-size").value);
    currentPage = page;

    fetch(`${ERROR_LOGS_API}/module/${module}?page=${page}&size=${size}`, {
        method: "GET",
        headers: getRequestHeaders()
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("按模块查询失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            renderErrorLogTable(data);
            updatePageInfo(data);
        })
        .catch(err => {
            showToast(err.message);
        });
}

function queryByLevel() {
    const level = document.getElementById("query-level").value;
    if (!level) {
        showToast("请选择错误级别！");
        return;
    }
    const page = parseInt(document.getElementById("query-page").value);
    const size = parseInt(document.getElementById("query-size").value);
    currentPage = page;

    fetch(`${ERROR_LOGS_API}/level/${level}?page=${page}&size=${size}`, {
        method: "GET",
        headers: getRequestHeaders()
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("按级别查询失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            renderErrorLogTable(data);
            updatePageInfo(data);
        })
        .catch(err => {
            showToast(err.message);
        });
}

function queryByTimeRange() {
    const startTime = prompt("请输入开始时间（格式：yyyy-MM-dd'T'HH:mm:ss，如2025-12-01T00:00:00）");
    const endTime = prompt("请输入结束时间（格式：yyyy-MM-dd'T'HH:mm:ss，如2025-12-22T23:59:59）");
    if (!startTime || !endTime) {
        showToast("开始时间和结束时间不能为空！");
        return;
    }
    const page = parseInt(document.getElementById("query-page").value);
    const size = parseInt(document.getElementById("query-size").value);
    currentPage = page;

    fetch(`${ERROR_LOGS_API}/time-range?startTime=${startTime}&endTime=${endTime}&page=${page}&size=${size}`, {
        method: "GET",
        headers: getRequestHeaders()
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("按时间范围查询失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            renderErrorLogTable(data);
            updatePageInfo(data);
        })
        .catch(err => {
            showToast(err.message);
        });
}

function getErrorLogList() {
    const page = parseInt(document.getElementById("query-page").value);
    const size = parseInt(document.getElementById("query-size").value);
    currentPage = page;

    fetch(`${ERROR_LOGS_API}/list?page=${page}&size=${size}`, {
        method: "GET",
        headers: getRequestHeaders()
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("获取日志列表失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            renderErrorLogTable(data);
            updatePageInfo(data);
        })
        .catch(err => {
            showToast(err.message);
        });
}

function renderErrorLogTable(pageData) {
    const tbody = document.getElementById("error-log-tbody");
    tbody.innerHTML = "";

    if (!pageData.content || pageData.content.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" style="text-align: center; color: #94a3b8; padding: 60px 20px;">暂无错误日志数据</td>`;
        tbody.appendChild(tr);
        return;
    }

    pageData.content.forEach(log => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${log.id || ""}</td>
            <td>${log.module || ""}</td>
            <td>${log.level || ""}</td>
            <td title="${log.errorMessage || ""}">${(log.errorMessage || "").length > 50 ? (log.errorMessage.substring(0, 50) + "...") : log.errorMessage}</td>
            <td>${log.createTime || ""}</td>
            <td>
                <button class="macos-btn macos-btn-secondary" style="height: 32px; padding: 0 16px; font-size: 12px;" onclick="fillDetailId(${log.id})">查看详情</button>
                <button class="macos-btn macos-btn-danger" style="height: 32px; padding: 0 16px; font-size: 12px;" onclick="toDeleteSingle(${log.id})">删除</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function updatePageInfo(pageData) {
    totalPages = pageData.totalPages || 0;
    document.getElementById("page-info").innerText = `当前页码：${currentPage}，总页数：${totalPages}，总条数：${pageData.totalElements || 0}`;
}

function changePage(type) {
    const newPage = currentPage + type;
    if (newPage < 0 || newPage >= totalPages) {
        showToast("页码超出范围");
        return;
    }
    document.getElementById("query-page").value = newPage;
    getErrorLogList();
}

function fillDetailId(logId) {
    document.getElementById("detail-id").value = logId;
    document.querySelectorAll('.macos-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector('.macos-nav-item[data-tab="detail-tab"]').classList.add('active');
    document.querySelectorAll('.macos-tab-content').forEach(item => {
        item.classList.add('hidden');
    });
    document.getElementById('detail-tab').classList.remove('hidden');
    getErrorLogDetail();
}

function getErrorLogDetail() {
    const id = document.getElementById("detail-id").value;
    if (!id) {
        showToast("请输入日志ID");
        return;
    }

    fetch(`${ERROR_LOGS_API}/${id}`, {
        method: "GET",
        headers: getRequestHeaders()
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("查询详情失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            document.getElementById("detail-log-id").textContent = data.id || "-";
            document.getElementById("detail-module").textContent = data.module || "-";
            document.getElementById("detail-level").textContent = data.level || "-";
            document.getElementById("detail-error-type").textContent = data.errorType || "-";
            document.getElementById("detail-class-name").textContent = data.className || "-";
            document.getElementById("detail-method-name").textContent = data.methodName || "-";
            document.getElementById("detail-message").textContent = data.errorMessage || "-";
            document.getElementById("detail-stack").textContent = data.stackTrace || "";
            document.getElementById("detail-request-url").textContent = data.requestUrl || "-";
            document.getElementById("detail-request-method").textContent = data.requestMethod || "-";
            document.getElementById("detail-client-ip").textContent = data.clientIp || "-";
            document.getElementById("detail-request-params").textContent = data.requestParams || "";
            document.getElementById("detail-error-time").textContent = data.errorTime || "-";
            document.getElementById("detail-username").textContent = data.username || "-";
            document.getElementById("detail-create-time").textContent = data.createTime || "-";
            document.getElementById("log-detail-content").style.display = "block";
        })
        .catch(err => {
            showToast(err.message);
        });
}

function getErrorStatistics() {
    fetch(`${ERROR_LOGS_API}/statistics`, {
        method: "GET",
        headers: getRequestHeaders()
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("获取统计失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            renderStatisticsCard(data, "总统计");
        })
        .catch(err => {
            showToast(err.message);
        });
}

function getModuleErrorStats() {
    fetch(`${ERROR_LOGS_API}/statistics/module`, {
        method: "GET",
        headers: getRequestHeaders()
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("获取模块统计失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            renderStatisticsCard(data, "模块统计");
        })
        .catch(err => {
            showToast(err.message);
        });
}

function getLevelErrorStats() {
    fetch(`${ERROR_LOGS_API}/statistics/level`, {
        method: "GET",
        headers: getRequestHeaders()
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("获取级别统计失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            renderStatisticsCard(data, "级别统计");
        })
        .catch(err => {
            showToast(err.message);
        });
}

function getErrorTrend() {
    const days = document.getElementById("trend-days").value || 7;
    fetch(`${ERROR_LOGS_API}/statistics/trend?days=${days}`, {
        method: "GET",
        headers: getRequestHeaders()
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("获取趋势失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            renderStatisticsCard(data, `错误趋势（${days}天）`);
        })
        .catch(err => {
            showToast(err.message);
        });
}

function renderStatisticsCard(data, title) {
    const container = document.getElementById("stats-container");
    let html = `<div class="macos-stats-card"><h4>${title}</h4>`;
    
    if (typeof data === 'object' && data !== null) {
        for (const [key, value] of Object.entries(data)) {
            if (typeof value === 'object' && value !== null) {
                html += `<div class="macos-stats-item-group"><div class="macos-stats-group-title">${key}</div>`;
                for (const [subKey, subValue] of Object.entries(value)) {
                    html += `<div class="macos-stats-item"><span>${subKey}</span><span>${subValue}</span></div>`;
                }
                html += `</div>`;
            } else {
                html += `<div class="macos-stats-item"><span>${key}</span><span>${value}</span></div>`;
            }
        }
    } else {
        html += `<div class="macos-stats-item"><span>数据：</span><span>${JSON.stringify(data)}</span></div>`;
    }
    
    html += `</div>`;
    container.innerHTML = html;
}

function deleteErrorLog() {
    const id = document.getElementById("delete-id").value;
    if (!id) {
        showToast("请输入要删除的日志ID");
        return;
    }
    
    if (!confirm("确定要删除这条日志吗？")) {
        return;
    }

    fetch(`${ERROR_LOGS_API}/${id}`, {
        method: "DELETE",
        headers: getRequestHeaders()
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("删除失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            showToast("删除成功");
            document.getElementById("delete-id").value = "";
            getErrorLogList();
        })
        .catch(err => {
            showToast(err.message);
        });
}

function batchDeleteErrorLogs() {
    const ids = document.getElementById("batch-ids").value.trim();
    if (!ids) {
        showToast("请输入要删除的日志ID");
        return;
    }
    
    if (!confirm("确定要批量删除这些日志吗？")) {
        return;
    }

    fetch(`${ERROR_LOGS_API}/batch`, {
        method: "DELETE",
        headers: getRequestHeaders(),
        body: JSON.stringify(ids.split(',').map(id => id.trim()))
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("批量删除失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            showToast("批量删除成功");
            document.getElementById("batch-ids").value = "";
            getErrorLogList();
        })
        .catch(err => {
            showToast(err.message);
        });
}

function cleanupExpiredErrorLogs() {
    const time = document.getElementById("cleanup-time").value;
    if (!time) {
        showToast("请选择过期时间点");
        return;
    }
    
    if (!confirm("确定要清理过期日志吗？")) {
        return;
    }

    fetch(`${ERROR_LOGS_API}/cleanup/expired?time=${time}`, {
        method: "DELETE",
        headers: getRequestHeaders()
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("清理失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            showToast("清理成功，共删除 " + (data.deletedCount || 0) + " 条日志");
            getErrorLogList();
        })
        .catch(err => {
            showToast(err.message);
        });
}

function cleanupByDays() {
    const days = document.getElementById("cleanup-days").value;
    if (!days) {
        showToast("请输入天数");
        return;
    }
    
    if (!confirm(`确定要清理 ${days} 天前的日志吗？`)) {
        return;
    }

    fetch(`${ERROR_LOGS_API}/cleanup/days?days=${days}`, {
        method: "DELETE",
        headers: getRequestHeaders()
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("清理失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            showToast("清理成功，共删除 " + (data.deletedCount || 0) + " 条日志");
            getErrorLogList();
        })
        .catch(err => {
            showToast(err.message);
        });
}

function triggerMonthlyCleanup() {
    if (!confirm("确定要触发每月清理任务吗？")) {
        return;
    }

    fetch(`${ERROR_LOGS_API}/cleanup/monthly`, {
        method: "POST",
        headers: getRequestHeaders()
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("触发清理任务失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            showToast("清理任务执行成功，共删除 " + (data.deletedCount || 0) + " 条日志");
            getErrorLogList();
        })
        .catch(err => {
            showToast(err.message);
        });
}

function toDeleteSingle(logId) {
    if (!confirm("确定要删除这条日志吗？")) {
        return;
    }

    fetch(`${ERROR_LOGS_API}/${logId}`, {
        method: "DELETE",
        headers: getRequestHeaders()
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("删除失败：" + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            showToast("删除成功");
            getErrorLogList();
        })
        .catch(err => {
            showToast(err.message);
        });
}
</script>
</body>
</html>