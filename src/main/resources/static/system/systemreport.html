<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç³»ç»ŸæŠ¥è¡¨ç®¡ç†</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 24px;
            align-items: flex-end;
        }

        .search-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .search-group .form-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .search-group .form-field label {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
        }

        .search-group .form-field input,
        .search-group .form-field select {
            height: 42px;
            padding: 0 14px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: var(--text);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .search-group .form-field input:focus,
        .search-group .form-field select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(245,158,11,0.2);
        }

        .search-group .form-field input::placeholder {
            color: rgba(255,255,255,0.4);
        }

        .toolbar .btn {
            height: 42px;
            padding: 0 24px;
            font-size: 14px;
            border-radius: 10px;
            font-weight: 600;
        }

        .toolbar .btn.primary {
            background: linear-gradient(135deg, #fde68a, #f59e0b);
            color: #1a1a1a;
        }

        .toolbar .btn.secondary {
            background: rgba(255,255,255,0.15);
            color: var(--text);
        }

        .toolbar .btn.secondary:hover {
            background: rgba(255,255,255,0.25);
        }

        .tabs-wrapper {
            background: var(--card);
            backdrop-filter: blur(18px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            margin-top: 20px;
        }

        .page-tabs {
            display: flex;
            gap: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .page-tab {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .page-tab:hover {
            background: rgba(255,255,255,0.1);
        }

        .page-tab.active {
            background: linear-gradient(135deg, #fde68a, #f59e0b);
            color: #1a1a1a;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-table-wrapper {
            overflow-x: auto;
            margin-top: 16px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .data-table th {
            background: rgba(245,158,11,0.1);
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
        }

        .data-table td {
            color: var(--text);
        }

        .data-table tbody tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .data-table .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .data-table .status-badge.completed {
            background: rgba(34,197,94,0.2);
            color: #22c55e;
        }

        .data-table .status-badge.generating {
            background: rgba(245,158,11,0.2);
            color: #f59e0b;
        }

        .data-table .status-badge.pending {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.6);
        }

        .data-table .status-badge.failed {
            background: rgba(239,68,68,0.2);
            color: #ef4444;
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .table-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .table-actions .btn.view {
            background: rgba(245,158,11,0.2);
            color: #f59e0b;
        }

        .table-actions .btn.delete {
            background: rgba(239,68,68,0.2);
            color: #ef4444;
        }

        .table-actions .btn:hover {
            opacity: 0.8;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .pagination button {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: rgba(255,255,255,0.2);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination span {
            color: var(--text);
            font-size: 14px;
        }

        .form-container {
            max-width: 600px;
        }

        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-row .form-field {
            flex: 1;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 16px;
        }

        .form-field label {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
            font-weight: 500;
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: var(--text);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(245,158,11,0.2);
        }

        .form-field textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .form-actions .btn {
            height: 42px;
            padding: 0 24px;
            font-size: 14px;
            border-radius: 10px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .form-actions .btn.primary {
            background: linear-gradient(135deg, #fde68a, #f59e0b);
            color: #1a1a1a;
        }

        .form-actions .btn.secondary {
            background: rgba(255,255,255,0.15);
            color: var(--text);
        }

        .form-actions .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-card h3 {
            font-size: 13px;
            color: rgba(255,255,255,0.6);
            margin: 0 0 8px 0;
            font-weight: 500;
        }

        .stat-card p {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }

        .chart-container {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            height: 340px;
            box-sizing: border-box;
            overflow: hidden;
        }

        .chart-container h3 {
            font-size: 16px;
            color: var(--text);
            margin: 0 0 12px 0;
        }

        .chart-wrapper {
            height: calc(100% - 28px);
            width: 100%;
            overflow: hidden;
        }

        #reportTrendChart {
            width: 100%;
            height: 100%;
            max-height: 100%;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.4);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        #message {
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 16px;
            display: none;
        }

        #message.success {
            display: block;
            background: rgba(34,197,94,0.2);
            color: #22c55e;
            border: 1px solid rgba(34,197,94,0.3);
        }

        #message.error {
            display: block;
            background: rgba(239,68,68,0.2);
            color: #ef4444;
            border: 1px solid rgba(239,68,68,0.3);
        }
    </style>
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">ç³»ç»ŸæŠ¥è¡¨ç®¡ç†</h1>

    <div class="tabs-wrapper">
        <div class="page-tabs">
            <button class="page-tab active" data-tab="query">æŸ¥è¯¢æŠ¥è¡¨</button>
            <button class="page-tab" data-tab="generate">ç”ŸæˆæŠ¥è¡¨</button>
            <button class="page-tab" data-tab="operations">æ“ä½œè®°å½•</button>
            <button class="page-tab" data-tab="statistics">ç»Ÿè®¡ä¿¡æ¯</button>
        </div>

        <div id="message"></div>

        <div class="tab-content active" id="tab-query">
            <div class="toolbar">
                <div class="search-group">
                    <div class="form-field">
                        <label>æŠ¥è¡¨ç±»å‹</label>
                        <select id="report-type">
                            <option value="">å…¨éƒ¨</option>
                            <option value="ACADEMIC">å­¦æœ¯æŠ¥è¡¨</option>
                            <option value="FINANCIAL">è´¢åŠ¡æŠ¥è¡¨</option>
                            <option value="USER">ç”¨æˆ·æŠ¥è¡¨</option>
                            <option value="COURSE">è¯¾ç¨‹æŠ¥è¡¨</option>
                            <option value="COMPREHENSIVE">ç»¼åˆæŠ¥è¡¨</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label>å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="start-date">
                    </div>
                    <div class="form-field">
                        <label>ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="end-date">
                    </div>
                    <div class="form-field">
                        <label>çŠ¶æ€</label>
                        <select id="status">
                            <option value="">å…¨éƒ¨</option>
                            <option value="PENDING">å¾…ç”Ÿæˆ</option>
                            <option value="GENERATING">ç”Ÿæˆä¸­</option>
                            <option value="COMPLETED">å·²å®Œæˆ</option>
                            <option value="FAILED">å¤±è´¥</option>
                        </select>
                    </div>
                </div>
                <button class="btn primary" onclick="searchReports()">æŸ¥è¯¢</button>
            </div>

            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æŠ¥è¡¨ID</th>
                            <th>æŠ¥è¡¨åç§°</th>
                            <th>ç±»å‹</th>
                            <th>ç”Ÿæˆæ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="reports-tbody">
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="icon">ğŸ“Š</div>
                                <div>æš‚æ— æŠ¥è¡¨æ•°æ®</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="pagination">
                    <button id="prev-page" onclick="changePage(-1)" disabled>ä¸Šä¸€é¡µ</button>
                    <span id="page-info">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
                    <button id="next-page" onclick="changePage(1)" disabled>ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>

        <div class="tab-content" id="tab-generate">
            <form id="generate-form" class="form-container" onsubmit="generateReport(event)">
                <div class="form-row">
                    <div class="form-field">
                        <label>æŠ¥è¡¨åç§° *</label>
                        <input type="text" id="new-report-name" placeholder="è¯·è¾“å…¥æŠ¥è¡¨åç§°" required>
                    </div>
                    <div class="form-field">
                        <label>æŠ¥è¡¨ç±»å‹ *</label>
                        <select id="new-report-type" required>
                            <option value="">è¯·é€‰æ‹©æŠ¥è¡¨ç±»å‹</option>
                            <option value="ACADEMIC">å­¦æœ¯æŠ¥è¡¨</option>
                            <option value="FINANCIAL">è´¢åŠ¡æŠ¥è¡¨</option>
                            <option value="USER">ç”¨æˆ·æŠ¥è¡¨</option>
                            <option value="COURSE">è¯¾ç¨‹æŠ¥è¡¨</option>
                            <option value="COMPREHENSIVE">ç»¼åˆæŠ¥è¡¨</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>å¼€å§‹æ—¥æœŸ *</label>
                        <input type="date" id="report-start-date" required>
                    </div>
                    <div class="form-field">
                        <label>ç»“æŸæ—¥æœŸ *</label>
                        <input type="date" id="report-end-date" required>
                    </div>
                </div>
                <div class="form-field">
                    <label>æè¿°</label>
                    <textarea id="report-description" placeholder="è¯·è¾“å…¥æŠ¥è¡¨æè¿°"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn primary">ç”ŸæˆæŠ¥è¡¨</button>
                    <button type="reset" class="btn secondary">é‡ç½®</button>
                </div>
            </form>
        </div>

        <div class="tab-content" id="tab-operations">
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ“ä½œID</th>
                            <th>æŠ¥è¡¨ID</th>
                            <th>æ“ä½œç±»å‹</th>
                            <th>æ“ä½œäºº</th>
                            <th>æ“ä½œæ—¶é—´</th>
                            <th>è¯¦æƒ…</th>
                        </tr>
                    </thead>
                    <tbody id="operations-tbody">
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="icon">ğŸ“</div>
                                <div>æš‚æ— æ“ä½œè®°å½•</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="pagination">
                    <button id="ops-prev-page" onclick="changeOpsPage(-1)" disabled>ä¸Šä¸€é¡µ</button>
                    <span id="ops-page-info">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
                    <button id="ops-next-page" onclick="changeOpsPage(1)" disabled>ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>

        <div class="tab-content" id="tab-statistics">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>æ€»æŠ¥è¡¨æ•°</h3>
                    <p id="total-reports">0</p>
                </div>
                <div class="stat-card">
                    <h3>ä»Šæ—¥ç”Ÿæˆ</h3>
                    <p id="today-generated">0</p>
                </div>
                <div class="stat-card">
                    <h3>æœ¬å‘¨ç”Ÿæˆ</h3>
                    <p id="week-generated">0</p>
                </div>
                <div class="stat-card">
                    <h3>æœ¬æœˆç”Ÿæˆ</h3>
                    <p id="month-generated">0</p>
                </div>
                <div class="stat-card">
                    <h3>ç”Ÿæˆä¸­</h3>
                    <p id="generating-count">0</p>
                </div>
                <div class="stat-card">
                    <h3>å·²å®Œæˆ</h3>
                    <p id="completed-count">0</p>
                </div>
            </div>
            <div class="chart-container">
                <h3>æŠ¥è¡¨ç”Ÿæˆè¶‹åŠ¿</h3>
                <div class="chart-wrapper">
                    <canvas id="reportTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="report-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>æŠ¥è¡¨è¯¦æƒ…</h2>
            <button class="close-btn" onclick="closeReportModal()">&times;</button>
        </div>
        <div class="modal-body" id="report-detail-content">
            <div class="detail-loading">åŠ è½½ä¸­...</div>
        </div>
        <div class="modal-footer">
            <button class="btn secondary" onclick="closeReportModal()">å…³é—­</button>
            <button class="btn primary" id="download-btn" onclick="downloadCurrentReport()">ä¸‹è½½æŠ¥è¡¨</button>
        </div>
    </div>
</div>

<style>
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: var(--card);
    backdrop-filter: blur(18px);
    border-radius: 16px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.modal-header h2 {
    margin: 0;
    color: var(--text);
    font-size: 18px;
}

.close-btn {
    background: none;
    border: none;
    color: var(--text);
    font-size: 24px;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s;
}

.close-btn:hover {
    opacity: 1;
}

.modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 20px;
    border-top: 1px solid rgba(255,255,255,0.1);
}

.detail-item {
    margin-bottom: 16px;
}

.detail-item label {
    display: block;
    font-size: 12px;
    color: rgba(255,255,255,0.6);
    margin-bottom: 4px;
}

.detail-item p {
    margin: 0;
    color: var(--text);
    font-size: 14px;
}

.detail-loading {
    text-align: center;
    padding: 40px;
    color: rgba(255,255,255,0.4);
}

.report-data-section {
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
}

.report-data-section h4 {
    margin: 0 0 12px 0;
    color: var(--primary);
    font-size: 14px;
}

.report-data-section h5 {
    margin: 16px 0 10px 0;
    color: var(--text);
    font-size: 14px;
    font-weight: 600;
}

.report-data-section h6 {
    margin: 12px 0 8px 0;
    color: rgba(255,255,255,0.7);
    font-size: 13px;
}

.data-summary, .academic-data, .financial-data, .user-data {
    margin-top: 16px;
}

.summary-grid, .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 12px;
    margin-top: 8px;
}

.stat-item, .summary-item, .dist-item {
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.stat-item .label, .summary-item .label, .dist-item .type, .dist-item .dept {
    font-size: 12px;
    color: rgba(255,255,255,0.6);
}

.stat-item .value, .summary-item .value, .dist-item .count {
    font-size: 18px;
    font-weight: 600;
    color: var(--primary);
}

.course-list, .payment-list, .user-type-list, .dept-list {
    margin-top: 16px;
}

.distribution-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 8px;
}
</style>

<script>
let currentPage = 0;
let pageSize = 10;
let currentOpsPage = 0;
let currentReportId = null;

document.addEventListener('DOMContentLoaded', function() {
    SidebarManager.init({ currentPage: 'systemreport' });
    initTabs();
    loadReports();
    loadStatistics();
    initModalEvents();
});

function initModalEvents() {
    document.getElementById('report-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeReportModal();
        }
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeReportModal();
        }
    });
}

function closeReportModal() {
    document.getElementById('report-modal').classList.remove('show');
    currentReportId = null;
}

function openReportModal() {
    document.getElementById('report-modal').classList.add('show');
}

async function viewReport(id) {
    currentReportId = id;
    openReportModal();
    
    const contentDiv = document.getElementById('report-detail-content');
    contentDiv.innerHTML = '<div class="detail-loading">åŠ è½½ä¸­...</div>';
    
    try {
        const response = await apiRequest(`/api/system-reports/${id}`);
        
        if (!response.ok) {
            throw new Error('è·å–æŠ¥è¡¨è¯¦æƒ…å¤±è´¥');
        }
        
        const report = await response.json();
        
        let reportDataHtml = '';
        
        // è§£æå¹¶å±•ç¤ºèšåˆçš„ä¸šåŠ¡æ•°æ®
        if (report.reportData) {
            try {
                const reportData = JSON.parse(report.reportData);
                reportDataHtml = formatReportData(reportData, report.reportType);
            } catch (e) {
                console.error('è§£ææŠ¥è¡¨æ•°æ®å¤±è´¥:', e);
                reportDataHtml = `<pre style="white-space: pre-wrap; word-wrap: break-word; color: var(--text); font-size: 12px;">${report.reportData}</pre>`;
            }
        }
        
        contentDiv.innerHTML = `
            <div class="detail-item">
                <label>æŠ¥è¡¨ID</label>
                <p>${report.id}</p>
            </div>
            <div class="detail-item">
                <label>æŠ¥è¡¨åç§°</label>
                <p>${report.reportName || '-'}</p>
            </div>
            <div class="detail-item">
                <label>æŠ¥è¡¨ç±»å‹</label>
                <p>${formatReportType(report.reportType)}</p>
            </div>
            <div class="detail-item">
                <label>æè¿°</label>
                <p>${report.description || '-'}</p>
            </div>
            <div class="detail-item">
                <label>å¼€å§‹æ—¥æœŸ</label>
                <p>${formatDate(report.startDate)}</p>
            </div>
            <div class="detail-item">
                <label>ç»“æŸæ—¥æœŸ</label>
                <p>${formatDate(report.endDate)}</p>
            </div>
            <div class="detail-item">
                <label>ç”Ÿæˆæ—¶é—´</label>
                <p>${formatDate(report.generateTime)}</p>
            </div>
            <div class="detail-item">
                <label>çŠ¶æ€</label>
                <p><span class="status-badge ${report.status.toLowerCase()}">${formatStatus(report.status)}</span></p>
            </div>
            <div class="detail-item">
                <label>æ–‡ä»¶æ ¼å¼</label>
                <p>${report.reportFormat || 'HTML'}</p>
            </div>
            ${reportDataHtml}
        `;
        
        document.getElementById('download-btn').style.display = report.status === 'COMPLETED' ? 'block' : 'none';
        
    } catch (error) {
        console.error('è·å–æŠ¥è¡¨è¯¦æƒ…å¤±è´¥:', error);
        contentDiv.innerHTML = `<div class="detail-loading" style="color: #ef4444;">è·å–æŠ¥è¡¨è¯¦æƒ…å¤±è´¥: ${error.message}</div>`;
    }
}

function formatReportData(reportData, reportType) {
    let html = '<div class="report-data-section"><h4>ğŸ“Š èšåˆä¸šåŠ¡æ•°æ®</h4>';
    
    // æ˜¾ç¤ºæ‘˜è¦ä¿¡æ¯
    if (reportData.summary) {
        html += '<div class="data-summary">';
        html += '<h5>æ•°æ®æ‘˜è¦</h5>';
        html += '<div class="summary-grid">';
        
        if (reportData.summary.academicSummary) {
            html += `<div class="summary-item"><span class="label">è¯¾ç¨‹æ€»æ•°</span><span class="value">${reportData.summary.academicSummary.totalCourses}</span></div>`;
            html += `<div class="summary-item"><span class="label">å¹³å‡æˆç»©</span><span class="value">${reportData.summary.academicSummary.averageGrade}</span></div>`;
            html += `<div class="summary-item"><span class="label">é€šè¿‡ç‡</span><span class="value">${reportData.summary.academicSummary.passRate}</span></div>`;
        }
        
        if (reportData.summary.financialSummary) {
            html += `<div class="summary-item"><span class="label">æ€»æ”¶å…¥</span><span class="value">Â¥${formatMoney(reportData.summary.financialSummary.totalRevenue)}</span></div>`;
            html += `<div class="summary-item"><span class="label">æ€»æ”¯å‡º</span><span class="value">Â¥${formatMoney(reportData.summary.financialSummary.totalExpenses)}</span></div>`;
        }
        
        html += '</div></div>';
    }
    
    // æ ¹æ®æŠ¥è¡¨ç±»å‹æ˜¾ç¤ºè¯¦ç»†æ•°æ®
    if (reportType === 'ACADEMIC' && reportData.academicData) {
        html += formatAcademicData(reportData.academicData);
    } else if (reportType === 'FINANCIAL' && reportData.financialData) {
        html += formatFinancialData(reportData.financialData);
    } else if (reportType === 'USER' && reportData.userData) {
        html += formatUserData(reportData.userData);
    } else if (reportType === 'COURSE' && reportData.academicData) {
        html += formatAcademicData(reportData.academicData);
    } else if (reportType === 'COMPREHENSIVE') {
        if (reportData.academicData) html += formatAcademicData(reportData.academicData);
        if (reportData.financialData) html += formatFinancialData(reportData.financialData);
        if (reportData.userData) html += formatUserData(reportData.userData);
    }
    
    html += '</div>';
    return html;
}

function formatAcademicData(academicData) {
    let html = '<div class="academic-data"><h5>ğŸ“š å­¦æœ¯æ•°æ®</h5>';
    html += '<div class="stats-grid">';
    html += `<div class="stat-item"><span class="label">è¯¾ç¨‹æ€»æ•°</span><span class="value">${academicData.totalCourses}</span></div>`;
    html += `<div class="stat-item"><span class="label">å­¦ç”Ÿæ€»æ•°</span><span class="value">${academicData.totalStudents}</span></div>`;
    html += `<div class="stat-item"><span class="label">æ•™å¸ˆæ€»æ•°</span><span class="value">${academicData.totalTeachers}</span></div>`;
    html += `<div class="stat-item"><span class="label">å¹³å‡æˆç»©</span><span class="value">${academicData.averageGrade}</span></div>`;
    html += `<div class="stat-item"><span class="label">é€šè¿‡ç‡</span><span class="value">${academicData.passRate}%</span></div>`;
    html += '</div>';
    
    if (academicData.courseGrades && academicData.courseGrades.length > 0) {
        html += '<div class="course-list"><h6>è¯¾ç¨‹æˆç»©æ˜ç»†</h6>';
        html += '<table class="data-table"><thead><tr><th>è¯¾ç¨‹åç§°</th><th>å¹³å‡åˆ†</th><th>å­¦ç”Ÿæ•°</th><th>åŠæ ¼æ•°</th></tr></thead><tbody>';
        academicData.courseGrades.forEach(course => {
            html += `<tr><td>${course.courseName}</td><td>${course.averageScore.toFixed(1)}</td><td>${course.totalStudents}</td><td>${course.passCount}</td></tr>`;
        });
        html += '</tbody></table></div>';
    }
    
    html += '</div>';
    return html;
}

function formatFinancialData(financialData) {
    let html = '<div class="financial-data"><h5>ğŸ’° è´¢åŠ¡æ•°æ®</h5>';
    html += '<div class="stats-grid">';
    html += `<div class="stat-item"><span class="label">å­¦è´¹æ€»é¢</span><span class="value">Â¥${formatMoney(financialData.totalTuition)}</span></div>`;
    html += `<div class="stat-item"><span class="label">å¥–å­¦é‡‘æ€»é¢</span><span class="value">Â¥${formatMoney(financialData.totalScholarships)}</span></div>`;
    html += `<div class="stat-item"><span class="label">åŠ©å­¦é‡‘æ€»é¢</span><span class="value">Â¥${formatMoney(financialData.totalFinancialAid)}</span></div>`;
    html += `<div class="stat-item"><span class="label">æ”¯ä»˜æ€»é¢</span><span class="value">Â¥${formatMoney(financialData.totalPayments)}</span></div>`;
    html += '</div>';
    
    if (financialData.paymentSummary && financialData.paymentSummary.length > 0) {
        html += '<div class="payment-list"><h6>æ”¯ä»˜ç±»å‹æ˜ç»†</h6>';
        html += '<table class="data-table"><thead><tr><th>æ”¯ä»˜ç±»å‹</th><th>æ€»é‡‘é¢</th><th>äº¤æ˜“ç¬”æ•°</th></tr></thead><tbody>';
        financialData.paymentSummary.forEach(payment => {
            html += `<tr><td>${payment.paymentType}</td><td>Â¥${formatMoney(payment.totalAmount)}</td><td>${payment.transactionCount}</td></tr>`;
        });
        html += '</tbody></table></div>';
    }
    
    html += '</div>';
    return html;
}

function formatUserData(userData) {
    let html = '<div class="user-data"><h5>ğŸ‘¥ ç”¨æˆ·æ•°æ®</h5>';
    html += '<div class="stats-grid">';
    html += `<div class="stat-item"><span class="label">ç”¨æˆ·æ€»æ•°</span><span class="value">${userData.totalUsers}</span></div>`;
    html += `<div class="stat-item"><span class="label">æ´»è·ƒç”¨æˆ·</span><span class="value">${userData.activeUsers}</span></div>`;
    html += '</div>';
    
    if (userData.userTypeDistribution && Object.keys(userData.userTypeDistribution).length > 0) {
        html += '<div class="user-type-list"><h6>ç”¨æˆ·ç±»å‹åˆ†å¸ƒ</h6>';
        html += '<div class="distribution-grid">';
        for (const [type, count] of Object.entries(userData.userTypeDistribution)) {
            html += `<div class="dist-item"><span class="type">${formatUserType(type)}</span><span class="count">${count}</span></div>`;
        }
        html += '</div></div>';
    }
    
    if (userData.departmentDistribution && Object.keys(userData.departmentDistribution).length > 0) {
        html += '<div class="dept-list"><h6>é™¢ç³»åˆ†å¸ƒ</h6>';
        html += '<div class="distribution-grid">';
        for (const [dept, count] of Object.entries(userData.departmentDistribution)) {
            html += `<div class="dist-item"><span class="dept">${dept}</span><span class="count">${count}</span></div>`;
        }
        html += '</div></div>';
    }
    
    html += '</div>';
    return html;
}

function formatMoney(amount) {
    return amount ? amount.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';
}

function formatUserType(type) {
    const typeMap = {
        'STUDENT': 'å­¦ç”Ÿ',
        'TEACHER': 'æ•™å¸ˆ',
        'ADMIN': 'ç®¡ç†å‘˜',
        'STAFF': 'èŒå·¥'
    };
    return typeMap[type] || type;
}

async function downloadCurrentReport() {
    if (!currentReportId) return;
    
    try {
        const response = await apiRequest(`/api/system-reports/${currentReportId}/download`);
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report_${currentReportId}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showToast('æŠ¥è¡¨ä¸‹è½½æˆåŠŸ');
        } else if (response.status === 404) {
            showToast('æŠ¥è¡¨æ–‡ä»¶ä¸å­˜åœ¨', true);
        } else {
            throw new Error('ä¸‹è½½å¤±è´¥');
        }
    } catch (error) {
        console.error('ä¸‹è½½æŠ¥è¡¨å¤±è´¥:', error);
        showToast('ä¸‹è½½æŠ¥è¡¨å¤±è´¥: ' + error.message, true);
    }
}

function initTabs() {
    document.querySelectorAll('.page-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            
            document.querySelectorAll('.page-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            
            if (tabId === 'operations') {
                loadOperations();
            }
        });
    });
}

function showMessage(message, isError = false) {
    const msgDiv = document.getElementById('message');
    msgDiv.textContent = message;
    msgDiv.className = isError ? 'error' : 'success';
    
    setTimeout(() => {
        msgDiv.className = '';
    }, 3000);
}

function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

async function loadReports() {
    try {
        const type = document.getElementById('report-type').value;
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const status = document.getElementById('status').value;
        
        let url = `/api/system-reports?page=${currentPage}&size=${pageSize}`;
        if (type) url += `&reportType=${type}`;
        if (startDate) url += `&start=${startDate}T00:00:00`;
        if (endDate) url += `&end=${endDate}T23:59:59`;
        if (status) url += `&status=${status}`;
        
        const response = await apiRequest(url);
        const pageData = await response.json();
        
        const tbody = document.getElementById('reports-tbody');
        
        if (!pageData.content || pageData.content.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <div class="icon"></div>
                        <div>æš‚æ— æŠ¥è¡¨æ•°æ®</div>
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = pageData.content.map(report => `
                <tr>
                    <td>${report.id}</td>
                    <td>${report.reportName}</td>
                    <td>${formatReportType(report.reportType)}</td>
                    <td>${formatDate(report.generateTime)}</td>
                    <td><span class="status-badge ${report.status.toLowerCase()}">${formatStatus(report.status)}</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="btn view" onclick="viewReport(${report.id})">æŸ¥çœ‹</button>
                            <button class="btn delete" onclick="deleteReport(${report.id})">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        updatePagination(pageData, 'prev-page', 'next-page', 'page-info');
    } catch (error) {
        console.error('åŠ è½½æŠ¥è¡¨å¤±è´¥:', error);
        showMessage('åŠ è½½æŠ¥è¡¨å¤±è´¥', true);
    }
}

function searchReports() {
    currentPage = 0;
    loadReports();
}

function changePage(delta) {
    currentPage += delta;
    loadReports();
}

async function generateReport(event) {
    event.preventDefault();
    
    const reportName = document.getElementById('new-report-name').value;
    const reportType = document.getElementById('new-report-type').value;
    const startDate = document.getElementById('report-start-date').value;
    const endDate = document.getElementById('report-end-date').value;
    
    if (!reportName || !reportType || !startDate || !endDate) {
        showMessage('è¯·å¡«å†™å®Œæ•´çš„æŠ¥è¡¨ä¿¡æ¯', true);
        return;
    }
    
    try {
        const reportData = {
            reportName: reportName,
            reportType: reportType,
            startDate: startDate + 'T00:00:00',
            endDate: endDate + 'T23:59:59',
            description: document.getElementById('report-description').value,
            reportFormat: 'HTML'
        };
        
        showMessage('æ­£åœ¨ç”ŸæˆæŠ¥è¡¨ï¼Œæ•´åˆå„æ¨¡å—ä¸šåŠ¡æ•°æ®...', false);
        
        const response = await apiRequest('/api/system-reports/generate-with-data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(reportData)
        });
        
        if (response.ok) {
            const report = await response.json();
            showMessage('æŠ¥è¡¨ç”ŸæˆæˆåŠŸï¼å·²æ•´åˆå­¦æœ¯ã€ç”¨æˆ·ã€è´¢åŠ¡ç­‰ä¸šåŠ¡æ¨¡å—æ•°æ®');
            document.getElementById('generate-form').reset();
            loadReports();
            loadStatistics();
            
            // è‡ªåŠ¨æ˜¾ç¤ºæ–°ç”Ÿæˆçš„æŠ¥è¡¨è¯¦æƒ…
            setTimeout(() => {
                viewReport(report.id);
            }, 500);
        } else {
            const errorData = await response.json().catch(() => ({}));
            showMessage('æŠ¥è¡¨ç”Ÿæˆå¤±è´¥: ' + (errorData.message || 'æœªçŸ¥é”™è¯¯'), true);
        }
    } catch (error) {
        console.error('ç”ŸæˆæŠ¥è¡¨å¤±è´¥:', error);
        showMessage('ç”ŸæˆæŠ¥è¡¨å¤±è´¥: ' + error.message, true);
    }
}

async function deleteReport(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥æŠ¥è¡¨å—ï¼Ÿ')) return;
    
    try {
        const response = await apiRequest(`/api/system-reports/${id}`, { method: 'DELETE' });
        
        if (response.ok) {
            showMessage('æŠ¥è¡¨åˆ é™¤æˆåŠŸ');
            loadReports();
            loadStatistics();
        } else {
            showMessage('æŠ¥è¡¨åˆ é™¤å¤±è´¥', true);
        }
    } catch (error) {
        console.error('åˆ é™¤æŠ¥è¡¨å¤±è´¥:', error);
        showMessage('åˆ é™¤æŠ¥è¡¨å¤±è´¥: ' + error.message, true);
    }
}

async function loadStatistics() {
    try {
        const now = new Date();
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekStart = new Date(todayStart);
        weekStart.setDate(weekStart.getDate() - weekStart.getDay());
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

        let allReports = [];
        let page = 0;
        const pageSize = 100;
        
        while (true) {
            const response = await apiRequest(`/api/system-reports?page=${page}&size=${pageSize}`);
            const pageData = await response.json();
            
            if (pageData.content) {
                allReports = allReports.concat(pageData.content);
            }
            
            if (pageData.last || !pageData.content || pageData.content.length === 0) {
                break;
            }
            page++;
        }
        
        const totalCount = allReports.length;
        const completedCount = allReports.filter(r => r.status === 'COMPLETED').length;
        const generatingCount = allReports.filter(r => r.status === 'GENERATING').length;
        
        const todayGenerated = allReports.filter(r => {
            if (!r.createTime) return false;
            const createDate = new Date(r.createTime);
            return createDate >= todayStart && r.status === 'COMPLETED';
        }).length;
        
        const weekGenerated = allReports.filter(r => {
            if (!r.createTime) return false;
            const createDate = new Date(r.createTime);
            return createDate >= weekStart && r.status === 'COMPLETED';
        }).length;
        
        const monthGenerated = allReports.filter(r => {
            if (!r.createTime) return false;
            const createDate = new Date(r.createTime);
            return createDate >= monthStart && r.status === 'COMPLETED';
        }).length;
        
        document.getElementById('total-reports').textContent = totalCount;
        document.getElementById('completed-count').textContent = completedCount;
        document.getElementById('generating-count').textContent = generatingCount;
        document.getElementById('today-generated').textContent = todayGenerated;
        document.getElementById('week-generated').textContent = weekGenerated;
        document.getElementById('month-generated').textContent = monthGenerated;
        
        renderReportTrendChart(allReports);
        
    } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
        document.getElementById('total-reports').textContent = '-';
        document.getElementById('completed-count').textContent = '-';
        document.getElementById('generating-count').textContent = '-';
        document.getElementById('today-generated').textContent = '-';
        document.getElementById('week-generated').textContent = '-';
        document.getElementById('month-generated').textContent = '-';
        renderEmptyChart();
    }
}

function renderReportTrendChart(reports) {
    const ctx = document.getElementById('reportTrendChart');
    if (!ctx) return;
    
    if (window.reportChartInstance) {
        window.reportChartInstance.destroy();
    }
    
    const last7Days = [];
    const completedData = [];
    const generatedData = [];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const dayEnd = new Date(dayStart);
        dayEnd.setDate(dayEnd.getDate() + 1);
        
        last7Days.push(`${date.getMonth() + 1}/${date.getDate()}`);
        
        const completed = reports.filter(r => {
            if (!r.createTime) return false;
            const createDate = new Date(r.createTime);
            return createDate >= dayStart && createDate < dayEnd && r.status === 'COMPLETED';
        }).length;
        
        const generated = reports.filter(r => {
            if (!r.createTime) return false;
            const createDate = new Date(r.createTime);
            return createDate >= dayStart && createDate < dayEnd;
        }).length;
        
        completedData.push(completed);
        generatedData.push(generated);
    }
    
    if (typeof Chart !== 'undefined') {
        window.reportChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: last7Days,
                datasets: [
                    {
                        label: 'å·²å®ŒæˆæŠ¥è¡¨',
                        data: completedData,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'ç”ŸæˆæŠ¥è¡¨æ€»æ•°',
                        data: generatedData,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: 'rgba(255, 255, 255, 0.8)',
                            font: { size: 12 },
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#f59e0b',
                        bodyColor: '#fff',
                        borderColor: 'rgba(245, 158, 11, 0.3)',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + ' ä»½';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.6)',
                            font: { size: 11 }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.6)',
                            font: { size: 11 },
                            stepSize: 1
                        }
                    }
                }
            }
        });
    } else {
        renderEmptyChart();
    }
}

function renderEmptyChart() {
    const ctx = document.getElementById('reportTrendChart');
    if (!ctx) return;
    
    ctx.style.visibility = 'hidden';
}

async function loadOperations() {
    try {
        const response = await apiRequest(`/api/system-reports?page=${currentOpsPage}&size=${pageSize}`);
        const pageData = await response.json();
        
        const tbody = document.getElementById('operations-tbody');
        
        if (!pageData.content || pageData.content.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <div class="icon">ğŸ“</div>
                        <div>æš‚æ— æ“ä½œè®°å½•</div>
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = pageData.content.map((report, index) => {
                const operationType = getOperationType(report);
                return `
                    <tr>
                        <td>${report.id}-${index}</td>
                        <td>${report.id}</td>
                        <td><span class="status-badge ${operationType.class}">${operationType.text}</span></td>
                        <td>ç³»ç»Ÿ</td>
                        <td>${formatDate(report.createTime)}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn view" onclick="viewReport(${report.id})">æŸ¥çœ‹</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        updatePagination(pageData, 'ops-prev-page', 'ops-next-page', 'ops-page-info');
    } catch (error) {
        console.error('åŠ è½½æ“ä½œè®°å½•å¤±è´¥:', error);
        const tbody = document.getElementById('operations-tbody');
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="empty-state">
                    <div class="icon">âš ï¸</div>
                    <div>åŠ è½½æ“ä½œè®°å½•å¤±è´¥</div>
                </td>
            </tr>
        `;
    }
}

function getOperationType(report) {
    const status = report.status;
    if (status === 'COMPLETED') {
        return { text: 'ç”ŸæˆæŠ¥è¡¨', class: 'completed' };
    } else if (status === 'GENERATING') {
        return { text: 'ç”Ÿæˆä¸­', class: 'generating' };
    } else if (status === 'FAILED') {
        return { text: 'ç”Ÿæˆå¤±è´¥', class: 'failed' };
    } else {
        return { text: 'å¾…ç”Ÿæˆ', class: 'pending' };
    }
}

function changeOpsPage(delta) {
    currentOpsPage += delta;
    loadOperations();
}

function formatReportType(type) {
    const typeMap = {
        'ACADEMIC': 'å­¦æœ¯æŠ¥è¡¨',
        'FINANCIAL': 'è´¢åŠ¡æŠ¥è¡¨',
        'USER': 'ç”¨æˆ·æŠ¥è¡¨',
        'COURSE': 'è¯¾ç¨‹æŠ¥è¡¨',
        'COMPREHENSIVE': 'ç»¼åˆæŠ¥è¡¨'
    };
    return typeMap[type] || type;
}

function formatStatus(status) {
    const statusMap = {
        'PENDING': 'å¾…ç”Ÿæˆ',
        'GENERATING': 'ç”Ÿæˆä¸­',
        'COMPLETED': 'å·²å®Œæˆ',
        'FAILED': 'å¤±è´¥'
    };
    return statusMap[status] || status;
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleString('zh-CN');
}

function updatePagination(pageData, prevBtnId, nextBtnId, infoId) {
    const prevBtn = document.getElementById(prevBtnId);
    const nextBtn = document.getElementById(nextBtnId);
    const infoSpan = document.getElementById(infoId);
    
    prevBtn.disabled = pageData.first;
    nextBtn.disabled = pageData.last;
    infoSpan.textContent = `ç¬¬ ${pageData.number + 1} é¡µï¼Œå…± ${pageData.totalPages} é¡µ`;
}
</script>
</body>
</html>
