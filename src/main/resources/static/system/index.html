<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é¦–é¡µ - Egg University</title>

    <!-- å…¨å±€æ ·å¼ -->
    <link rel="stylesheet" href="/css/style.css?v=egg-final">
    <link rel="stylesheet" href="/css/index.css?v=egg-final">
    <link rel="stylesheet" href="/css/sidebar.css?v=egg-final">
</head>
<body>

<!-- ç²’å­èƒŒæ™¯ -->
<canvas id="bg"></canvas>

<!-- ä¾§è¾¹æ  -->
<div class="sidebar" id="sidebar">
    <!-- ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® -->
    <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
    
    <!-- ä¾§è¾¹æ æ”¶èµ·çŠ¶æ€æ˜¾ç¤ºçš„å›¾æ ‡ -->
    <div class="sidebar-collapsed-icon" id="sidebarCollapsedIcon">â˜°</div>
    
    <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
    <div class="sidebar-header">
        <canvas id="sidebar-egg" width="40" height="50" class="sidebar-logo"></canvas>
    </div>
    
    <!-- ä¾§è¾¹æ å†…å®¹ -->
    <div class="sidebar-content">
        <!-- å¸¸ç”¨åŠŸèƒ½ -->
        <div class="sidebar-group" id="favoritesGroup">
            <div class="sidebar-group-title">
                <span>å¸¸ç”¨åŠŸèƒ½</span>
                <span class="disclosure">â–¼</span>
            </div>
            <div class="sidebar-group-items">
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" onclick="goToAppointment()">
                            <span class="sidebar-menu-icon"></span>
                            <span class="sidebar-menu-text">é¢„çº¦æ¨¡å—</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" onclick="goToClassroom()">
                            <span class="sidebar-menu-icon"></span>
                            <span class="sidebar-menu-text">æ•™å®¤ç³»ç»Ÿ</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" onclick="goToCourse()">
                            <span class="sidebar-menu-icon"></span>
                            <span class="sidebar-menu-text">è¯¾ç¨‹ç®¡ç†</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- ç³»ç»Ÿç®¡ç† -->
        <div class="sidebar-group" id="systemGroup">
            <div class="sidebar-group-title">
                <span>ç³»ç»Ÿç®¡ç†</span>
                <span class="disclosure">â–¼</span>
            </div>
            <div class="sidebar-group-items">
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" onclick="goTotimetable()">
                            <span class="sidebar-menu-icon"></span>
                            <span class="sidebar-menu-text">æ’è¯¾ç³»ç»Ÿ</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" onclick="goToSyllabus()">
                            <span class="sidebar-menu-icon"></span>
                            <span class="sidebar-menu-text">è¯¾ç¨‹å¤§çº²</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" onclick="goToGrade()">
                            <span class="sidebar-menu-icon"></span>
                            <span class="sidebar-menu-text">æˆç»©ç®¡ç†</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" onclick="goToFinance()">
                            <span class="sidebar-menu-icon"></span>
                            <span class="sidebar-menu-text">è´¢åŠ¡ç®¡ç†</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- ç”¨æˆ·åŠŸèƒ½ -->
        <div class="sidebar-group" id="userGroup">
            <div class="sidebar-group-title">
                <span>ç”¨æˆ·åŠŸèƒ½</span>
                <span class="disclosure">â–¼</span>
            </div>
            <div class="sidebar-group-items">
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" onclick="openChangePassword()">
                            <span class="sidebar-menu-icon"></span>
                            <span class="sidebar-menu-text">ä¿®æ”¹å¯†ç </span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item admin-only">
                        <a href="#" class="sidebar-menu-link" onclick="goToRegister()">
                            <span class="sidebar-menu-icon"></span>
                            <span class="sidebar-menu-text">æ³¨å†Œæ–°ç”¨æˆ·</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item admin-only">
                        <a href="#" class="sidebar-menu-link" onclick="openResetPassword()">
                            <span class="sidebar-menu-icon"></span>
                            <span class="sidebar-menu-text">é‡ç½®ç”¨æˆ·å¯†ç </span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item student-only">
                        <a href="#" class="sidebar-menu-link" onclick="goToCourseSelection()">
                            <span class="sidebar-menu-icon"></span>
                            <span class="sidebar-menu-text">å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item student-only">
                        <a href="#" class="sidebar-menu-link" onclick="goToStimetable()">
                            <span class="sidebar-menu-icon"></span>
                            <span class="sidebar-menu-text">å­¦ç”Ÿè¯¾è¡¨</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item teacher-only">
                        <a href="#" class="sidebar-menu-link" onclick="goToTtimetable()">
                            <span class="sidebar-menu-icon"></span>
                            <span class="sidebar-menu-text">æ•™å¸ˆè¯¾è¡¨</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- ä¸»é¢˜åˆ‡æ¢ -->
<button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“</button>

<!-- é¡¶éƒ¨Logoæ  -->
<div class="header-logo">
    <canvas id="egg" width="80" height="100" style="width:80px;height:100px;"></canvas>
    <canvas id="school-title" width="150" height="50" style="width:150px;height:50px;"></canvas>
    <div class="school-info">
        <span class="school-en">EGG UNIVERSITY</span>
        <span class="school-sub">Since 2025</span>
    </div>
</div>

<div class="login-box card">
    <div class="user-info" id="user-info" style="width: 100%;">
        <p>æ­£åœ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯...</p>
    </div>
</div>

<div id="toast" class="toast"></div>

<!-- ä¿®æ”¹å¯†ç å¼¹çª— -->
<div class="modal" id="changePasswordModal">
    <div class="modal-content card">
        <h3>ä¿®æ”¹å¯†ç </h3>
        <input type="password" id="oldPassword" placeholder="æ—§å¯†ç " class="input"><br>
        <input type="password" id="newPassword" placeholder="æ–°å¯†ç " class="input"><br>
        <button class="btn" onclick="submitChangePassword()">æäº¤</button>
        <button class="btn" onclick="closeChangePassword()" style="margin-top: 10px; background: rgba(255,255,255,0.2);">å–æ¶ˆ</button>
        <p id="changePasswordMsg"></p>
    </div>
</div>

<!-- ç®¡ç†å‘˜é‡ç½®å¯†ç å¼¹çª— -->
<div class="modal" id="resetPasswordModal">
    <div class="modal-content card">
        <h3>é‡ç½®ç”¨æˆ·å¯†ç ï¼ˆç®¡ç†å‘˜ï¼‰</h3>
        <input type="text" id="resetUsername" placeholder="ç”¨æˆ·å" class="input"><br>
        <input type="password" id="resetNewPassword" placeholder="æ–°å¯†ç " class="input"><br>
        <button class="btn" onclick="submitResetPassword()">æäº¤</button>
        <button class="btn" onclick="closeResetPassword()" style="margin-top: 10px; background: rgba(255,255,255,0.2);">å–æ¶ˆ</button>
        <p id="resetPasswordMsg"></p>
    </div>
</div>

<script src="/js/api.js"></script>
<script src="/js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>

<script>
    const font = new FontFace('Maobi', 'url(/fonts/Maobi.ttf)');
    font.load().then(function(loadedFont) {
        document.fonts.add(loadedFont);
        const canvas = document.getElementById('school-title');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 150, 50);
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            ctx.font = 'bold 32px Maobi';
            ctx.fillStyle = '#F59E0B';
            ctx.fillText('é¸¡è›‹å¤§å­¦', 0, 25);
        }
    }).catch(e => console.error('å­—ä½“åŠ è½½å¤±è´¥', e));
</script>

<script>
    const token = localStorage.getItem('token');
    let currentUser = null;

    // ä¾§è¾¹æ åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarCollapsedIcon = document.getElementById('sidebarCollapsedIcon');
        
        // ä¾§è¾¹æ æ”¶ç¼©/å±•å¼€
        function toggleSidebar() {
            sidebar.classList.toggle('collapsed');
            const icon = sidebar.classList.contains('collapsed') ? 'â˜°' : 'âœ•';
            sidebarToggle.textContent = icon;
            sidebarCollapsedIcon.textContent = icon;
            
            // ä¿å­˜ä¾§è¾¹æ çŠ¶æ€
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        }
        
        sidebarToggle.addEventListener('click', toggleSidebar);
        sidebarCollapsedIcon.addEventListener('click', toggleSidebar);
        
        // æ¢å¤ä¾§è¾¹æ çŠ¶æ€
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            sidebar.classList.add('collapsed');
            sidebarToggle.textContent = 'â˜°';
            sidebarCollapsedIcon.textContent = 'â˜°';
        }
        
        // åˆ†ç»„æ”¶ç¼©/å±•å¼€
        document.querySelectorAll('.sidebar-group-title').forEach(title => {
            title.addEventListener('click', function() {
                const group = this.parentElement;
                group.classList.toggle('collapsed');
                
                // ä¿å­˜åˆ†ç»„çŠ¶æ€
                const groupId = group.id;
                localStorage.setItem(groupId + 'Collapsed', group.classList.contains('collapsed'));
            });
            
            // æ¢å¤åˆ†ç»„çŠ¶æ€
            const group = title.parentElement;
            const groupId = group.id;
            if (localStorage.getItem(groupId + 'Collapsed') === 'true') {
                group.classList.add('collapsed');
            }
        });
        
        // ç»˜åˆ¶ä¾§è¾¹æ ä¸­çš„é¸¡è›‹logo
        drawSidebarEgg();
    });
    
    // ç»˜åˆ¶ä¾§è¾¹æ ä¸­çš„é¸¡è›‹logo
    function drawSidebarEgg() {
        const canvas = document.getElementById('sidebar-egg');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 40, 50);
            
            // ç»˜åˆ¶é¸¡è›‹å½¢çŠ¶
            ctx.beginPath();
            ctx.moveTo(20, 5);
            ctx.bezierCurveTo(35, 5, 40, 20, 40, 30);
            ctx.bezierCurveTo(40, 40, 35, 45, 20, 45);
            ctx.bezierCurveTo(5, 45, 0, 40, 0, 30);
            ctx.bezierCurveTo(0, 20, 5, 5, 20, 5);
            ctx.closePath();
            
            // å¡«å……æ¸å˜è‰²
            const gradient = ctx.createLinearGradient(0, 0, 0, 50);
            gradient.addColorStop(0, '#fde68a');
            gradient.addColorStop(1, '#f59e0b');
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // æ·»åŠ è¾¹æ¡†
            ctx.strokeStyle = '#d97706';
            ctx.lineWidth = 1;
            ctx.stroke();
        }
    }

    if (!token) {
        document.getElementById('user-info').innerHTML = '<p style="color: #ef4444;">æœªæ£€æµ‹åˆ°ç™»å½•ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•</p>';
    } else {
        apiRequest(API_ENDPOINTS.USER_INFO + `?token=${token}`)
            .then(resp => resp.json())
            .then(user => {
                currentUser = user;
                const div = document.getElementById('user-info');
                let html = `<h2>ç”¨æˆ·ä¿¡æ¯</h2>
                        <p><strong>ç”¨æˆ·åï¼š</strong>${user.username}</p>
                        <p><strong>çœŸå®å§“åï¼š</strong>${user.realName}</p>
                        <p><strong>é‚®ç®±ï¼š</strong>${user.email || '-'}</p>
                        <p><strong>ç”µè¯ï¼š</strong>${user.phone || '-'}</p>
                        <p><strong>èº«ä»½ï¼š</strong>${user.userType}</p>`;

                if (user.userType === 'STUDENT') {
                    html += `<hr>
                     <p><strong>å­¦å·ï¼š</strong>${user.studentId || '-'}</p>
                     <p><strong>é™¢ç³»ï¼š</strong>${user.department || '-'}</p>
                     <p><strong>ä¸“ä¸šï¼š</strong>${user.major || '-'}</p>
                     <p><strong>å¹´çº§ï¼š</strong>${user.grade || '-'}</p>
                     <p><strong>ç­çº§ï¼š</strong>${user.className || '-'}</p>`;
                } else if (user.userType === 'TEACHER') {
                    html += `<hr>
                     <p><strong>å·¥å·ï¼š</strong>${user.teacherId || '-'}</p>
                     <p><strong>èŒç§°ï¼š</strong>${user.title || '-'}</p>`;
                } else if (user.userType === 'ADMIN') {
                    html += `<hr><p>ç®¡ç†å‘˜ç”¨æˆ·ï¼Œæ— é¢å¤–ä¿¡æ¯</p>`;
                }

                html += `<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;">
                         <button onclick="goToAppointment()">è¿›å…¥é¢„çº¦æ¨¡å—</button>
                         <button onclick="goToClassroom()">æ•™å®¤ç³»ç»Ÿ</button>
                         <button onclick="goToCourse()">è¯¾ç¨‹ç®¡ç†</button>
                         <button onclick="openChangePassword()">ä¿®æ”¹å¯†ç </button>
                         <button onclick="goTotimetable()">æ’è¯¾ç³»ç»Ÿ</button>
                         <button onclick="goToSyllabus()">è¯¾ç¨‹å¤§çº²</button>
                         <button onclick="goToGrade()">æˆç»©ç®¡ç†</button>
                         <button onclick="goToFinance()">è´¢åŠ¡ç®¡ç†</button>`;

                if (user.userType === 'ADMIN') {
                    html += `<button onclick="goToRegister()">æ³¨å†Œæ–°ç”¨æˆ·</button>
                             <button onclick="openResetPassword()">é‡ç½®ç”¨æˆ·å¯†ç </button>`;
                }

                if (user.userType === 'STUDENT') {
                    html += `<button onclick="goToCourseSelection()">å­¦ç”Ÿé€‰è¯¾ç³»ç»Ÿ</button>
                             <button onclick="goToStimetable()">å­¦ç”Ÿè¯¾è¡¨</button>`;
                }
                if (user.userType === 'TEACHER') {
                    html += `<button onclick="goToTtimetable()">æ•™å¸ˆè¯¾è¡¨</button>`;
                }

                html += `</div>`;

                div.innerHTML = html;
                
                // æ ¹æ®ç”¨æˆ·ç±»å‹æ˜¾ç¤º/éšè—ä¾§è¾¹æ èœå•é¡¹
                updateSidebarMenu(user.userType);
            })
            .catch(err => {
                console.error(err);
                document.getElementById('user-info').innerHTML = `<p style="color: #ef4444;">è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥</p>`;
            });
    }
    
    // æ ¹æ®ç”¨æˆ·ç±»å‹æ›´æ–°ä¾§è¾¹æ èœå•
    function updateSidebarMenu(userType) {
        // éšè—æ‰€æœ‰ç‰¹å®šè§’è‰²çš„èœå•é¡¹
        document.querySelectorAll('.admin-only, .student-only, .teacher-only').forEach(item => {
            item.style.display = 'none';
        });
        
        // æ ¹æ®ç”¨æˆ·ç±»å‹æ˜¾ç¤ºç›¸åº”çš„èœå•é¡¹
        if (userType === 'ADMIN') {
            document.querySelectorAll('.admin-only').forEach(item => {
                item.style.display = 'block';
            });
        } else if (userType === 'STUDENT') {
            document.querySelectorAll('.student-only').forEach(item => {
                item.style.display = 'block';
            });
        } else if (userType === 'TEACHER') {
            document.querySelectorAll('.teacher-only').forEach(item => {
                item.style.display = 'block';
            });
        }
    }

    function goToAppointment() { window.location.href = '../classroom/appointment.html'; }
    function goToRegister() { window.location.href = '../auth/register.html'; }
    function goToClassroom() { window.location.href = '../classroom/classroom.html'; }
    function goToCourse() {window.location.href = '../course/course.html';}
    function goToCourseSelection() {window.location.href = '../course/courseselection.html';}
    function goTotimetable() {window.location.href = '../timetable/timetable.html';}
    function goToTtimetable() {window.location.href = '../timetable/teachertimetable.html';}
    function goToStimetable() {window.location.href = '../timetable/studenttimetable.html';}
    function goToSyllabus() {window.location.href = '../course/syllabus.html';}
    function goToGrade() {window.location.href = '../grade/grade-index.html';}
    function goToFinance() {window.location.href = '../finance/finance-index.html';}

    function openChangePassword() { document.getElementById('changePasswordModal').style.display = 'flex'; }
    function closeChangePassword() {
        document.getElementById('changePasswordModal').style.display = 'none';
        document.getElementById('changePasswordMsg').innerText = '';
    }
    function submitChangePassword() {
        const oldPwd = document.getElementById('oldPassword').value;
        const newPwd = document.getElementById('newPassword').value;
        apiRequest(`${API_ENDPOINTS.CHANGE_PASSWORD}?userId=${currentUser.id}&oldPassword=${oldPwd}&newPassword=${newPwd}`, {
            method: 'POST'
        })
            .then(resp => resp.text())
            .then(msg => {
                document.getElementById('changePasswordMsg').innerText = msg;
                showToast(msg);
            })
            .catch(err => {
                document.getElementById('changePasswordMsg').innerText = 'ä¿®æ”¹å¤±è´¥';
                showToast('ä¿®æ”¹å¤±è´¥');
                console.error(err);
            });
    }

    function openResetPassword() { document.getElementById('resetPasswordModal').style.display = 'flex'; }
    function closeResetPassword() {
        document.getElementById('resetPasswordModal').style.display = 'none';
        document.getElementById('resetPasswordMsg').innerText = '';
    }
    function submitResetPassword() {
        const username = document.getElementById('resetUsername').value;
        const newPwd = document.getElementById('resetNewPassword').value;
        apiRequest(`${API_ENDPOINTS.RESET_PASSWORD}?username=${username}&newPassword=${newPwd}`, {
            method: 'POST'
        })
            .then(resp => resp.text())
            .then(msg => {
                document.getElementById('resetPasswordMsg').innerText = msg;
                showToast(msg);
            })
            .catch(err => {
                document.getElementById('resetPasswordMsg').innerText = 'é‡ç½®å¤±è´¥';
                showToast('é‡ç½®å¤±è´¥');
                console.error(err);
            });
    }

    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);
    }

    function toggleTheme() {
        document.body.classList.toggle("light");
        localStorage.setItem(
            "theme",
            document.body.classList.contains("light") ? "light" : "dark"
        );
    }

    if (localStorage.getItem("theme") === "light") {
        document.body.classList.add("light");
    }
</script>

</body>
</html>