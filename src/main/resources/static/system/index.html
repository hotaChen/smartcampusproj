<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>首页 - Egg University</title>

    <!-- 全局样式 -->
    <link rel="stylesheet" href="/css/style.css?v=egg-final">
    <link rel="stylesheet" href="/css/index.css?v=egg-final">
    <link rel="stylesheet" href="/css/sidebar.css?v=egg-final">
    
    <style>
        .user-info-header {
            position: fixed;
            top: 20px;
            right: 80px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.08);
            border-radius: 30px;
            backdrop-filter: blur(10px);
        }
        .user-info-header[data-hidden="true"] {
            display: none !important;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fde68a, #f59e0b);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: #3a2a14;
        }
        .user-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: #fff7ed;
        }
        .user-dept {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
        }
    </style>
</head>
<body>

<!-- 粒子背景 -->
<canvas id="bg"></canvas>

<script src="/js/api.js"></script>
<script src="/js/particles.js?v=egg-final"></script>
<script src="/js/sidebar.js"></script>
<script src="/js/egg.js"></script>
<script src="/js/header.js"></script>

<div id="header-container"></div>

<div class="login-box card">
    <div class="user-info" id="user-info" style="width: 100%;">
        <p>正在加载用户信息...</p>
    </div>
</div>

<div id="toast" class="toast"></div>

<!-- 修改密码弹窗 -->
<div class="modal" id="changePasswordModal">
    <div class="modal-content card">
        <h3>修改密码</h3>
        <input type="password" id="oldPassword" placeholder="旧密码" class="input"><br>
        <input type="password" id="newPassword" placeholder="新密码" class="input"><br>
        <button class="btn" onclick="submitChangePassword()">提交</button>
        <button class="btn" onclick="closeChangePassword()" style="margin-top: 10px; background: rgba(255,255,255,0.2);">取消</button>
        <p id="changePasswordMsg"></p>
    </div>
</div>

<!-- 管理员重置密码弹窗 -->
<div class="modal" id="resetPasswordModal">
    <div class="modal-content card">
        <h3>重置用户密码（管理员）</h3>
        <input type="text" id="resetUsername" placeholder="用户名" class="input"><br>
        <input type="password" id="resetNewPassword" placeholder="新密码" class="input"><br>
        <button class="btn" onclick="submitResetPassword()">提交</button>
        <button class="btn" onclick="closeResetPassword()" style="margin-top: 10px; background: rgba(255,255,255,0.2);">取消</button>
        <p id="resetPasswordMsg"></p>
    </div>
</div>

<script>
    const font = new FontFace('Maobi', 'url(/fonts/Maobi.ttf)');
    font.load().then(function(loadedFont) {
        document.fonts.add(loadedFont);
        const canvas = document.getElementById('school-title');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 150, 50);
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            ctx.font = 'bold 32px Maobi';
            ctx.fillStyle = '#F59E0B';
            ctx.fillText('鸡蛋大学', 0, 25);
        }
    }).catch(e => console.error('字体加载失败', e));
    
    const token = localStorage.getItem('token');
    let currentUser = null;

    if (!token) {
        document.getElementById('user-info').innerHTML = '<p style="color: #ef4444;">未检测到登录信息，请重新登录</p>';
    } else {
        apiRequest(API_ENDPOINTS.USER_INFO + `?token=${token}`)
            .then(resp => resp.json())
            .then(user => {
                currentUser = user;
                const div = document.getElementById('user-info');
                let html = `<h2>用户信息</h2>
                        <p><strong>用户名：</strong>${user.username}</p>
                        <p><strong>真实姓名：</strong>${user.realName}</p>
                        <p><strong>邮箱：</strong>${user.email || '-'}</p>
                        <p><strong>电话：</strong>${user.phone || '-'}</p>
                        <p><strong>身份：</strong>${user.userType}</p>`;

                if (user.userType === 'STUDENT') {
                    html += `<hr>
                     <p><strong>学号：</strong>${user.studentId || '-'}</p>
                     <p><strong>院系：</strong>${user.department || '-'}</p>
                     <p><strong>专业：</strong>${user.major || '-'}</p>
                     <p><strong>年级：</strong>${user.grade || '-'}</p>
                     <p><strong>班级：</strong>${user.className || '-'}</p>`;
                } else if (user.userType === 'TEACHER') {
                    html += `<hr>
                     <p><strong>工号：</strong>${user.teacherId || '-'}</p>
                     <p><strong>职称：</strong>${user.title || '-'}</p>`;
                } else if (user.userType === 'ADMIN') {
                    html += `<hr><p>管理员用户，无额外信息</p>`;
                }

                html += `<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;">
                         <button onclick="goToAppointment()">进入预约模块</button>
                         <button onclick="goToClassroom()">教室系统</button>
                         <button onclick="goToCourse()">课程管理</button>
                         <button onclick="openChangePassword()">修改密码</button>
                         <button onclick="goTotimetable()">排课系统</button>
                         <button onclick="goToSyllabus()">课程大纲</button>
                         <button onclick="goToGrade()">成绩管理</button>
                         <button onclick="goToFinance()">财务管理</button>`;

                if (user.userType === 'ADMIN') {
                    html += `<button onclick="goToRegister()">注册新用户</button>
                             <button onclick="openResetPassword()">重置用户密码</button>`;
                }

                if (user.userType === 'STUDENT') {
                    html += `<button onclick="goToCourseSelection()">学生选课系统</button>
                             <button onclick="goToStimetable()">学生课表</button>`;
                }
                if (user.userType === 'TEACHER') {
                    html += `<button onclick="goToTtimetable()">教师课表</button>`;
                }

                html += `</div>`;

                div.innerHTML = html;
            })
            .catch(err => {
                console.error(err);
                document.getElementById('user-info').innerHTML = `<p style="color: #ef4444;">获取用户信息失败</p>`;
            });
    }

    function goToAppointment() { window.location.href = '../classroom/appointment.html'; }
    function goToRegister() { window.location.href = '../auth/register.html'; }
    function goToClassroom() { window.location.href = '../classroom/classroom.html'; }
    function goToCourse() {window.location.href = '../course/course.html';}
    function goToCourseSelection() {window.location.href = '../course/courseselection.html';}
    function goTotimetable() {window.location.href = '../timetable/timetable.html';}
    function goToTtimetable() {window.location.href = '../timetable/teachertimetable.html';}
    function goToStimetable() {window.location.href = '../timetable/studenttimetable.html';}
    function goToSyllabus() {window.location.href = '../course/syllabus.html';}
    function goToGrade() {window.location.href = '../grade/grade-index.html';}
    function goToFinance() {window.location.href = '../finance/finance-index.html';}

    function openChangePassword() { document.getElementById('changePasswordModal').style.display = 'flex'; }
    function closeChangePassword() {
        document.getElementById('changePasswordModal').style.display = 'none';
        document.getElementById('changePasswordMsg').innerText = '';
    }
    function submitChangePassword() {
        const oldPwd = document.getElementById('oldPassword').value;
        const newPwd = document.getElementById('newPassword').value;
        apiRequest(`${API_ENDPOINTS.CHANGE_PASSWORD}?userId=${currentUser.id}&oldPassword=${oldPwd}&newPassword=${newPwd}`, {
            method: 'POST'
        })
            .then(resp => resp.text())
            .then(msg => {
                document.getElementById('changePasswordMsg').innerText = msg;
                showToast(msg);
            })
            .catch(err => {
                document.getElementById('changePasswordMsg').innerText = '修改失败';
                showToast('修改失败');
                console.error(err);
            });
    }

    function openResetPassword() { document.getElementById('resetPasswordModal').style.display = 'flex'; }
    function closeResetPassword() {
        document.getElementById('resetPasswordModal').style.display = 'none';
        document.getElementById('resetPasswordMsg').innerText = '';
    }
    function submitResetPassword() {
        const username = document.getElementById('resetUsername').value;
        const newPwd = document.getElementById('resetNewPassword').value;
        apiRequest(`${API_ENDPOINTS.RESET_PASSWORD}?username=${username}&newPassword=${newPwd}`, {
            method: 'POST'
        })
            .then(resp => resp.text())
            .then(msg => {
                document.getElementById('resetPasswordMsg').innerText = msg;
                showToast(msg);
            })
            .catch(err => {
                document.getElementById('resetPasswordMsg').innerText = '重置失败';
                showToast('重置失败');
                console.error(err);
            });
    }

    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);
    }

    function toggleTheme() {
        document.body.classList.toggle("light");
        localStorage.setItem(
            "theme",
            document.body.classList.contains("light") ? "light" : "dark"
        );
    }

    if (localStorage.getItem("theme") === "light") {
        document.body.classList.add("light");
    }

    document.addEventListener('DOMContentLoaded', function() {
        SidebarManager.init({ currentPage: 'home' });
        HeaderComponent.init();
        loadHeaderUserInfo();
    });
    
    function loadHeaderUserInfo() {
        const token = localStorage.getItem('token');
        if (!token) return;
        
        const userInfoHeader = document.getElementById('user-info-header');
        if (!userInfoHeader) {
            setTimeout(loadHeaderUserInfo, 100);
            return;
        }
        
        apiRequest(API_ENDPOINTS.USER_INFO + `?token=${token}`)
            .then(resp => resp.json())
            .then(user => {
                const avatarText = document.getElementById('avatar-text');
                const userName = document.getElementById('user-name');
                const userDept = document.getElementById('user-dept');
                
                const displayName = user.realName || user.username;
                if (avatarText) avatarText.textContent = displayName.charAt(0).toUpperCase();
                if (userName) userName.textContent = displayName;
                
                let deptText = '';
                if (user.userType === 'STUDENT') {
                    deptText = user.department || '';
                } else if (user.userType === 'TEACHER') {
                    deptText = user.department || '';
                } else if (user.userType === 'ADMIN') {
                    deptText = '管理员';
                }
                if (userDept) userDept.textContent = deptText;
            })
            .catch(err => console.error(err));
    }
</script>

</body>
</html>