<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>成绩统计</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">成绩统计</h1>
    
    <div class="toolbar">
        <div class="search-box">
            <input type="text" id="statsStudentId" placeholder="请输入学号">
            <input type="text" id="statsSemester" value="2023-2024-1" placeholder="学期">
            <input type="text" id="statsCourseCode" placeholder="课程代码">
        </div>
        <button class="btn primary" onclick="calculateStudentAverage()">计算学生平均分</button>
        <button class="btn secondary" onclick="calculateCourseAverage()">计算课程平均分</button>
    </div>
    
    <div id="message" class="message" style="display: none;"></div>
    
    <div id="statsResult" class="stats-container" style="display: none;">
        <!-- 统计结果将通过JavaScript动态填充 -->
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    SidebarManager.init({ currentPage: 'grade-stats' });
    getUserInfo();
});

// 获取用户信息
function getUserInfo() {
    apiRequest(API_ENDPOINTS.USER_INFO)
    .then(resp => resp.json())
    .then(data => {
        if (data.userType === 'STUDENT') {
            document.getElementById('statsStudentId').value = data.studentId;
            document.getElementById('statsStudentId').readOnly = true;
            document.getElementById('statsCourseCode').parentElement.style.display = 'none';
            document.querySelector('button[onclick="calculateCourseAverage()"]').style.display = 'none';
            calculateStudentAverage();
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('获取用户信息失败，请刷新页面重试', true);
    });
}

// 显示消息
function showMessage(message, isError = false) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = message;
    messageDiv.className = isError ? 'message error' : 'message success';
    messageDiv.style.display = 'block';
    
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 3000);
}

// 计算学生平均分
function calculateStudentAverage() {
    const studentId = document.getElementById('statsStudentId').value;
    const semester = document.getElementById('statsSemester').value;
    
    if (!studentId) {
        showMessage('请输入学号', true);
        return;
    }
    
    apiRequest(`${API_ENDPOINTS.GRADES}/student/number/${studentId}/average/${semester}`)
    .then(resp => resp.json())
    .then(data => {
        const resultDiv = document.getElementById('statsResult');
        resultDiv.style.display = 'block';
        
        let averageScore = data;
        if (data && data.code === 200 && data.data) {
            averageScore = data.data;
        }
        
        if (averageScore !== null && averageScore !== undefined) {
            resultDiv.innerHTML = `
                <div class="stats-card">
                    <h3>学生成绩统计</h3>
                    <p><strong>学号:</strong> <span class="stat-value">${studentId}</span></p>
                    <p><strong>学期:</strong> <span class="stat-value">${semester}</span></p>
                    <p><strong>平均分:</strong> <span class="stat-highlight">${Number(averageScore).toFixed(2)}</span></p>
                    <p><strong>最高分:</strong> <span class="stat-value">-</span></p>
                    <p><strong>最低分:</strong> <span class="stat-value">-</span></p>
                    <p><strong>课程数:</strong> <span class="stat-value">-</span></p>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `<div class="stats-card"><p>未找到该学生的成绩记录</p></div>`;
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('计算失败: ' + err.message, true);
    });
}

// 计算课程平均分
function calculateCourseAverage() {
    const courseCode = document.getElementById('statsCourseCode').value;
    const semester = document.getElementById('statsSemester').value;
    
    if (!courseCode) {
        showMessage('请输入课程代码', true);
        return;
    }
    
    apiRequest(`${API_ENDPOINTS.GRADES}/course/${courseCode}/average/${semester}`)
    .then(resp => resp.json())
    .then(data => {
        const resultDiv = document.getElementById('statsResult');
        resultDiv.style.display = 'block';
        
        if (data.code === 200 && data.data) {
            resultDiv.innerHTML = `
                <div class="stats-card">
                    <h3>课程成绩统计</h3>
                    <p><strong>课程代码:</strong> <span class="stat-value">${courseCode}</span></p>
                    <p><strong>学期:</strong> <span class="stat-value">${semester}</span></p>
                    <p><strong>平均分:</strong> <span class="stat-highlight">${data.data.averageScore.toFixed(2)}</span></p>
                    <p><strong>最高分:</strong> <span class="stat-value">${data.data.maxScore}</span></p>
                    <p><strong>最低分:</strong> <span class="stat-value">${data.data.minScore}</span></p>
                    <p><strong>学生数:</strong> <span class="stat-value">${data.data.studentCount}</span></p>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `<div class="stats-card"><p>未找到该课程的成绩记录</p></div>`;
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('计算失败: ' + err.message, true);
    });
}
</script>
</body>
</html>