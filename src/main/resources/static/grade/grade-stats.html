<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>成绩统计</title>
</head>
<body>
    <h1>成绩统计</h1>
    <div>
        <a href="grade-index.html">返回成绩管理</a> |
        <a href="grade-entry.html">成绩录入</a> |
        <a href="grade-query.html">成绩查询</a> |
        <a href="grade-report.html">成绩单生成</a> |
        <a href="makeup-exam.html">补考管理</a> |
        <a href="../index.html">返回首页</a>
    </div>
    
    <div id="message" class="message" style="display: none;"></div>
    
    <h2>成绩统计</h2>
    
    <div class="form-row">
        <div class="form-group">
            <label for="statsStudentId">学号:</label>
            <input type="text" id="statsStudentId">
        </div>
        <div class="form-group">
            <label for="statsSemester">学期:</label>
            <input type="text" id="statsSemester" value="2023-2024-1">
        </div>
        <div class="form-group">
            <label for="statsCourseCode">课程代码:</label>
            <input type="text" id="statsCourseCode">
        </div>
    </div>
    
    <button onclick="calculateStudentAverage()">计算学生平均分</button>
    <button onclick="calculateCourseAverage()">计算课程平均分</button>
    
    <div id="statsResult" class="stats-container" style="display: none;">
        <!-- 统计结果将通过JavaScript动态填充 -->
    </div>

<script src="../js/api.js"></script>
<script>
// 页面加载时获取用户信息
document.addEventListener('DOMContentLoaded', function() {
    getUserInfo();
});

// 获取用户信息
function getUserInfo() {
    apiRequest(API_ENDPOINTS.USER_INFO)
    .then(resp => resp.json())
    .then(data => {
        if (data.userType === 'STUDENT') {
            // 如果是学生，隐藏学生ID输入框并自动填充
            document.getElementById('statsStudentId').value = data.studentId;
            document.getElementById('statsStudentId').readOnly = true;
            
            // 隐藏课程代码输入框，因为学生不应该查看课程统计
            document.getElementById('statsCourseCode').parentElement.style.display = 'none';
            
            // 隐藏"计算课程平均分"按钮，因为这是教师/管理员功能
            document.querySelector('button[onclick="calculateCourseAverage()"]').style.display = 'none';
            
            // 自动计算该学生的平均分
            calculateStudentAverage();
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('获取用户信息失败，请刷新页面重试', true);
    });
}

// 显示消息
function showMessage(message, isError = false) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = message;
    messageDiv.className = isError ? 'message error' : 'message success';
    messageDiv.style.display = 'block';
    
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 3000);
}

// 计算学生平均分
function calculateStudentAverage() {
    const studentNumber = document.getElementById('statsStudentId').value;
    const semester = document.getElementById('statsSemester').value;
    
    if (!studentNumber) {
        showMessage('请输入学号', true);
        return;
    }
    
    if (!semester) {
        showMessage('请输入学期', true);
        return;
    }
    
    // 使用成绩报告API获取完整的统计信息
    const url = semester ? 
        `${API_ENDPOINTS.GRADES_REPORT_BY_STUDENT_NUMBER(studentNumber)}?semester=${semester}` :
        API_ENDPOINTS.GRADES_REPORT_BY_STUDENT_NUMBER(studentNumber);
    
    apiRequest(url)
    .then(resp => resp.json())
    .then(data => {
        displayStudentStats(data, studentNumber, semester);
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('获取学生成绩统计失败', true);
    });
}

// 计算课程平均分
function calculateCourseAverage() {
    const courseCode = document.getElementById('statsCourseCode').value;
    const semester = document.getElementById('statsSemester').value;
    
    if (!courseCode) {
        showMessage('请输入课程代码', true);
        return;
    }
    
    if (!semester) {
        showMessage('请输入学期', true);
        return;
    }
    
    apiRequest(API_ENDPOINTS.GRADES_COURSE_AVERAGE(courseCode, semester))
    .then(resp => resp.json())
    .then(data => {
        displayCourseStats(data, courseCode, semester);
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('计算课程平均分失败', true);
    });
}

// 显示学生统计结果
function displayStudentStats(data, studentNumber, semester) {
    const statsResult = document.getElementById('statsResult');
    statsResult.style.display = 'block';
    
    // 成绩报告API返回的是完整的GradeReportDTO对象
    statsResult.innerHTML = `
        <div class="stats-card">
            <h3>学生成绩统计</h3>
            <p><strong>学号:</strong> ${studentNumber}</p>
            <p><strong>学期:</strong> ${semester || '全部学期'}</p>
            <p><strong>平均分:</strong> ${data.averageScore || '无数据'}</p>
            <p><strong>总学分:</strong> ${data.totalCredits || '无数据'}</p>
            <p><strong>已获得学分:</strong> ${data.totalCredits || '无数据'}</p>
            <p><strong>课程数量:</strong> ${data.totalCourses || '无数据'}</p>
            <p><strong>最高分:</strong> ${getHighestScore(data.courseGrades) || '无数据'}</p>
            <p><strong>最低分:</strong> ${getLowestScore(data.courseGrades) || '无数据'}</p>
            <p><strong>通过课程数:</strong> ${data.passedCourses || '无数据'}</p>
            <p><strong>不通过课程数:</strong> ${data.failedCourses || '无数据'}</p>
            <p><strong>通过率:</strong> ${data.passRate ? (data.passRate).toFixed(2) + '%' : '无数据'}</p>
        </div>
    `;
}

// 获取最高分
function getHighestScore(courseGrades) {
    if (!courseGrades || courseGrades.length === 0) {
        return null;
    }
    
    let highest = 0;
    for (const grade of courseGrades) {
        if (grade.score && grade.score > highest) {
            highest = grade.score;
        }
    }
    return highest > 0 ? highest : null;
}

// 获取最低分
function getLowestScore(courseGrades) {
    if (!courseGrades || courseGrades.length === 0) {
        return null;
    }
    
    let lowest = 100;
    for (const grade of courseGrades) {
        if (grade.score && grade.score < lowest) {
            lowest = grade.score;
        }
    }
    return lowest < 100 ? lowest : null;
}

// 显示课程统计结果
function displayCourseStats(data, courseCode, semester) {
    const statsResult = document.getElementById('statsResult');
    statsResult.style.display = 'block';
    
    // API返回的是简单的Float值，需要适配显示
    const averageScore = typeof data === 'number' ? data : (data.averageScore || '无数据');
    
    statsResult.innerHTML = `
        <div class="stats-card">
            <h3>课程成绩统计</h3>
            <p><strong>课程代码:</strong> ${courseCode}</p>
            <p><strong>学期:</strong> ${semester}</p>
            <p><strong>平均分:</strong> ${averageScore}</p>
            <p><strong>学生人数:</strong> 无数据</p>
            <p><strong>最高分:</strong> 无数据</p>
            <p><strong>最低分:</strong> 无数据</p>
            <p><strong>及格率:</strong> 无数据</p>
            <p><strong>优秀率:</strong> 无数据</p>
        </div>
    `;
}
</script>
</body>
</html>