<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¥è€ƒç®¡ç†</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">è¡¥è€ƒç®¡ç†</h1>
    
    <div class="toolbar">
        <div class="search-box">
            <input type="text" id="makeupStudentId" placeholder="è¯·è¾“å…¥å­¦å·">
            <input type="text" id="makeupCourseCode" placeholder="è¯¾ç¨‹ä»£ç ">
            <input type="text" id="makeupSemester" value="2023-2024-1" placeholder="å­¦æœŸ">
        </div>
        <button class="btn primary" onclick="queryMakeupExams()">æŸ¥è¯¢è¡¥è€ƒå®‰æ’</button>
        <button class="btn secondary" onclick="queryMyMakeupExams()">æŸ¥è¯¢æˆ‘çš„è¡¥è€ƒ</button>
        <button class="btn primary" onclick="showScheduleForm()">å®‰æ’è¡¥è€ƒ</button>
        <button class="btn secondary" onclick="showGradeForm()">å½•å…¥è¡¥è€ƒæˆç»©</button>
    </div>
    
    <div id="message" class="message" style="display: none;"></div>
    
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>å­¦å·</th>
                <th>è¯¾ç¨‹ä»£ç </th>
                <th>è¯¾ç¨‹åç§°</th>
                <th>åŸæˆç»©</th>
                <th>è¡¥è€ƒæ—¶é—´</th>
                <th>è¡¥è€ƒåœ°ç‚¹</th>
                <th>è¡¥è€ƒæˆç»©</th>
                <th>çŠ¶æ€</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="makeupExamTableBody">
        </tbody>
    </table>
    
    <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-state-icon">ğŸ“‹</div>
        <div class="empty-state-text">æœªæ‰¾åˆ°è¡¥è€ƒè®°å½•</div>
    </div>
    
    <div id="makeupExamModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">å®‰æ’è¡¥è€ƒ</h3>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="scheduleStudentId">å­¦å·:</label>
                    <input type="text" id="scheduleStudentId" required>
                </div>
                <div class="form-group">
                    <label for="scheduleCourseCode">è¯¾ç¨‹ä»£ç :</label>
                    <input type="text" id="scheduleCourseCode" required>
                </div>
                <div class="form-group">
                    <label for="scheduleCourseName">è¯¾ç¨‹åç§°:</label>
                    <input type="text" id="scheduleCourseName" required>
                </div>
                <div class="form-group">
                    <label for="originalExamDate">åŸå§‹è€ƒè¯•æ—¥æœŸ:</label>
                    <input type="date" id="originalExamDate" required>
                </div>
                <div class="form-group">
                    <label for="originalExamLocation">åŸå§‹è€ƒè¯•åœ°ç‚¹:</label>
                    <input type="text" id="originalExamLocation" required>
                </div>
                <div class="form-group">
                    <label for="originalGrade">åŸå§‹æˆç»©ç­‰çº§:</label>
                    <select id="originalGrade" required>
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="F">F</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="semester">å­¦æœŸ:</label>
                    <input type="text" id="semester" placeholder="å¦‚: 2023-2024-1" required>
                </div>
                <div class="form-group">
                    <label for="makeupDate">è¡¥è€ƒæ—¥æœŸ:</label>
                    <input type="date" id="makeupDate" required>
                </div>
                <div class="form-group">
                    <label for="makeupTime">è¡¥è€ƒæ—¶é—´:</label>
                    <input type="text" id="makeupTime" placeholder="å¦‚: 14:30" required 
                           pattern="[0-2][0-9]:[0-5][0-9]"
                           oninput="formatTimeInput(this)"
                           style="width: 100%; height: 42px; padding: 0 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: var(--text); font-size: 14px; box-sizing: border-box;">
                </div>
                <div class="form-group">
                    <label for="makeupLocation">è¡¥è€ƒåœ°ç‚¹:</label>
                    <input type="text" id="makeupLocation" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn primary" onclick="saveMakeupExam()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <div id="makeupGradeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å½•å…¥è¡¥è€ƒæˆç»©</h3>
                <span class="modal-close" onclick="closeGradeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="gradeMakeupId">è¡¥è€ƒID:</label>
                    <input type="text" id="gradeMakeupId" readonly>
                </div>
                <div class="form-group">
                    <label for="makeupScore">è¡¥è€ƒåˆ†æ•°:</label>
                    <input type="number" id="makeupScore" min="0" max="100" step="0.1" required>
                </div>
                <div class="form-group">
                    <label for="makeupGradeLevel">æˆç»©ç­‰çº§:</label>
                    <select id="makeupGradeLevel">
                        <option value="ä¼˜ç§€">ä¼˜ç§€</option>
                        <option value="è‰¯å¥½">è‰¯å¥½</option>
                        <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                        <option value="åŠæ ¼">åŠæ ¼</option>
                        <option value="ä¸åŠæ ¼">ä¸åŠæ ¼</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeGradeModal()">å–æ¶ˆ</button>
                <button class="btn primary" onclick="saveMakeupGrade()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<style>
.toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 24px;
    align-items: center;
}

.toolbar .search-box {
    display: flex;
    gap: 8px;
    flex: 1;
    max-width: 500px;
}

.toolbar .search-box input {
    flex: 1;
    height: 42px;
    padding: 0 14px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: var(--text);
    font-size: 14px;
    transition: all 0.2s ease;
}

.toolbar .search-box input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(245,158,11,0.2);
}

.toolbar .btn {
    height: 42px;
    padding: 0 24px;
    font-size: 14px;
    border-radius: 10px;
    font-weight: 600;
}

.toolbar .btn.primary {
    background: linear-gradient(135deg, #fde68a, #f59e0b);
    color: #1a1a1a;
}

.toolbar .btn.secondary {
    background: rgba(255,255,255,0.15);
    color: var(--text);
}

.toolbar .btn.secondary:hover {
    background: rgba(255,255,255,0.25);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--card);
    backdrop-filter: blur(18px);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.data-table th,
.data-table td {
    padding: 14px 18px;
    text-align: left;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.data-table th {
    background: rgba(245,158,11,0.15);
    font-weight: 600;
    color: var(--primary);
    font-size: 14px;
}

.data-table td {
    font-size: 14px;
    color: var(--text);
}

.data-table tbody tr {
    transition: background 0.2s ease;
    cursor: pointer;
}

.data-table tbody tr:hover {
    background: rgba(255,255,255,0.05);
}

.data-table tbody tr.selected {
    background: rgba(245, 158, 11, 0.15);
    border-left: 3px solid var(--primary);
}

.data-table .btn {
    height: 32px;
    padding: 0 12px;
    font-size: 12px;
    border-radius: 6px;
    margin-right: 6px;
    border: none;
    background: rgba(255, 255, 255, 0.15);
    color: var(--text);
    outline: none;
}

.data-table .btn:focus {
    outline: none;
}

.data-table .btn:last-child {
    margin-right: 0;
}

.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.modal-content {
    background: var(--card);
    backdrop-filter: blur(18px);
    border-radius: 16px;
    width: 90%;
    max-width: 480px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--primary);
}

.modal-close {
    font-size: 24px;
    cursor: pointer;
    color: var(--text);
    opacity: 0.6;
    transition: opacity 0.2s;
}

.modal-close:hover {
    opacity: 1;
}

.modal-body {
    padding: 24px;
}

.modal-body .form-group {
    margin-bottom: 16px;
}

.modal-body .form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
}

.modal-body .form-group input,
.modal-body .form-group select {
    width: 100%;
    height: 42px;
    padding: 0 14px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: var(--text);
    font-size: 14px;
    box-sizing: border-box;
}

.modal-body .form-group input:focus,
.modal-body .form-group select:focus {
    outline: none;
    border-color: var(--primary);
}

.modal-body .form-group input[type="time"] {
    -webkit-appearance: none;
    appearance: none;
    pointer-events: auto;
    cursor: pointer;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px 24px;
    border-top: 1px solid rgba(255,255,255,0.1);
}

.modal-footer .btn {
    height: 40px;
    padding: 0 20px;
    font-size: 14px;
    border-radius: 8px;
    font-weight: 500;
}

.modal-footer .btn.primary {
    background: linear-gradient(135deg, #fde68a, #f59e0b);
    color: #1a1a1a;
}

.modal-footer .btn.secondary {
    background: rgba(255,255,255,0.15);
    color: var(--text);
}

.empty-state {
    background: var(--card);
    backdrop-filter: blur(18px);
    border-radius: 16px;
    padding: 60px 40px;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 16px;
}

.empty-state-text {
    font-size: 16px;
    color: var(--text);
    opacity: 0.7;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    SidebarManager.init({ currentPage: 'makeup-exam' });
    getUserInfo();
});

function getUserInfo() {
    const token = localStorage.getItem('token');
    apiRequest(API_ENDPOINTS.USER_INFO + `?token=${token}`)
    .then(resp => resp.json())
    .then(data => {
        currentUserInfo = data;
        if (data.userType === 'STUDENT') {
            document.getElementById('makeupStudentId').parentElement.style.display = 'none';
            document.querySelector('button[onclick="queryMakeupExams()"]').style.display = 'none';
            document.querySelector('button[onclick="showScheduleForm()"]').style.display = 'none';
            document.querySelector('button[onclick="showGradeForm()"]').style.display = 'none';
            queryMyMakeupExams();
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
    });
}

function showMessage(message, isError = false) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = message;
    messageDiv.className = isError ? 'message error' : 'message success';
    messageDiv.style.display = 'block';
    
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 3000);
}

function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

function queryMakeupExams() {
    const studentId = document.getElementById('makeupStudentId').value;
    const courseCode = document.getElementById('makeupCourseCode').value;
    const semester = document.getElementById('makeupSemester').value;
    
    let url = `${API_ENDPOINTS.MAKEUP_EXAMS}?semester=${semester}`;
    if (studentId) url += `&studentId=${studentId}`;
    if (courseCode) url += `&courseCode=${courseCode}`;
    
    apiRequest(url)
    .then(resp => resp.json())
    .then(data => {
        renderMakeupExams(data);
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('æŸ¥è¯¢å¤±è´¥: ' + err.message, true);
    });
}

function queryMyMakeupExams() {
    apiRequest(API_ENDPOINTS.MY_MAKEUP_EXAMS)
    .then(resp => resp.json())
    .then(data => {
        renderMakeupExams(data);
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('æŸ¥è¯¢å¤±è´¥: ' + err.message, true);
    });
}

function renderMakeupExams(data) {
    const tbody = document.querySelector('#makeupExamTableBody');
    const emptyState = document.getElementById('emptyState');
    tbody.innerHTML = '';
    
    let examList = [];
    if (Array.isArray(data)) {
        examList = data;
    } else if (data.code === 200 && data.data && Array.isArray(data.data)) {
        examList = data.data;
    }
    
    if (examList.length > 0) {
        examList.forEach(exam => {
            const studentId = exam.student && exam.student.studentId ? exam.student.studentId : (exam.studentId || '');
            const row = document.createElement('tr');
            row.onclick = function() {
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                } else {
                    document.querySelectorAll('#makeupExamTableBody tr').forEach(r => r.classList.remove('selected'));
                    this.classList.add('selected');
                }
            };
            row.innerHTML = `
                <td>${exam.id}</td>
                <td>${studentId}</td>
                <td>${exam.courseCode}</td>
                <td>${exam.courseName}</td>
                <td>${exam.originalGrade || '-'}</td>
                <td>${new Date(exam.makeupDate).toLocaleString()}</td>
                <td>${exam.makeupLocation}</td>
                <td>${exam.score || '-'}</td>
                <td>${exam.status}</td>
                <td>
                    ${exam.status === 'å¾…è€ƒ' ? '<button class="btn secondary" onclick="event.stopPropagation(); editMakeupExam(' + exam.id + ')">ç¼–è¾‘</button>' : ''}
                    <button class="btn secondary" onclick="event.stopPropagation(); deleteMakeupExam(' + exam.id + ')">åˆ é™¤</button>
                </td>
            `;
            tbody.appendChild(row);
        });
        emptyState.style.display = 'none';
    } else {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
    }
}

let currentUserInfo = null;
let currentEditId = null;

function showScheduleForm() {
    document.getElementById('modalTitle').textContent = 'å®‰æ’è¡¥è€ƒ';
    document.getElementById('scheduleStudentId').value = '';
    document.getElementById('scheduleCourseCode').value = '';
    document.getElementById('scheduleCourseName').value = '';
    document.getElementById('originalExamDate').value = '';
    document.getElementById('originalExamLocation').value = '';
    document.getElementById('originalGrade').value = '';
    document.getElementById('semester').value = '';
    document.getElementById('makeupDate').value = '';
    document.getElementById('makeupTime').value = '';
    document.getElementById('makeupLocation').value = '';
    currentEditId = null;
    document.getElementById('makeupExamModal').style.display = 'flex';
}

function showGradeForm() {
    const selectedExam = document.querySelector('#makeupExamTableBody tr.selected');
    if (!selectedExam) {
        showMessage('è¯·å…ˆé€‰æ‹©è¦å½•å…¥æˆç»©çš„è¡¥è€ƒè®°å½•', true);
        return;
    }
    const examId = selectedExam.querySelector('td').textContent;
    document.getElementById('gradeMakeupId').value = examId;
    document.getElementById('makeupScore').value = '';
    document.getElementById('makeupGradeLevel').value = 'åŠæ ¼';
    document.getElementById('makeupGradeModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('makeupExamModal').style.display = 'none';
}

function closeGradeModal() {
    document.getElementById('makeupGradeModal').style.display = 'none';
}

function formatTimeInput(input) {
    let value = input.value.replace(/[^0-9:]/g, '');
    
    if (value.length >= 2 && !value.includes(':')) {
        value = value.substring(0, 2) + ':' + value.substring(2);
    }
    
    if (value.length > 5) {
        value = value.substring(0, 5);
    }
    
    input.value = value;
}

async function saveMakeupExam() {
    const studentId = document.getElementById('scheduleStudentId').value;
    const courseCode = document.getElementById('scheduleCourseCode').value;
    const courseName = document.getElementById('scheduleCourseName').value;
    const originalExamDate = document.getElementById('originalExamDate').value;
    const originalExamLocation = document.getElementById('originalExamLocation').value;
    const originalGrade = document.getElementById('originalGrade').value;
    const semester = document.getElementById('semester').value;
    const makeupDate = document.getElementById('makeupDate').value;
    const makeupTimeInput = document.getElementById('makeupTime');
    let makeupTime = makeupTimeInput.value.trim();
    const makeupLocation = document.getElementById('makeupLocation').value;
    
    if (!studentId || !courseCode || !courseName || !originalExamDate || !originalExamLocation || !originalGrade || !semester || !makeupDate || !makeupTime || !makeupLocation) {
        showMessage('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', true);
        return;
    }
    
    const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
    if (!timeRegex.test(makeupTime)) {
        showMessage('è¯·è¾“å…¥æ­£ç¡®çš„æ—¶é—´æ ¼å¼ï¼Œå¦‚: 14:30', true);
        return;
    }
    
    try {
        const examData = {
            studentId: studentId,
            courseCode: courseCode,
            courseName: courseName,
            examDate: originalExamDate + 'T00:00:00',
            examLocation: originalExamLocation,
            originalGrade: originalGrade,
            semester: semester,
            makeupDate: makeupDate + 'T' + makeupTime + ':00',
            makeupLocation: makeupLocation
        };
        
        let response;
        let data;
        
        if (currentEditId) {
            response = await apiRequest(`${API_ENDPOINTS.MAKEUP_EXAMS}/${currentEditId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(examData)
            });
            data = await response.json();
            if (data.code === 200 || (data.id && response.ok)) {
                closeModal();
                currentEditId = null;
                showToast('è¡¥è€ƒä¿¡æ¯æ›´æ–°æˆåŠŸ');
                queryMakeupExams();
            } else {
                showMessage(data.message || 'æ›´æ–°å¤±è´¥', true);
            }
        } else {
            let originalGradeId = null;
            let teacherId = null;
            
            if (semester) {
                const gradeUrl = API_ENDPOINTS.GRADES_BY_STUDENT_NUMBER_COURSE_SEMESTER(studentId, courseCode, semester);
                const gradeResponse = await apiRequest(gradeUrl);
                const gradeData = await gradeResponse.json();
                
                if (gradeData && gradeData.length > 0) {
                    const grade = gradeData[0];
                    originalGradeId = grade.id;
                    if (grade.teacher && grade.teacher.id) {
                        teacherId = grade.teacher.id;
                    }
                }
            }
            
            if (!originalGradeId) {
                showMessage('æœªæ‰¾åˆ°è¯¥å­¦ç”Ÿçš„æˆç»©è®°å½•ï¼Œæ— æ³•è‡ªåŠ¨è·å–åŸå§‹æˆç»©ID', true);
                return;
            }
            
            const isAdmin = currentUserInfo && currentUserInfo.userType === 'ADMIN';
            const isTeacher = currentUserInfo && currentUserInfo.userType === 'TEACHER';
            
            if (!teacherId && isTeacher) {
                teacherId = currentUserInfo.id;
            }
            
            if (!teacherId && !isAdmin) {
                showMessage('æ— æ³•ç¡®å®šæ•™å¸ˆIDï¼Œè¯·ç¡®è®¤å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºè¯¥è¯¾ç¨‹çš„æˆè¯¾æ•™å¸ˆ', true);
                return;
            }
            
            examData.originalGradeId = originalGradeId;
            examData.teacherId = teacherId;
            
            response = await apiRequest(API_ENDPOINTS.MAKEUP_EXAMS, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(examData)
            });
            data = await response.json();
            if (data.code === 200) {
                closeModal();
                showToast('è¡¥è€ƒå®‰æ’æˆåŠŸ');
                queryMakeupExams();
            } else {
                showMessage(data.message || 'ä¿å­˜å¤±è´¥', true);
            }
        }
    } catch (err) {
        console.error('Error:', err);
        showMessage('æ“ä½œå¤±è´¥: ' + err.message, true);
    }
}

function saveMakeupGrade() {
    const examId = document.getElementById('gradeMakeupId').value;
    const score = document.getElementById('makeupScore').value;
    const gradeLevel = document.getElementById('makeupGradeLevel').value;
    
    if (!examId || !score) {
        showMessage('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', true);
        return;
    }
    
    const gradeData = {
        makeupScore: parseFloat(score),
        makeupGradeLevel: gradeLevel
    };
    
    apiRequest(`${API_ENDPOINTS.MAKEUP_EXAMS}/${examId}/grade`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(gradeData)
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.code === 200) {
            closeGradeModal();
            showToast('æˆç»©å½•å…¥æˆåŠŸ');
            queryMakeupExams();
        } else {
            showMessage(data.message || 'ä¿å­˜å¤±è´¥', true);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('ä¿å­˜å¤±è´¥: ' + err.message, true);
    });
}

function editMakeupExam(id) {
    apiRequest(`${API_ENDPOINTS.MAKEUP_EXAMS}/${id}`)
    .then(resp => resp.json())
    .then(data => {
        const exam = (data.code === 200 && data.data) ? data.data : data;
        if (exam && exam.id) {
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘è¡¥è€ƒ';
            document.getElementById('scheduleStudentId').value = exam.studentId || '';
            document.getElementById('scheduleCourseCode').value = exam.courseCode || '';
            document.getElementById('scheduleCourseName').value = exam.courseName || '';
            document.getElementById('originalExamDate').value = exam.examDate ? exam.examDate.substring(0, 10) : '';
            document.getElementById('originalExamLocation').value = exam.examLocation || '';
            document.getElementById('originalGrade').value = exam.originalGrade || '';
            document.getElementById('semester').value = exam.semester || '';
            document.getElementById('makeupDate').value = exam.makeupDate ? exam.makeupDate.substring(0, 10) : '';
            document.getElementById('makeupTime').value = exam.makeupDate ? exam.makeupDate.substring(11, 16) : '';
            document.getElementById('makeupLocation').value = exam.makeupLocation || '';
            currentEditId = id;
            document.getElementById('makeupExamModal').style.display = 'flex';
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('è·å–è¡¥è€ƒä¿¡æ¯å¤±è´¥', true);
    });
}

function deleteMakeupExam(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¡¥è€ƒè®°å½•å—ï¼Ÿ')) {
        return;
    }
    
    apiRequest(`${API_ENDPOINTS.MAKEUP_EXAMS}/${id}`, {
        method: 'DELETE'
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.code === 200) {
            showToast('åˆ é™¤æˆåŠŸ');
            queryMakeupExams();
        } else {
            showMessage(data.message || 'åˆ é™¤å¤±è´¥', true);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('åˆ é™¤å¤±è´¥: ' + err.message, true);
    });
}

document.addEventListener('click', function(e) {
    if (e.target.closest('#makeupExamModal') && !e.target.closest('.modal-content')) {
        closeModal();
    }
    if (e.target.closest('#makeupGradeModal') && !e.target.closest('.modal-content')) {
        closeGradeModal();
    }
});
</script>
</body>
</html>
