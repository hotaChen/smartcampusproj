<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¥è€ƒç®¡ç†</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">è¡¥è€ƒç®¡ç†</h1>
    
    <div class="toolbar">
        <div class="search-box">
            <input type="text" id="makeupStudentId" placeholder="è¯·è¾“å…¥å­¦å·">
            <input type="text" id="makeupCourseCode" placeholder="è¯¾ç¨‹ä»£ç ">
            <input type="text" id="makeupSemester" value="2023-2024-1" placeholder="å­¦æœŸ">
        </div>
        <button class="btn primary" onclick="queryMakeupExams()">æŸ¥è¯¢è¡¥è€ƒå®‰æ’</button>
        <button class="btn secondary" onclick="queryMyMakeupExams()">æŸ¥è¯¢æˆ‘çš„è¡¥è€ƒ</button>
        <button class="btn primary" onclick="showScheduleForm()">å®‰æ’è¡¥è€ƒ</button>
        <button class="btn secondary" onclick="showGradeForm()">å½•å…¥è¡¥è€ƒæˆç»©</button>
    </div>
    
    <div id="message" class="message" style="display: none;"></div>
    
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>å­¦å·</th>
                <th>è¯¾ç¨‹ä»£ç </th>
                <th>è¯¾ç¨‹åç§°</th>
                <th>åŸæˆç»©</th>
                <th>è¡¥è€ƒæ—¶é—´</th>
                <th>è¡¥è€ƒåœ°ç‚¹</th>
                <th>è¡¥è€ƒæˆç»©</th>
                <th>çŠ¶æ€</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="makeupExamTableBody">
        </tbody>
    </table>
    
    <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-state-icon">ğŸ“‹</div>
        <div class="empty-state-text">æœªæ‰¾åˆ°è¡¥è€ƒè®°å½•</div>
    </div>
    
    <div id="makeupExamModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">å®‰æ’è¡¥è€ƒ</h3>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="scheduleStudentId">å­¦å·:</label>
                    <input type="text" id="scheduleStudentId" required>
                </div>
                <div class="form-group">
                    <label for="scheduleCourseCode">è¯¾ç¨‹ä»£ç :</label>
                    <input type="text" id="scheduleCourseCode" required>
                </div>
                <div class="form-group">
                    <label for="makeupDate">è¡¥è€ƒæ—¶é—´:</label>
                    <input type="datetime-local" id="makeupDate" required>
                </div>
                <div class="form-group">
                    <label for="makeupLocation">è¡¥è€ƒåœ°ç‚¹:</label>
                    <input type="text" id="makeupLocation" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn primary" onclick="saveMakeupExam()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <div id="makeupGradeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å½•å…¥è¡¥è€ƒæˆç»©</h3>
                <span class="modal-close" onclick="closeGradeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="gradeMakeupId">è¡¥è€ƒID:</label>
                    <input type="text" id="gradeMakeupId" readonly>
                </div>
                <div class="form-group">
                    <label for="makeupScore">è¡¥è€ƒåˆ†æ•°:</label>
                    <input type="number" id="makeupScore" min="0" max="100" step="0.1" required>
                </div>
                <div class="form-group">
                    <label for="makeupGradeLevel">æˆç»©ç­‰çº§:</label>
                    <select id="makeupGradeLevel">
                        <option value="ä¼˜ç§€">ä¼˜ç§€</option>
                        <option value="è‰¯å¥½">è‰¯å¥½</option>
                        <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                        <option value="åŠæ ¼">åŠæ ¼</option>
                        <option value="ä¸åŠæ ¼">ä¸åŠæ ¼</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeGradeModal()">å–æ¶ˆ</button>
                <button class="btn primary" onclick="saveMakeupGrade()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<style>
.toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 24px;
    align-items: center;
}

.toolbar .search-box {
    display: flex;
    gap: 8px;
    flex: 1;
    max-width: 500px;
}

.toolbar .search-box input {
    flex: 1;
    height: 42px;
    padding: 0 14px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: var(--text);
    font-size: 14px;
    transition: all 0.2s ease;
}

.toolbar .search-box input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(245,158,11,0.2);
}

.toolbar .btn {
    height: 42px;
    padding: 0 24px;
    font-size: 14px;
    border-radius: 10px;
    font-weight: 600;
}

.toolbar .btn.primary {
    background: linear-gradient(135deg, #fde68a, #f59e0b);
    color: #1a1a1a;
}

.toolbar .btn.secondary {
    background: rgba(255,255,255,0.15);
    color: var(--text);
}

.toolbar .btn.secondary:hover {
    background: rgba(255,255,255,0.25);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--card);
    backdrop-filter: blur(18px);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.data-table th,
.data-table td {
    padding: 14px 18px;
    text-align: left;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.data-table th {
    background: rgba(245,158,11,0.15);
    font-weight: 600;
    color: var(--primary);
    font-size: 14px;
}

.data-table td {
    font-size: 14px;
    color: var(--text);
}

.data-table tbody tr {
    transition: background 0.2s ease;
}

.data-table tbody tr:hover {
    background: rgba(255,255,255,0.05);
}

.data-table .btn {
    height: 32px;
    padding: 0 12px;
    font-size: 12px;
    border-radius: 6px;
    margin-right: 4px;
}

.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.modal-content {
    background: var(--card);
    backdrop-filter: blur(18px);
    border-radius: 16px;
    width: 90%;
    max-width: 480px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--primary);
}

.modal-close {
    font-size: 24px;
    cursor: pointer;
    color: var(--text);
    opacity: 0.6;
    transition: opacity 0.2s;
}

.modal-close:hover {
    opacity: 1;
}

.modal-body {
    padding: 24px;
}

.modal-body .form-group {
    margin-bottom: 16px;
}

.modal-body .form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
}

.modal-body .form-group input,
.modal-body .form-group select {
    width: 100%;
    height: 42px;
    padding: 0 14px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: var(--text);
    font-size: 14px;
    box-sizing: border-box;
}

.modal-body .form-group input:focus,
.modal-body .form-group select:focus {
    outline: none;
    border-color: var(--primary);
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px 24px;
    border-top: 1px solid rgba(255,255,255,0.1);
}

.modal-footer .btn {
    height: 40px;
    padding: 0 20px;
    font-size: 14px;
    border-radius: 8px;
    font-weight: 500;
}

.modal-footer .btn.primary {
    background: linear-gradient(135deg, #fde68a, #f59e0b);
    color: #1a1a1a;
}

.modal-footer .btn.secondary {
    background: rgba(255,255,255,0.15);
    color: var(--text);
}

.empty-state {
    background: var(--card);
    backdrop-filter: blur(18px);
    border-radius: 16px;
    padding: 60px 40px;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 16px;
}

.empty-state-text {
    font-size: 16px;
    color: var(--text);
    opacity: 0.7;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    SidebarManager.init({ currentPage: 'makeup-exam' });
    getUserInfo();
});

function getUserInfo() {
    const token = localStorage.getItem('token');
    apiRequest(API_ENDPOINTS.USER_INFO + `?token=${token}`)
    .then(resp => resp.json())
    .then(data => {
        if (data.userType === 'STUDENT') {
            document.getElementById('makeupStudentId').parentElement.style.display = 'none';
            document.querySelector('button[onclick="queryMakeupExams()"]').style.display = 'none';
            document.querySelector('button[onclick="showScheduleForm()"]').style.display = 'none';
            document.querySelector('button[onclick="showGradeForm()"]').style.display = 'none';
            queryMyMakeupExams();
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
    });
}

function showMessage(message, isError = false) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = message;
    messageDiv.className = isError ? 'message error' : 'message success';
    messageDiv.style.display = 'block';
    
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 3000);
}

function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

function queryMakeupExams() {
    const studentId = document.getElementById('makeupStudentId').value;
    const courseCode = document.getElementById('makeupCourseCode').value;
    const semester = document.getElementById('makeupSemester').value;
    
    let url = `${API_ENDPOINTS.MAKEUP_EXAMS}?semester=${semester}`;
    if (studentId) url += `&studentId=${studentId}`;
    if (courseCode) url += `&courseCode=${courseCode}`;
    
    apiRequest(url)
    .then(resp => resp.json())
    .then(data => {
        renderMakeupExams(data);
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('æŸ¥è¯¢å¤±è´¥: ' + err.message, true);
    });
}

function queryMyMakeupExams() {
    apiRequest(API_ENDPOINTS.MY_MAKEUP_EXAMS)
    .then(resp => resp.json())
    .then(data => {
        renderMakeupExams(data);
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('æŸ¥è¯¢å¤±è´¥: ' + err.message, true);
    });
}

function renderMakeupExams(data) {
    const tbody = document.querySelector('#makeupExamTableBody');
    const emptyState = document.getElementById('emptyState');
    tbody.innerHTML = '';
    
    if (data.code === 200 && data.data && data.data.length > 0) {
        data.data.forEach(exam => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${exam.id}</td>
                <td>${exam.studentId}</td>
                <td>${exam.courseCode}</td>
                <td>${exam.courseName}</td>
                <td>${exam.originalScore}</td>
                <td>${new Date(exam.makeupDate).toLocaleString()}</td>
                <td>${exam.makeupLocation}</td>
                <td>${exam.makeupScore || '-'}</td>
                <td>${exam.status}</td>
                <td>
                    ${exam.status === 'å¾…è€ƒ' ? '<button class="btn secondary" onclick="editMakeupExam(' + exam.id + ')">ç¼–è¾‘</button>' : ''}
                    <button class="btn secondary" onclick="deleteMakeupExam(' + exam.id + ')">åˆ é™¤</button>
                </td>
            `;
            tbody.appendChild(row);
        });
        emptyState.style.display = 'none';
    } else {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
    }
}

function showScheduleForm() {
    document.getElementById('modalTitle').textContent = 'å®‰æ’è¡¥è€ƒ';
    document.getElementById('scheduleStudentId').value = '';
    document.getElementById('scheduleCourseCode').value = '';
    document.getElementById('makeupDate').value = '';
    document.getElementById('makeupLocation').value = '';
    document.getElementById('makeupExamModal').style.display = 'flex';
}

function showGradeForm() {
    const selectedExam = document.querySelector('#makeupExamTableBody tr.selected');
    if (!selectedExam) {
        showMessage('è¯·å…ˆé€‰æ‹©è¦å½•å…¥æˆç»©çš„è¡¥è€ƒè®°å½•', true);
        return;
    }
    const examId = selectedExam.querySelector('td').textContent;
    document.getElementById('gradeMakeupId').value = examId;
    document.getElementById('makeupScore').value = '';
    document.getElementById('makeupGradeLevel').value = 'åŠæ ¼';
    document.getElementById('makeupGradeModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('makeupExamModal').style.display = 'none';
}

function closeGradeModal() {
    document.getElementById('makeupGradeModal').style.display = 'none';
}

function saveMakeupExam() {
    const studentId = document.getElementById('scheduleStudentId').value;
    const courseCode = document.getElementById('scheduleCourseCode').value;
    const makeupDate = document.getElementById('makeupDate').value;
    const makeupLocation = document.getElementById('makeupLocation').value;
    
    if (!studentId || !courseCode || !makeupDate || !makeupLocation) {
        showMessage('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', true);
        return;
    }
    
    const examData = {
        studentId: studentId,
        courseCode: courseCode,
        makeupDate: makeupDate,
        makeupLocation: makeupLocation
    };
    
    apiRequest(API_ENDPOINTS.MAKEUP_EXAMS, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(examData)
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.code === 200) {
            closeModal();
            showToast('è¡¥è€ƒå®‰æ’æˆåŠŸ');
            queryMakeupExams();
        } else {
            showMessage(data.message || 'ä¿å­˜å¤±è´¥', true);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('ä¿å­˜å¤±è´¥: ' + err.message, true);
    });
}

function saveMakeupGrade() {
    const examId = document.getElementById('gradeMakeupId').value;
    const score = document.getElementById('makeupScore').value;
    const gradeLevel = document.getElementById('makeupGradeLevel').value;
    
    if (!examId || !score) {
        showMessage('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', true);
        return;
    }
    
    const gradeData = {
        makeupScore: parseFloat(score),
        makeupGradeLevel: gradeLevel
    };
    
    apiRequest(`${API_ENDPOINTS.MAKEUP_EXAMS}/${examId}/grade`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(gradeData)
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.code === 200) {
            closeGradeModal();
            showToast('æˆç»©å½•å…¥æˆåŠŸ');
            queryMakeupExams();
        } else {
            showMessage(data.message || 'ä¿å­˜å¤±è´¥', true);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('ä¿å­˜å¤±è´¥: ' + err.message, true);
    });
}

function editMakeupExam(id) {
    apiRequest(`${API_ENDPOINTS.MAKEUP_EXAMS}/${id}`)
    .then(resp => resp.json())
    .then(data => {
        if (data.code === 200 && data.data) {
            const exam = data.data;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘è¡¥è€ƒ';
            document.getElementById('scheduleStudentId').value = exam.studentId;
            document.getElementById('scheduleCourseCode').value = exam.courseCode;
            document.getElementById('makeupDate').value = exam.makeupDate ? exam.makeupDate.substring(0, 16) : '';
            document.getElementById('makeupLocation').value = exam.makeupLocation || '';
            document.getElementById('makeupExamModal').style.display = 'flex';
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('è·å–è¡¥è€ƒä¿¡æ¯å¤±è´¥', true);
    });
}

function deleteMakeupExam(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¡¥è€ƒè®°å½•å—ï¼Ÿ')) {
        return;
    }
    
    apiRequest(`${API_ENDPOINTS.MAKEUP_EXAMS}/${id}`, {
        method: 'DELETE'
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.code === 200) {
            showToast('åˆ é™¤æˆåŠŸ');
            queryMakeupExams();
        } else {
            showMessage(data.message || 'åˆ é™¤å¤±è´¥', true);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('åˆ é™¤å¤±è´¥: ' + err.message, true);
    });
}

document.addEventListener('click', function(e) {
    if (e.target.closest('#makeupExamModal') && !e.target.closest('.modal-content')) {
        closeModal();
    }
    if (e.target.closest('#makeupGradeModal') && !e.target.closest('.modal-content')) {
        closeGradeModal();
    }
});
</script>
</body>
</html>
