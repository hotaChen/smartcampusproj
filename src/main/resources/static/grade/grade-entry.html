<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æˆç»©å½•å…¥</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">æˆç»©å½•å…¥</h1>
    
    <div id="message" class="message" style="display: none;"></div>
    
    <div class="form-container">
        <h3 style="margin-top: 0; margin-bottom: 20px; color: var(--text); font-size: 18px;">å½•å…¥æˆç»©</h3>
        
        <div class="form-row">
            <div class="form-group">
                <label for="studentId">å­¦å·</label>
                <input type="text" id="studentId" required>
            </div>
            <div class="form-group">
                <label for="courseCode">è¯¾ç¨‹ä»£ç </label>
                <input type="text" id="courseCode" required>
            </div>
            <div class="form-group">
                <label for="courseName">è¯¾ç¨‹åç§°</label>
                <input type="text" id="courseName" required>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="examType">è€ƒè¯•ç±»å‹</label>
                <select id="examType">
                    <option value="æœŸä¸­è€ƒè¯•">æœŸä¸­è€ƒè¯•</option>
                    <option value="æœŸæœ«è€ƒè¯•">æœŸæœ«è€ƒè¯•</option>
                    <option value="å¹³æ—¶æˆç»©">å¹³æ—¶æˆç»©</option>
                    <option value="å®éªŒæˆç»©">å®éªŒæˆç»©</option>
                </select>
            </div>
            <div class="form-group">
                <label for="score">åˆ†æ•°</label>
                <input type="number" id="score" min="0" max="100" step="0.1" required>
            </div>
            <div class="form-group">
                <label for="semester">å­¦æœŸ</label>
                <input type="text" id="semester" value="2023-2024-1" required>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="credit">å­¦åˆ†</label>
                <input type="number" id="credit" min="0" max="10" step="0.5" required>
            </div>
            <div class="form-group">
                <label for="gradeLevel">æˆç»©ç­‰çº§</label>
                <select id="gradeLevel">
                    <option value="ä¼˜ç§€">ä¼˜ç§€</option>
                    <option value="è‰¯å¥½">è‰¯å¥½</option>
                    <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                    <option value="åŠæ ¼">åŠæ ¼</option>
                    <option value="ä¸åŠæ ¼">ä¸åŠæ ¼</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label for="comment">è¯„è¯­</label>
            <input type="text" id="comment">
        </div>
        
        <div class="form-actions">
            <button class="btn primary" onclick="enterGrade()">å½•å…¥æˆç»©</button>
            <button class="btn secondary" onclick="batchEnterGrades()">æ‰¹é‡å½•å…¥</button>
        </div>
    </div>
    
    <h3 style="margin-top: 32px; margin-bottom: 16px; color: var(--text); font-size: 18px;">æœ€è¿‘å½•å…¥çš„æˆç»©</h3>
    
    <table class="data-table" id="recentGradesTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>å­¦å·</th>
                <th>è¯¾ç¨‹ä»£ç </th>
                <th>è¯¾ç¨‹åç§°</th>
                <th>è€ƒè¯•ç±»å‹</th>
                <th>åˆ†æ•°</th>
                <th>å­¦æœŸ</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="recentGradesTableBody">
        </tbody>
    </table>
    
    <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-state-icon">ğŸ“Š</div>
        <div class="empty-state-text">æš‚æ— å½•å…¥è®°å½•</div>
    </div>
</div>

<div class="modal" id="editGradeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ç¼–è¾‘æˆç»©</h3>
            <button class="modal-close" onclick="closeEditGradeModal()">&times;</button>
        </div>
        
        <input type="hidden" id="editGradeId">
        
        <div class="form-row">
            <div class="form-group">
                <label for="editStudentId">å­¦å·</label>
                <input type="text" id="editStudentId" required>
            </div>
            <div class="form-group">
                <label for="editCourseCode">è¯¾ç¨‹ä»£ç </label>
                <input type="text" id="editCourseCode" required>
            </div>
            <div class="form-group">
                <label for="editCourseName">è¯¾ç¨‹åç§°</label>
                <input type="text" id="editCourseName" required>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="editExamType">è€ƒè¯•ç±»å‹</label>
                <select id="editExamType">
                    <option value="æœŸä¸­è€ƒè¯•">æœŸä¸­è€ƒè¯•</option>
                    <option value="æœŸæœ«è€ƒè¯•">æœŸæœ«è€ƒè¯•</option>
                    <option value="å¹³æ—¶æˆç»©">å¹³æ—¶æˆç»©</option>
                    <option value="å®éªŒæˆç»©">å®éªŒæˆç»©</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editScore">åˆ†æ•°</label>
                <input type="number" id="editScore" min="0" max="100" step="0.1" required>
            </div>
            <div class="form-group">
                <label for="editSemester">å­¦æœŸ</label>
                <input type="text" id="editSemester" required>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="editCredit">å­¦åˆ†</label>
                <input type="number" id="editCredit" min="0" max="10" step="0.5" required>
            </div>
            <div class="form-group">
                <label for="editGradeLevel">æˆç»©ç­‰çº§</label>
                <select id="editGradeLevel">
                    <option value="ä¼˜ç§€">ä¼˜ç§€</option>
                    <option value="è‰¯å¥½">è‰¯å¥½</option>
                    <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                    <option value="åŠæ ¼">åŠæ ¼</option>
                    <option value="ä¸åŠæ ¼">ä¸åŠæ ¼</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label for="editComment">è¯„è¯­</label>
            <input type="text" id="editComment">
        </div>
        
        <div class="form-actions">
            <button class="btn primary" onclick="updateGrade()">æ›´æ–°æˆç»©</button>
            <button class="btn secondary" onclick="closeEditGradeModal()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<style>
.form-container {
    background: var(--card);
    backdrop-filter: blur(18px);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.form-group input,
.form-group select {
    height: 42px;
    padding: 0 14px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: var(--text);
    font-size: 14px;
    transition: all 0.2s ease;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(245,158,11,0.2);
}

.form-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid rgba(255,255,255,0.1);
}

.form-actions .btn {
    flex: 1;
    height: 42px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.form-actions .btn.primary {
    background: linear-gradient(135deg, #fde68a, #f59e0b);
    color: #1a1a1a;
    border: none;
}

.form-actions .btn.primary:hover {
    box-shadow: 0 4px 16px rgba(245,158,11,0.4);
}

.form-actions .btn.secondary {
    background: rgba(255,255,255,0.15);
    color: var(--text);
    border: 1px solid rgba(255,255,255,0.2);
}

.form-actions .btn.secondary:hover {
    background: rgba(255,255,255,0.25);
}

.table-actions {
    display: flex;
    gap: 8px;
}

.table-actions .action-btn {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.table-actions .action-btn.edit {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
}

.table-actions .action-btn.edit:hover {
    background: rgba(59, 130, 246, 0.3);
}

.table-actions .action-btn.delete {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.table-actions .action-btn.delete:hover {
    background: rgba(239, 68, 68, 0.3);
}
</style>

<script>
const GradeEntryManager = {
    currentUser: null,
    
    init: function() {
        this.waitForUserInfo();
    },
    
    waitForUserInfo: function() {
        const checkUserInfo = () => {
            if (SidebarManager.currentUser) {
                this.currentUser = SidebarManager.currentUser;
                this.checkUserPermission();
            } else if (SidebarManager.token) {
                setTimeout(checkUserInfo, 100);
            } else {
                this.showMessage('è¯·å…ˆç™»å½•', true);
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 2000);
            }
        };
        checkUserInfo();
    },
    
    checkUserPermission: function() {
        if (!this.currentUser) {
            this.showMessage('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
            return;
        }
        
        if (this.currentUser.userType === 'STUDENT') {
            this.showPermissionDenied();
        } else {
            this.loadRecentGrades();
        }
    },
    
    showPermissionDenied: function() {
        document.querySelector('.page-content').innerHTML = `
            <div class="empty-state" style="margin-top: 100px;">
                <div class="empty-state-icon">ğŸ”’</div>
                <div class="empty-state-text">æƒé™ä¸è¶³</div>
                <button class="btn primary" style="max-width: 200px; margin: 0 auto;" onclick="window.location.href='../index.html'">è¿”å›é¦–é¡µ</button>
            </div>
        `;
    },
    
    showMessage: function(message, isError = false) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = message;
        messageDiv.className = isError ? 'message error' : 'message success';
        messageDiv.style.display = 'block';
        
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 3000);
    },
    
    showToast: function(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    },
    
    clearForm: function() {
        document.getElementById('studentId').value = '';
        document.getElementById('courseCode').value = '';
        document.getElementById('courseName').value = '';
        document.getElementById('score').value = '';
        document.getElementById('credit').value = '';
        document.getElementById('comment').value = '';
    },
    
    renderRecentGrades: function(data) {
        const tbody = document.getElementById('recentGradesTableBody');
        const emptyState = document.getElementById('emptyState');
        tbody.innerHTML = '';
        
        if (data && data.length > 0) {
            const recentGrades = data.slice(0, 10);
            recentGrades.forEach(grade => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${grade.id}</td>
                    <td>${grade.studentId}</td>
                    <td>${grade.courseCode}</td>
                    <td>${grade.courseName}</td>
                    <td>${grade.examType}</td>
                    <td>${grade.score}</td>
                    <td>${grade.semester}</td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn edit" onclick="GradeEntryManager.editGrade(${grade.id})">ç¼–è¾‘</button>
                            <button class="action-btn delete" onclick="GradeEntryManager.deleteGrade(${grade.id})">åˆ é™¤</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            emptyState.style.display = 'none';
        } else {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
        }
    }
};

function enterGrade() {
    const gradeData = {
        studentNumber: document.getElementById('studentId').value,
        courseCode: document.getElementById('courseCode').value,
        courseName: document.getElementById('courseName').value,
        examType: document.getElementById('examType').value,
        score: parseFloat(document.getElementById('score').value),
        semester: document.getElementById('semester').value,
        credit: parseFloat(document.getElementById('credit').value),
        gradeLevel: document.getElementById('gradeLevel').value,
        comment: document.getElementById('comment').value
    };
    
    apiRequest(API_ENDPOINTS.GRADES_ENTER, {
        method: 'POST',
        body: JSON.stringify(gradeData)
    })
    .then(resp => {
        if (resp.ok) {
            GradeEntryManager.showMessage('æˆç»©å½•å…¥æˆåŠŸ');
            GradeEntryManager.clearForm();
            loadRecentGrades();
        } else {
            GradeEntryManager.showMessage('æˆç»©å½•å…¥å¤±è´¥', true);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        GradeEntryManager.showMessage('æˆç»©å½•å…¥å¤±è´¥', true);
    });
}

function batchEnterGrades() {
    const batchData = prompt('è¯·è¾“å…¥æ‰¹é‡æˆç»©æ•°æ®(JSONæ ¼å¼):', '[{"studentNumber":"2023001","courseCode":"CS101","courseName":"è®¡ç®—æœºåŸºç¡€","examType":"æœŸæœ«è€ƒè¯•","score":85,"semester":"2023-2024-1","credit":3,"gradeLevel":"è‰¯å¥½","comment":"è¡¨ç°è‰¯å¥½"}]');
    
    if (batchData) {
        try {
            const grades = JSON.parse(batchData);
            
            apiRequest(API_ENDPOINTS.GRADES_BATCH, {
                method: 'POST',
                body: JSON.stringify(grades)
            })
            .then(resp => {
                if (resp.ok) {
                    GradeEntryManager.showMessage('æ‰¹é‡æˆç»©å½•å…¥æˆåŠŸ');
                    loadRecentGrades();
                } else {
                    GradeEntryManager.showMessage('æ‰¹é‡æˆç»©å½•å…¥å¤±è´¥', true);
                }
            })
            .catch(err => {
                console.error('Error:', err);
                GradeEntryManager.showMessage('æ‰¹é‡æˆç»©å½•å…¥å¤±è´¥', true);
            });
        } catch (e) {
            GradeEntryManager.showMessage('JSONæ ¼å¼é”™è¯¯', true);
        }
    }
}

function loadRecentGrades() {
    apiRequest(API_ENDPOINTS.GRADES_BY_TEACHER)
    .then(resp => resp.json())
    .then(data => {
        GradeEntryManager.renderRecentGrades(data);
    })
    .catch(err => {
        console.error('Error:', err);
        GradeEntryManager.showMessage('åŠ è½½æˆç»©æ•°æ®å¤±è´¥', true);
    });
}

GradeEntryManager.editGrade = function(id) {
    apiRequest(API_ENDPOINTS.GRADES_BY_ID(id))
    .then(resp => resp.json())
    .then(grade => {
        document.getElementById('editGradeId').value = grade.id;
        document.getElementById('editStudentId').value = grade.studentId;
        document.getElementById('editCourseCode').value = grade.courseCode;
        document.getElementById('editCourseName').value = grade.courseName;
        document.getElementById('editExamType').value = grade.examType;
        document.getElementById('editScore').value = grade.score;
        document.getElementById('editSemester').value = grade.semester;
        document.getElementById('editCredit').value = grade.credit;
        document.getElementById('editGradeLevel').value = grade.gradeLevel;
        document.getElementById('editComment').value = grade.comment || '';
        
        document.getElementById('editGradeModal').classList.add('show');
    })
    .catch(err => {
        console.error('Error:', err);
        GradeEntryManager.showMessage('è·å–æˆç»©æ•°æ®å¤±è´¥', true);
    });
};

function updateGrade() {
    const id = document.getElementById('editGradeId').value;
    const gradeData = {
        studentNumber: document.getElementById('editStudentId').value,
        courseCode: document.getElementById('editCourseCode').value,
        courseName: document.getElementById('editCourseName').value,
        examType: document.getElementById('editExamType').value,
        score: parseFloat(document.getElementById('editScore').value),
        semester: document.getElementById('editSemester').value,
        credit: parseFloat(document.getElementById('editCredit').value),
        gradeLevel: document.getElementById('editGradeLevel').value,
        comment: document.getElementById('editComment').value
    };
    
    apiRequest(API_ENDPOINTS.GRADES_UPDATE(id), {
        method: 'PUT',
        body: JSON.stringify(gradeData)
    })
    .then(resp => {
        if (resp.ok) {
            GradeEntryManager.showMessage('æˆç»©æ›´æ–°æˆåŠŸ');
            closeEditGradeModal();
            loadRecentGrades();
        } else {
            GradeEntryManager.showMessage('æˆç»©æ›´æ–°å¤±è´¥', true);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        GradeEntryManager.showMessage('æˆç»©æ›´æ–°å¤±è´¥', true);
    });
}

GradeEntryManager.deleteGrade = function(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æˆç»©è®°å½•å—ï¼Ÿ')) return;
    
    apiRequest(API_ENDPOINTS.GRADES_DELETE(id), {
        method: 'DELETE'
    })
    .then(resp => {
        if (resp.ok) {
            GradeEntryManager.showMessage('æˆç»©åˆ é™¤æˆåŠŸ');
            loadRecentGrades();
        } else {
            GradeEntryManager.showMessage('æˆç»©åˆ é™¤å¤±è´¥', true);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        GradeEntryManager.showMessage('æˆç»©åˆ é™¤å¤±è´¥', true);
    });
};

function closeEditGradeModal() {
    document.getElementById('editGradeModal').classList.remove('show');
}

document.addEventListener('DOMContentLoaded', function() {
    SidebarManager.init({ currentPage: 'grade-entry' });
    HeaderComponent.init();
    GradeEntryManager.init();
});
</script>
</body>
</html>
