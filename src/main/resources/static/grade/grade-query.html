<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æˆç»©æŸ¥è¯¢</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">æˆç»©æŸ¥è¯¢</h1>
    
    <div class="toolbar">
        <div class="search-box">
            <input type="text" id="queryStudentId" placeholder="è¯·è¾“å…¥å­¦å·">
            <input type="text" id="querySemester" value="2023-2024-1" placeholder="å­¦æœŸ">
        </div>
        <button class="btn primary" onclick="queryGrades()">æŸ¥è¯¢æˆç»©</button>
        <button class="btn secondary" onclick="queryMyGrades()">æŸ¥è¯¢æˆ‘çš„æˆç»©</button>
    </div>
    
    <div id="message" class="message" style="display: none;"></div>
    
    <table class="data-table">
        <thead>
            <tr>
                <th>å­¦å·</th>
                <th>è¯¾ç¨‹ä»£ç </th>
                <th>è¯¾ç¨‹åç§°</th>
                <th>è€ƒè¯•ç±»å‹</th>
                <th>åˆ†æ•°</th>
                <th>æˆç»©ç­‰çº§</th>
                <th>å­¦æœŸ</th>
                <th>å­¦åˆ†</th>
                <th>è¯„è¯­</th>
            </tr>
        </thead>
        <tbody id="gradeQueryTableBody">
        </tbody>
    </table>
    
    <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-state-icon">ğŸ“‹</div>
        <div class="empty-state-text">æœªæ‰¾åˆ°æˆç»©è®°å½•</div>
    </div>
</div>

<style>
.toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 24px;
    align-items: center;
}

.toolbar .search-box {
    display: flex;
    gap: 8px;
    flex: 1;
    max-width: 400px;
}

.toolbar .search-box input {
    flex: 1;
    height: 42px;
    padding: 0 14px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: var(--text);
    font-size: 14px;
    transition: all 0.2s ease;
}

.toolbar .search-box input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(245,158,11,0.2);
}

.toolbar .btn {
    height: 42px;
    padding: 0 24px;
    font-size: 14px;
    border-radius: 10px;
    font-weight: 600;
}

.toolbar .btn.primary {
    background: linear-gradient(135deg, #fde68a, #f59e0b);
    color: #1a1a1a;
}

.toolbar .btn.secondary {
    background: rgba(255,255,255,0.15);
    color: var(--text);
}

.toolbar .btn.secondary:hover {
    background: rgba(255,255,255,0.25);
}
</style>

<script>
const GradeQueryManager = {
    currentUser: null,
    
    init: function() {
        this.token = localStorage.getItem('token');
        this.loadUserInfo();
    },
    
    loadUserInfo: function() {
        apiRequest(API_ENDPOINTS.USER_INFO + `?token=${this.token}`)
            .then(resp => resp.json())
            .then(user => {
                this.currentUser = user;
                this.setupUIForUserType(user.userType);
            })
            .catch(err => {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥', err);
                this.showMessage('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
            });
    },
    
    setupUIForUserType: function(userType) {
        if (userType === 'STUDENT') {
            document.getElementById('queryStudentId').parentElement.style.display = 'none';
            document.querySelector('button[onclick="queryGrades()"]').style.display = 'none';
            queryMyGrades();
        }
    },
    
    showMessage: function(message, isError = false) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = message;
        messageDiv.className = isError ? 'message error' : 'message success';
        messageDiv.style.display = 'block';
        
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 3000);
    },
    
    showToast: function(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    },
    
    renderGrades: function(data, isMyGrades = false) {
        const tbody = document.getElementById('gradeQueryTableBody');
        const emptyState = document.getElementById('emptyState');
        tbody.innerHTML = '';
        
        let grades = [];
        if (isMyGrades && data && data.courseGrades) {
            grades = data.courseGrades;
        } else if (Array.isArray(data)) {
            grades = data;
        }
        
        if (grades && grades.length > 0) {
            grades.forEach(grade => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${isMyGrades ? (data.studentIdNumber || '') : (grade.studentId || (grade.student ? grade.student.studentId : ''))}</td>
                    <td>${grade.courseCode}</td>
                    <td>${grade.courseName}</td>
                    <td>${grade.examType}</td>
                    <td>${grade.score}</td>
                    <td>${grade.gradeLevel}</td>
                    <td>${isMyGrades ? (data.semester || document.getElementById('querySemester').value || '') : grade.semester}</td>
                    <td>${grade.credit}</td>
                    <td>${grade.comment || grade.remark || ''}</td>
                `;
                tbody.appendChild(row);
            });
            emptyState.style.display = 'none';
        } else {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
        }
    }
};

function queryGrades() {
    const studentId = document.getElementById('queryStudentId').value;
    const semester = document.getElementById('querySemester').value;
    
    let url;
    if (studentId && semester) {
        url = API_ENDPOINTS.GRADES_STUDENT_NUMBER_SEMESTER(studentId, semester);
    } else if (studentId) {
        url = API_ENDPOINTS.GRADES_BY_STUDENT_NUMBER(studentId);
    } else {
        url = API_ENDPOINTS.GRADES_BY_TEACHER;
    }
    
    apiRequest(url)
        .then(resp => resp.json())
        .then(data => {
            GradeQueryManager.renderGrades(data, false);
            if (!data || (Array.isArray(data) && data.length === 0)) {
                GradeQueryManager.showMessage('æœªæ‰¾åˆ°æˆç»©è®°å½•', true);
            }
        })
        .catch(err => {
            console.error('Error:', err);
            GradeQueryManager.showMessage('æŸ¥è¯¢å¤±è´¥: ' + err.message, true);
        });
}

function queryMyGrades() {
    const semester = document.getElementById('querySemester').value;
    const url = semester ? `${API_ENDPOINTS.MY_GRADES}?semester=${encodeURIComponent(semester)}` : API_ENDPOINTS.MY_GRADES;
    
    apiRequest(url)
        .then(resp => resp.json())
        .then(data => {
            GradeQueryManager.renderGrades(data, true);
            if (!data || !data.courseGrades || data.courseGrades.length === 0) {
                GradeQueryManager.showMessage('æœªæ‰¾åˆ°æˆç»©è®°å½•', true);
            }
        })
        .catch(err => {
            console.error('Error:', err);
            GradeQueryManager.showMessage('æŸ¥è¯¢å¤±è´¥: ' + err.message, true);
        });
}

function editGrade(id) {
    window.location.href = `grade-entry.html?id=${id}`;
}

function deleteGrade(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æˆç»©è®°å½•å—ï¼Ÿ')) return;
    
    apiRequest(`${API_ENDPOINTS.GRADES}/${id}`, { method: 'DELETE' })
        .then(resp => resp.json())
        .then(data => {
            if (data.code === 200) {
                GradeQueryManager.showMessage('åˆ é™¤æˆåŠŸ');
                queryGrades();
            } else {
                GradeQueryManager.showMessage('åˆ é™¤å¤±è´¥: ' + data.message, true);
            }
        })
        .catch(err => {
            console.error('Error:', err);
            GradeQueryManager.showMessage('åˆ é™¤å¤±è´¥: ' + err.message, true);
        });
}

document.addEventListener('DOMContentLoaded', function() {
    SidebarManager.init({ currentPage: 'grade-query' });
    HeaderComponent.init();
    GradeQueryManager.init();
});
</script>
</body>
</html>
