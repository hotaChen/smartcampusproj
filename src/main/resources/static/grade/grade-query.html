<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>成绩查询</title>
    <script src="../js/api.js"></script>
    <script src="/js/sidebar.js"></script>
</head>
<body>
    <h1>成绩查询</h1>
    <div>
        <a href="grade-index.html">返回成绩管理</a> |
        <a href="grade-entry.html">成绩录入</a> |
        <a href="grade-stats.html">成绩统计</a> |
        <a href="grade-report.html">成绩单生成</a> |
        <a href="makeup-exam.html">补考管理</a> |
        <a href="../index.html">返回首页</a>
    </div>
    
    <div id="message" class="message" style="display: none;"></div>
    
    <h2>成绩查询</h2>
    
    <div class="form-row">
        <div class="form-group">
            <label for="queryStudentId">学号:</label>
            <input type="text" id="queryStudentId">
        </div>
        <div class="form-group">
            <label for="querySemester">学期:</label>
            <input type="text" id="querySemester" value="2023-2024-1">
        </div>
    </div>
    
    <button onclick="queryGrades()">查询成绩</button>
    <button onclick="queryMyGrades()">查询我的成绩</button>
    
    <table id="gradeQueryTable">
        <thead>
            <tr>
                <th>学号</th>
                <th>课程代码</th>
                <th>课程名称</th>
                <th>考试类型</th>
                <th>分数</th>
                <th>成绩等级</th>
                <th>学期</th>
                <th>学分</th>
                <th>评语</th>
            </tr>
        </thead>
        <tbody>
            <!-- 成绩数据将通过JavaScript动态填充 -->
        </tbody>
    </table>

<script>
document.addEventListener('DOMContentLoaded', function() {
    SidebarManager.init({ currentPage: 'grade-query' });
    getUserInfo();
});

// 获取用户信息
function getUserInfo() {
    apiRequest(API_ENDPOINTS.USER_INFO)
    .then(resp => resp.json())
    .then(data => {
        if (data.userType === 'STUDENT') {
            document.getElementById('queryStudentId').parentElement.style.display = 'none';
            document.querySelector('button[onclick="queryGrades()"]').style.display = 'none';
            queryMyGrades();
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('获取用户信息失败，请刷新页面重试', true);
    });
}

// 显示消息
function showMessage(message, isError = false) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = message;
    messageDiv.className = isError ? 'message error' : 'message success';
    messageDiv.style.display = 'block';
    
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 3000);
}

// 查询成绩
function queryGrades() {
    const studentId = document.getElementById('queryStudentId').value;
    const semester = document.getElementById('querySemester').value;
    
    let url;
    if (studentId && semester) {
        url = API_ENDPOINTS.GRADES_STUDENT_NUMBER_SEMESTER(studentId, semester);
    } else if (studentId) {
        url = API_ENDPOINTS.GRADES_BY_STUDENT_NUMBER(studentId);
    } else {
        url = API_ENDPOINTS.GRADES_BY_TEACHER;
    }
    
    apiRequest(url)
    .then(resp => resp.json())
    .then(data => {
        const tbody = document.querySelector('#gradeQueryTable tbody');
        tbody.innerHTML = '';
        
        if (data && data.length > 0) {
            data.forEach(grade => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${grade.studentId || (grade.student ? grade.student.studentId : '')}</td>
                    <td>${grade.courseCode}</td>
                    <td>${grade.courseName}</td>
                    <td>${grade.examType}</td>
                    <td>${grade.score}</td>
                    <td>${grade.gradeLevel}</td>
                    <td>${grade.semester}</td>
                    <td>${grade.credit}</td>
                    <td>${grade.comment || ''}</td>
                `;
                tbody.appendChild(row);
            });
        } else {
            showMessage('未找到成绩记录', true);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('查询失败: ' + err.message, true);
    });
}

// 查询我的成绩
function queryMyGrades() {
    const semester = document.getElementById('querySemester').value;
    const url = semester ? `${API_ENDPOINTS.MY_GRADES}?semester=${encodeURIComponent(semester)}` : API_ENDPOINTS.MY_GRADES;
    
    apiRequest(url)
    .then(resp => resp.json())
    .then(data => {
        const tbody = document.querySelector('#gradeQueryTable tbody');
        tbody.innerHTML = '';
        
        if (data && data.courseGrades && data.courseGrades.length > 0) {
            data.courseGrades.forEach(grade => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.studentIdNumber || ''}</td>
                    <td>${grade.courseCode}</td>
                    <td>${grade.courseName}</td>
                    <td>${grade.examType}</td>
                    <td>${grade.score}</td>
                    <td>${grade.gradeLevel}</td>
                    <td>${data.semester || semester || ''}</td>
                    <td>${grade.credit}</td>
                    <td>${grade.remark || ''}</td>
                `;
                tbody.appendChild(row);
            });
        } else {
            showMessage('未找到成绩记录', true);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('查询失败: ' + err.message, true);
    });
}

// 编辑成绩
function editGrade(id) {
    window.location.href = `grade-entry.html?id=${id}`;
}

// 删除成绩
function deleteGrade(id) {
    if (!confirm('确定要删除这条成绩记录吗？')) return;
    
    apiRequest(`${API_ENDPOINTS.GRADES}/${id}`, { method: 'DELETE' })
    .then(resp => resp.json())
    .then(data => {
        if (data.code === 200) {
            showMessage('删除成功');
            queryGrades();
        } else {
            showMessage('删除失败: ' + data.message, true);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showMessage('删除失败: ' + err.message, true);
    });
}
</script>
</body>
</html>