<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>课程排课管理</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
    <style>
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: var(--card); padding: 24px; border-radius: 12px; backdrop-filter: blur(18px);
            box-shadow: 0 30px 70px rgba(0,0,0,0.5); min-width: 400px; }
    </style>
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">课程排课管理</h1>
    
    <div class="toolbar">
        <button class="btn secondary" onclick="goBack()">返回首页</button>
        <input type="text" id="courseIdInput" placeholder="输入课程ID或课程名称查询" class="input">
        <button class="btn primary" onclick="loadTimetable()">查询课表</button>
        <button class="btn primary" id="addBtn" style="display:none;" onclick="openAddModal()">新增排课</button>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>课程ID</th>
                <th>课程名称</th>
                <th>教室</th>
                <th>星期</th>
                <th>开始时间</th>
                <th>结束时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="timetableTableBody">
            <tr><td colspan="8" class="empty-state">请输入课程ID并点击查询</td></tr>
        </tbody>
    </table>
</div>

<div class="modal" id="timetableModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">新增排课</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <input type="hidden" id="timetableId">
        <div class="form-group">
            <label>课程ID</label>
            <input type="number" id="modalCourseId" placeholder="请输入课程ID">
        </div>
        <div class="form-group">
            <label>教室ID</label>
            <input type="number" id="modalClassroomId" placeholder="请输入教室ID">
        </div>
        <div class="form-group">
            <label>星期</label>
            <select id="modalDayOfWeek">
                <option value="MONDAY">星期一</option>
                <option value="TUESDAY">星期二</option>
                <option value="WEDNESDAY">星期三</option>
                <option value="THURSDAY">星期四</option>
                <option value="FRIDAY">星期五</option>
                <option value="SATURDAY">星期六</option>
                <option value="SUNDAY">星期日</option>
            </select>
        </div>
        <div class="form-group">
            <label>开始时间</label>
            <input type="time" id="modalStartTime" placeholder="请输入开始时间">
        </div>
        <div class="form-group">
            <label>结束时间</label>
            <input type="time" id="modalEndTime" placeholder="请输入结束时间">
        </div>
        <p id="modalMsg" class="message error" style="display:none;"></p>
        <div class="form-actions">
            <button class="btn primary" onclick="submitTimetable()">提交</button>
            <button class="btn secondary" onclick="closeModal()">取消</button>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    let currentUser = null;
    let timetables = [];

    function goBack() { window.location.href = '../index.html'; }

    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);
    }

    document.addEventListener('DOMContentLoaded', function() {
        SidebarManager.init({ currentPage: 'timetable' });
        HeaderComponent.init();
    });

    if (!token) {
        document.getElementById('timetableTableBody').innerHTML = '<tr><td colspan="8" class="empty-state">未检测到登录信息，请重新登录</td></tr>';
    } else {
        apiRequest(API_ENDPOINTS.USER_INFO + `?token=${token}`)
            .then(resp => resp.json())
            .then(user => {
                currentUser = user;
                if (user.userType === 'ADMIN') {
                    document.getElementById('addBtn').style.display = 'inline-block';
                }
                loadAllTimetables();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('timetableTableBody').innerHTML = '<tr><td colspan="8" class="empty-state">获取用户信息失败</td></tr>';
            });
    }

    function loadAllTimetables() {
        apiRequest(API_ENDPOINTS.ALL_TIMETABLES)
            .then(resp => {
                if (!resp.ok) throw new Error('加载失败');
                return resp.json();
            })
            .then(data => {
                timetables = Array.isArray(data) ? data : [];
                renderTable();
            })
            .catch(err => {
                console.error(err);
            });
    }

    function loadTimetable() {
        const input = document.getElementById('courseIdInput').value.trim();
        if (!input) return alert('请输入课程ID或课程名称');

        let endpoint;
        if (/^\d+$/.test(input)) {
            endpoint = API_ENDPOINTS.TIMETABLES_BY_COURSE(input);
        } else {
            endpoint = API_ENDPOINTS.TIMETABLES_BY_COURSE_NAME(input);
        }

        apiRequest(endpoint)
            .then(resp => {
                if (!resp.ok) throw new Error('查询失败');
                return resp.json();
            })
            .then(data => {
                timetables = Array.isArray(data) ? data : [];
                renderTable();
            })
            .catch(err => {
                console.error(err);
                document.querySelector('#timetableTableBody').innerHTML =
                    '<tr><td colspan="8" class="empty-state">加载失败，请检查课程ID或课程名称是否正确</td></tr>';
            });
    }

    function renderTable() {
        const tbody = document.getElementById('timetableTableBody');
        if (!timetables || timetables.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-state">暂无排课信息</td></tr>';
            return;
        }
        tbody.innerHTML = '';
        timetables.forEach(t => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${t.id}</td>
                <td>${t.courseId}</td>
                <td>${t.courseName || '-'}</td>
                <td>${t.classroom || '-'}</td>
                <td>${t.dayOfWeek}</td>
                <td>${t.startTime}</td>
                <td>${t.endTime}</td>
                <td>
                    <div class="table-actions">
                        ${currentUser.userType === 'ADMIN'
                        ? `<button class="action-btn delete" onclick="deleteTimetable(${t.id})">删除</button>` : ''}
                    </div>
                </td>`;
            tbody.appendChild(tr);
        });
    }

    function openAddModal() {
        document.getElementById('modalTitle').innerText = '新增排课';
        document.getElementById('timetableId').value = '';
        document.getElementById('modalCourseId').value = '';
        document.getElementById('modalClassroomId').value = '';
        document.getElementById('modalDayOfWeek').value = 'MONDAY';
        document.getElementById('modalStartTime').value = '';
        document.getElementById('modalEndTime').value = '';
        document.getElementById('modalMsg').style.display = 'none';
        document.getElementById('timetableModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('timetableModal').classList.remove('show');
    }

    function submitTimetable() {
        const courseId = document.getElementById('modalCourseId').value;
        const classroomId = document.getElementById('modalClassroomId').value;
        const dayOfWeek = document.getElementById('modalDayOfWeek').value;
        const startTime = document.getElementById('modalStartTime').value;
        const endTime = document.getElementById('modalEndTime').value;

        if (!courseId || !classroomId || !dayOfWeek || !startTime || !endTime) {
            const msgEl = document.getElementById('modalMsg');
            msgEl.innerText = '请填写完整信息';
            msgEl.style.display = 'block';
            return;
        }

        const params = new URLSearchParams({
            courseId, classroomId, dayOfWeek, startTime, endTime
        });

        apiRequest(`${API_ENDPOINTS.TIMETABLES}?${params.toString()}`, {
            method: 'POST'
        })
            .then(resp => {
                if (!resp.ok) throw new Error('新增失败');
                closeModal();
                showToast('新增成功');
                loadTimetable();
            })
            .catch(err => {
                console.error(err);
                const msgEl = document.getElementById('modalMsg');
                msgEl.innerText = '操作失败';
                msgEl.style.display = 'block';
            });
    }

    function deleteTimetable(id) {
        if (!confirm('确定删除该排课吗？')) return;
        apiRequest(API_ENDPOINTS.TIMETABLE(id), { method: 'DELETE' })
            .then(resp => {
                if (!resp.ok) throw new Error('删除失败');
                showToast('删除成功');
                loadTimetable();
            })
            .catch(err => {
                console.error(err);
                showToast('删除失败');
            });
    }
</script>
</body>
</html>
