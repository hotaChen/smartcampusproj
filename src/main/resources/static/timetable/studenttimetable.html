<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>学生课表</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">学生课表</h1>
    
    <div class="toolbar">
        <button class="btn secondary" onclick="goBack()">返回首页</button>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>课程ID</th>
                <th>课程名称</th>
                <th>教师</th>
                <th>教室</th>
                <th>星期</th>
                <th>开始时间</th>
                <th>结束时间</th>
            </tr>
        </thead>
        <tbody id="timetableBody">
            <tr><td colspan="7" class="empty-state">正在加载课表...</td></tr>
        </tbody>
    </table>
</div>

<script>
    const token = localStorage.getItem('token');

    function goBack() { window.location.href = '../index.html'; }

    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);
    }

    document.addEventListener('DOMContentLoaded', function() {
        SidebarManager.init({ currentPage: 'student-timetable' });
        HeaderComponent.init();
    });

    if (!token) {
        document.getElementById('timetableBody').innerHTML = '<tr><td colspan="7" class="empty-state">未检测到登录信息，请重新登录</td></tr>';
    } else {
        apiRequest(API_ENDPOINTS.STUDENT_TIMETABLE)
            .then(resp => resp.json())
            .then(data => renderTimetable(data))
            .catch(err => {
                console.error(err);
                document.getElementById('timetableBody').innerHTML = '<tr><td colspan="7" class="empty-state">加载失败，请检查接口或权限</td></tr>';
            });
    }

    function renderTimetable(list) {
        const tbody = document.getElementById('timetableBody');
        if (!list || !list.length) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">暂无课程安排</td></tr>';
            return;
        }

        const dayOrder = {
            'MONDAY': 1,
            'TUESDAY': 2,
            'WEDNESDAY': 3,
            'THURSDAY': 4,
            'FRIDAY': 5,
            'SATURDAY': 6,
            'SUNDAY': 7
        };

        list.sort((a, b) => {
            const dayA = dayOrder[a.dayOfWeek] || 8;
            const dayB = dayOrder[b.dayOfWeek] || 8;
            if (dayA !== dayB) return dayA - dayB;
            return (a.startTime || '').localeCompare(b.startTime || '');
        });

        tbody.innerHTML = '';
        list.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.courseId}</td>
                <td>${item.courseName || '-'}</td>
                <td>${item.teacherName || '-'}</td>
                <td>${item.classroom || '-'}</td>
                <td>${item.dayOfWeek || '-'}</td>
                <td>${item.startTime || '-'}</td>
                <td>${item.endTime || '-'}</td>
            `;
            tbody.appendChild(tr);
        });
    }
</script>
</body>
</html>
