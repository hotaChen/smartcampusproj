<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>学生选课系统</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">学生选课系统</h1>
    
    <div class="toolbar">
        <button class="btn secondary" onclick="goBack()">返回首页</button>
    </div>

    <div class="section">
        <h2 class="section-title">已选课程</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>课程代码</th>
                    <th>课程名称</th>
                    <th>学分</th>
                    <th>容量</th>
                    <th>教师</th>
                    <th>教室</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="myCoursesTable">
                <tr><td colspan="8" class="empty-state">正在加载已选课程...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2 class="section-title">可选课程</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>课程代码</th>
                    <th>课程名称</th>
                    <th>学分</th>
                    <th>容量</th>
                    <th>教师</th>
                    <th>教室</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="allCoursesTable">
                <tr><td colspan="8" class="empty-state">正在加载可选课程...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    let currentUser = null;
    let myCourses = [];
    let allCourses = [];

    function goBack() { window.location.href = '../index.html'; }

    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);
    }

    document.addEventListener('DOMContentLoaded', function() {
        SidebarManager.init({ currentPage: 'courseselection' });
        HeaderComponent.init();
    });

    if (!token) {
        document.getElementById('myCoursesTable').innerHTML = '<tr><td colspan="8" class="empty-state">未检测到登录信息，请重新登录</td></tr>';
        document.getElementById('allCoursesTable').innerHTML = '<tr><td colspan="8" class="empty-state">未检测到登录信息，请重新登录</td></tr>';
    } else {
        apiRequest(API_ENDPOINTS.USER_INFO + `?token=${token}`)
            .then(resp => resp.json())
            .then(user => {
                currentUser = user;
                if (user.userType !== 'STUDENT') {
                    showToast('非学生无法访问选课系统');
                    setTimeout(() => window.location.href = '../index.html', 1500);
                } else {
                    loadCourses();
                }
            })
            .catch(err => {
                console.error(err);
                showToast('获取用户信息失败');
            });
    }

    function loadCourses() {
        Promise.all([
            apiRequest(API_ENDPOINTS.MY_COURSE_SELECTIONS).then(r => r.json()),
            apiRequest(API_ENDPOINTS.COURSES).then(r => r.json())
        ]).then(([my, all]) => {
            myCourses = Array.isArray(my) ? my : [];
            allCourses = Array.isArray(all) ? all : [];
            renderMyCourses();
            renderAllCourses();
        }).catch(err => {
            console.error(err);
            showToast('加载课程失败');
        });
    }

    function renderMyCourses() {
        const tbody = document.getElementById('myCoursesTable');
        if (!myCourses.length) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-state">暂无已选课程</td></tr>';
            return;
        }
        tbody.innerHTML = '';
        myCourses.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${c.id}</td>
                <td>${c.courseCode}</td>
                <td>${c.name}</td>
                <td>${c.credit}</td>
                <td>${c.capacity}</td>
                <td>${c.teacherName || '-'}</td>
                <td>${c.classroomName || '-'}</td>
                <td>
                    <div class="table-actions">
                        <button class="action-btn delete" onclick="dropCourse(${c.id})">退课</button>
                    </div>
                </td>`;
            tbody.appendChild(tr);
        });
    }

    function renderAllCourses() {
        const tbody = document.getElementById('allCoursesTable');
        if (!allCourses.length) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-state">暂无课程</td></tr>';
            return;
        }
        tbody.innerHTML = '';
        allCourses.forEach(c => {
            const alreadySelected = myCourses.some(mc => mc.id === c.id);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${c.id}</td>
                <td>${c.courseCode}</td>
                <td>${c.name}</td>
                <td>${c.credit}</td>
                <td>${c.capacity}</td>
                <td>${c.teacherName || '-'}</td>
                <td>${c.classroomName || '-'}</td>
                <td>
                    <div class="table-actions">
                        <button class="action-btn" onclick="selectCourse(${c.id})" ${alreadySelected ? 'disabled' : ''}>
                            ${alreadySelected ? '已选' : '选课'}
                        </button>
                    </div>
                </td>`;
            tbody.appendChild(tr);
        });
    }

    function selectCourse(courseId) {
        apiRequest(API_ENDPOINTS.COURSE_SELECTION(courseId), {
            method: 'POST'
        })
            .then(resp => {
                if (!resp.ok) throw new Error('选课失败');
                return resp.json();
            })
            .then(() => {
                const course = allCourses.find(c => c.id === courseId);
                if (course) myCourses.push(course);
                renderMyCourses();
                renderAllCourses();
                showToast('选课成功');
            })
            .catch(err => {
                console.error(err);
                showToast('选课失败');
            });
    }

    function dropCourse(courseId) {
        if (!confirm('确定退选该课程吗？')) return;
        apiRequest(API_ENDPOINTS.COURSE_SELECTION(courseId), {
            method: 'DELETE'
        })
            .then(resp => {
                if (!resp.ok) throw new Error('退课失败');
                myCourses = myCourses.filter(c => c.id !== courseId);
                renderMyCourses();
                renderAllCourses();
                showToast('退课成功');
            })
            .catch(err => {
                console.error(err);
                showToast('退课失败');
            });
    }
</script>
</body>
</html>
