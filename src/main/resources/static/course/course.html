<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>课程管理</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">课程管理</h1>
    
    <div class="toolbar">
        <button class="btn secondary" onclick="goBack()">返回首页</button>
        <button class="btn primary" id="addBtn" style="display:none;" onclick="openAddModal()">新增课程</button>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>课程代码</th>
                <th>课程名称</th>
                <th>学分</th>
                <th>容量</th>
                <th>教师ID</th>
                <th>教师姓名</th>
                <th>教室ID</th>
                <th>教室名称</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="courseTableBody">
            <tr><td colspan="10" class="empty-state">正在加载课程信息...</td></tr>
        </tbody>
    </table>
</div>

<div class="modal" id="courseModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">新增课程</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <input type="hidden" id="courseId">
        <div class="form-group">
            <label>课程编号</label>
            <input type="text" id="courseCode" placeholder="请输入课程编号">
        </div>
        <div class="form-group">
            <label>课程名称</label>
            <input type="text" id="name" placeholder="请输入课程名称">
        </div>
        <div class="form-group">
            <label>学分</label>
            <input type="number" id="credit" placeholder="请输入学分">
        </div>
        <div class="form-group">
            <label>容量</label>
            <input type="number" id="capacity" placeholder="请输入容量">
        </div>
        <div class="form-group">
            <label>教师ID（管理员可修改）</label>
            <input type="number" id="teacherId" placeholder="请输入教师ID">
        </div>
        <div class="form-group">
            <label>教室ID</label>
            <input type="number" id="classroomId" placeholder="请输入教室ID">
        </div>
        <p id="modalMsg" class="message error" style="display:none;"></p>
        <div class="form-actions">
            <button class="btn primary" onclick="submitCourse()">提交</button>
            <button class="btn secondary" onclick="closeModal()">取消</button>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    let currentUser = null;
    let courses = [];

    function goBack() { window.location.href = '../index.html'; }

    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);
    }

    document.addEventListener('DOMContentLoaded', function() {
        SidebarManager.init({ currentPage: 'course' });
        HeaderComponent.init();
    });

    if (!token) {
        document.getElementById('courseTableBody').innerHTML = '<tr><td colspan="10" class="empty-state">未检测到登录信息，请重新登录</td></tr>';
    } else {
        apiRequest(API_ENDPOINTS.USER_INFO + `?token=${token}`)
            .then(resp => resp.json())
            .then(user => {
                currentUser = user;
                loadCourses();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('courseTableBody').innerHTML = '<tr><td colspan="10" class="empty-state">获取用户信息失败</td></tr>';
            });
    }

    function loadCourses() {
        apiRequest(API_ENDPOINTS.COURSES)
            .then(resp => resp.json())
            .then(data => {
                courses = Array.isArray(data) ? data : [];
                renderTable();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('courseTableBody').innerHTML = '<tr><td colspan="10" class="empty-state">加载失败，请检查接口或权限</td></tr>';
            });
    }

    function renderTable() {
        const tbody = document.getElementById('courseTableBody');
        if (!courses || courses.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="empty-state">暂无课程信息</td></tr>';
            return;
        }
        tbody.innerHTML = '';
        courses.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${c.id}</td>
                <td>${c.courseCode}</td>
                <td>${c.name}</td>
                <td>${c.credit}</td>
                <td>${c.capacity}</td>
                <td>${c.teacherId || '-'}</td>
                <td>${c.teacherName || '-'}</td>
                <td>${c.classroomId || '-'}</td>
                <td>${c.classroomName || '-'}</td>
                <td>
                    <div class="table-actions">
                        ${(currentUser.userType === 'ADMIN' || currentUser.userType === 'TEACHER')
                            ? `<button class="action-btn edit" onclick="openEditModal(${c.id})">编辑</button>
                               <button class="action-btn delete" onclick="deleteCourse(${c.id})">删除</button>` : ''}
                    </div>
                </td>`;
            tbody.appendChild(tr);
        });
    }

    function openAddModal() {
        document.getElementById('modalTitle').innerText = '新增课程';
        document.getElementById('courseId').value = '';
        document.getElementById('courseCode').value = '';
        document.getElementById('name').value = '';
        document.getElementById('credit').value = '';
        document.getElementById('capacity').value = '';
        document.getElementById('teacherId').value = '';
        document.getElementById('classroomId').value = '';
        document.getElementById('modalMsg').style.display = 'none';
        document.getElementById('courseModal').classList.add('show');
    }

    function openEditModal(id) {
        const c = courses.find(x => x.id === id);
        if (!c) return;
        document.getElementById('modalTitle').innerText = '编辑课程';
        document.getElementById('courseId').value = c.id;
        document.getElementById('courseCode').value = c.courseCode;
        document.getElementById('name').value = c.name;
        document.getElementById('credit').value = c.credit;
        document.getElementById('capacity').value = c.capacity;
        document.getElementById('teacherId').value = c.teacherId || '';
        document.getElementById('classroomId').value = c.classroomId || '';
        document.getElementById('modalMsg').style.display = 'none';
        document.getElementById('courseModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('courseModal').classList.remove('show');
    }

    function submitCourse() {
        const id = document.getElementById('courseId').value;
        const courseCode = document.getElementById('courseCode').value;
        const name = document.getElementById('name').value;
        const credit = parseInt(document.getElementById('credit').value);
        const capacity = parseInt(document.getElementById('capacity').value);
        const teacherId = parseInt(document.getElementById('teacherId').value);
        const classroomId = parseInt(document.getElementById('classroomId').value);

        if (!courseCode || !name || isNaN(credit) || isNaN(capacity) || isNaN(classroomId)) {
            const msgEl = document.getElementById('modalMsg');
            msgEl.innerText = '请填写完整信息';
            msgEl.style.display = 'block';
            return;
        }

        const payload = {
            courseCode,
            name,
            credit,
            capacity,
            teacher: teacherId ? { id: teacherId } : null,
            classroom: { id: classroomId }
        };

        let url = API_ENDPOINTS.COURSES;
        let method = 'POST';
        if (id) { url = API_ENDPOINTS.COURSE(id); method = 'PUT'; }

        apiRequest(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(resp => {
                if (!resp.ok) throw new Error('操作失败');
                return resp.json();
            })
            .then(() => {
                closeModal();
                showToast('操作成功');
                loadCourses();
            })
            .catch(err => {
                console.error(err);
                const msgEl = document.getElementById('modalMsg');
                msgEl.innerText = '操作失败';
                msgEl.style.display = 'block';
            });
    }

    function deleteCourse(id) {
        if (!confirm('确定删除该课程吗？')) return;
        apiRequest(API_ENDPOINTS.COURSE(id), { method: 'DELETE' })
            .then(resp => {
                if (!resp.ok) throw new Error('删除失败');
                showToast('删除成功');
                loadCourses();
            })
            .catch(err => {
                console.error(err);
                showToast('删除失败');
            });
    }
</script>
</body>
</html>
