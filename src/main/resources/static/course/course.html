<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>课程管理</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { margin-bottom: 20px; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f4f4f4; }
        button { padding: 5px 10px; margin-right: 5px; }
        input { margin: 3px 0; padding: 5px; width: 150px; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 5px; }
    </style>
</head>
<body>
<h1>课程管理</h1>
<div>
    <button onclick="goBack()">返回首页</button>
    <button id="addBtn" style="display:none;" onclick="openAddModal()">新增课程</button>
</div>

<table id="courseTable">
    <thead>
    <tr>
        <th>ID</th>
        <th>课程代码</th>
        <th>课程名称</th>
        <th>学分</th>
        <th>容量</th>
        <th>教师ID</th>
        <th>教师姓名</th>
        <th>教室ID</th>
        <th>教室名称</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody>
    <tr><td colspan="10">正在加载课程信息...</td></tr>
    </tbody>
</table>

<!-- 新增/编辑课程弹窗 -->
<!-- 课程编辑弹窗 -->
<div class="modal" id="courseModal">
    <div class="modal-content">
        <h3 id="modalTitle">新增课程</h3>
        <input type="hidden" id="courseId">
        <input type="text" id="courseCode" placeholder="课程编号"><br>
        <input type="text" id="name" placeholder="课程名称"><br>
        <input type="number" id="credit" placeholder="学分"><br>
        <input type="number" id="capacity" placeholder="容量"><br>
        <input type="number" id="teacherId" placeholder="教师ID（管理员可修改）"><br>
        <input type="number" id="classroomId" placeholder="教室ID"><br>
        <button onclick="submitCourse()">提交</button>
        <button onclick="closeModal()">取消</button>
        <p id="modalMsg" style="color:red;"></p>
    </div>
</div>

<script src="../js/api.js"></script>
<script>
    const token = localStorage.getItem('token');
    let currentUser = null;
    let courses = [];

    // 获取用户信息
    apiRequest(API_ENDPOINTS.USER_INFO + `?token=${token}`)
        .then(resp => resp.json())
        .then(user => {
            currentUser = user;
            loadCourses();
        })
        .catch(err => console.error(err));

    function loadCourses() {
        apiRequest(API_ENDPOINTS.COURSES)
            .then(resp => resp.json())
            .then(data => {
                courses = Array.isArray(data) ? data : [];
                renderTable();
            })
            .catch(err => console.error(err));
    }

    function renderTable() {
        const tbody = document.querySelector('#courseTable tbody');
        if (!courses || courses.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8">暂无课程信息</td></tr>';
            return;
        }
        tbody.innerHTML = '';
        courses.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${c.id}</td>
                <td>${c.courseCode}</td>
                <td>${c.name}</td>
                <td>${c.credit}</td>
                <td>${c.capacity}</td>
                <td>${c.teacherId || '-'}</td>
                <td>${c.teacherName || '-'}</td>
                <td>${c.classroomId || '-'}</td>
                <td>${c.classroomName || '-'}</td>
                <td>
                    ${(currentUser.userType === 'ADMIN' || currentUser.userType === 'TEACHER')
                ? `<button onclick="openEditModal(${c.id})">编辑</button>
                           <button onclick="deleteCourse(${c.id})">删除</button>` : ''}
                </td>`;
            tbody.appendChild(tr);
        });
    }

    function openEditModal(id) {
        const c = courses.find(x => x.id === id);
        if (!c) return;
        document.getElementById('modalTitle').innerText = '编辑课程';
        document.getElementById('courseId').value = c.id;
        document.getElementById('courseCode').value = c.courseCode;
        document.getElementById('name').value = c.name;
        document.getElementById('credit').value = c.credit;
        document.getElementById('capacity').value = c.capacity;
        document.getElementById('teacherId').value = c.teacherId || '';
        document.getElementById('classroomId').value = c.classroomId || '';
        document.getElementById('modalMsg').innerText = '';
        document.getElementById('courseModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('courseModal').style.display = 'none';
    }

    function submitCourse() {
        const id = document.getElementById('courseId').value;
        const courseCode = document.getElementById('courseCode').value;
        const name = document.getElementById('name').value;
        const credit = parseInt(document.getElementById('credit').value);
        const capacity = parseInt(document.getElementById('capacity').value);
        const teacherId = parseInt(document.getElementById('teacherId').value);
        const classroomId = parseInt(document.getElementById('classroomId').value);

        if (!courseCode || !name || isNaN(credit) || isNaN(capacity) || isNaN(classroomId)) {
            document.getElementById('modalMsg').innerText = '请填写完整信息';
            return;
        }

        const payload = {
            courseCode,
            name,
            credit,
            capacity,
            teacher: teacherId ? { id: teacherId } : null,
            classroom: { id: classroomId }
        };

        let url = API_ENDPOINTS.COURSES;
        let method = 'POST';
        if (id) { url = API_ENDPOINTS.COURSE(id); method = 'PUT'; }

        apiRequest(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(resp => {
                if (!resp.ok) throw new Error('操作失败');
                return resp.json();
            })
            .then(() => {
                closeModal();
                loadCourses(); // 刷新表格
            })
            .catch(err => {
                console.error(err);
                document.getElementById('modalMsg').innerText = '操作失败';
            });
    }

    function deleteCourse(id) {
        if (!confirm('确定删除该课程吗？')) return;
        apiRequest(API_ENDPOINTS.COURSE(id), { method: 'DELETE' })
            .then(resp => {
                if (!resp.ok) throw new Error('删除失败');
                loadCourses();
            })
            .catch(err => alert('删除失败'));
    }
</script>

</body>
</html>