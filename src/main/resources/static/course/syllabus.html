<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>教学大纲</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">教学大纲</h1>
    
    <div class="toolbar">
        <button class="btn secondary" onclick="goBack()">返回首页</button>
    </div>

    <div class="form-section">
        <div class="form-group">
            <label for="courseSelect">选择课程</label>
            <select id="courseSelect" class="form-control" onchange="loadSyllabus()">
                <option value="">--请选择课程--</option>
            </select>
        </div>

        <div class="form-group">
            <label for="syllabusContent">教学大纲内容</label>
            <textarea id="syllabusContent" class="form-control" rows="10" placeholder="请先选择课程..." readonly></textarea>
        </div>

        <div id="teacherActions" class="form-actions" style="display:none;">
            <button class="btn primary" onclick="saveSyllabus()">保存</button>
            <button class="btn danger" onclick="deleteSyllabus()">删除</button>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    let currentUser = null;

    function goBack() { window.location.href = '../index.html'; }

    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);
    }

    document.addEventListener('DOMContentLoaded', function() {
        SidebarManager.init({ currentPage: 'syllabus' });
        HeaderComponent.init();
    });

    if (!token) {
        showToast('未检测到登录信息，请重新登录');
        setTimeout(() => window.location.href = '../auth/login.html', 1500);
    } else {
        apiRequest(API_ENDPOINTS.USER_INFO + `?token=${token}`)
            .then(resp => resp.json())
            .then(user => {
                currentUser = user;
                if (user.userType === 'TEACHER' || user.userType === 'ADMIN') {
                    document.getElementById('teacherActions').style.display = 'flex';
                    loadAllCourses();
                } else if (user.userType === 'STUDENT') {
                    loadAllCourses();
                } else {
                    showToast('无权限访问教学大纲');
                    setTimeout(() => window.location.href = '../index.html', 1500);
                }
            })
            .catch(err => {
                console.error(err);
                showToast('获取用户信息失败');
            });
    }

    function loadAllCourses() {
        apiRequest(API_ENDPOINTS.COURSES)
            .then(resp => resp.json())
            .then(courses => {
                const select = document.getElementById('courseSelect');
                courses.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;

                    if (currentUser.userType === 'TEACHER' && c.teacherId !== currentUser.id) {
                        opt.disabled = true;
                    }
                    select.appendChild(opt);
                });
            })
            .catch(err => {
                console.error(err);
                showToast('加载课程列表失败');
            });
    }

    function loadSyllabus() {
        const courseId = document.getElementById('courseSelect').value;
        const textarea = document.getElementById('syllabusContent');

        if (!courseId) {
            textarea.value = '';
            return;
        }

        apiRequest(API_ENDPOINTS.SYLLABUS(courseId))
            .then(resp => resp.ok ? resp.json() : null)
            .then(data => {
                if (!data) {
                    textarea.value = '';
                    if (currentUser.userType === 'TEACHER' || currentUser.userType === 'ADMIN') {
                        textarea.value = '暂无大纲，请编辑添加内容';
                    }
                } else {
                    textarea.value = data.content;
                }

                const selectedCourse = document.getElementById('courseSelect').selectedOptions[0];
                const canEdit = currentUser.userType === 'ADMIN' ||
                    (currentUser.userType === 'TEACHER' && !selectedCourse.disabled);
                textarea.readOnly = !canEdit;
                document.getElementById('teacherActions').style.display = canEdit ? 'flex' : 'none';
            })
            .catch(err => {
                console.error(err);
                showToast('加载大纲失败');
            });
    }

    function saveSyllabus() {
        const courseId = document.getElementById('courseSelect').value;
        const content = document.getElementById('syllabusContent').value;

        if (!courseId) {
            showToast('请先选择课程');
            return;
        }

        apiRequest(API_ENDPOINTS.SYLLABUS(courseId), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        })
            .then(resp => {
                if (!resp.ok) throw new Error('保存失败');
                showToast('保存成功');
            })
            .catch(err => {
                console.error(err);
                showToast('保存失败');
            });
    }

    function deleteSyllabus() {
        const courseId = document.getElementById('courseSelect').value;
        if (!courseId) {
            showToast('请先选择课程');
            return;
        }
        if (!confirm('确定删除该教学大纲吗？')) return;

        apiRequest(API_ENDPOINTS.SYLLABUS(courseId), {
            method: 'DELETE'
        })
            .then(resp => {
                if (!resp.ok) throw new Error('删除失败');
                document.getElementById('syllabusContent').value = '';
                showToast('删除成功');
            })
            .catch(err => {
                console.error(err);
                showToast('删除失败');
            });
    }
</script>
</body>
</html>
