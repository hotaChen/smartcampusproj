<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Smart Campus 通知管理</title>
    <style>
        /* 保持与现有项目风格统一的样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .tab-area {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            background-color: #e9e9e9;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        .tab-btn.active {
            background-color: #409eff;
            color: #fff;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .form-group label {
            width: 120px;
            text-align: right;
            padding-right: 10px;
            color: #666;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            flex: 1;
            max-width: 300px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #409eff;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: #fff;
            background-color: #409eff;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-danger {
            background-color: #f56c6c;
        }

        .btn-default {
            background-color: #e9e9e9;
            color: #333;
        }

        .table-area {
            margin-top: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            border: 1px solid #eee;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f8f8f8;
            color: #333;
        }

        .pagination {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-area {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f8f8f8;
            color: #666;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>Smart Campus 通知管理</h2>

    <!-- 标签切换区域 -->
    <div class="tab-area">
        <button class="tab-btn active" onclick="switchTab('query-tab')">通知查询</button>
        <button class="tab-btn" onclick="switchTab('create-tab')">创建通知</button>
        <button class="tab-btn" onclick="switchTab('update-tab')">更新通知</button>
        <button class="tab-btn" onclick="switchTab('operate-tab')">通知操作</button>
        <button class="tab-btn" onclick="switchTab('count-tab')">通知统计</button>
    </div>

    <!-- 1. 通知查询标签页 -->
    <div id="query-tab" class="tab-content">
        <h3>通知分页与条件查询</h3>
        <div class="form-group">
            <label for="query-page">页码</label>
            <input type="number" id="query-page" value="0" min="0" placeholder="页码（从0开始）">
        </div>
        <div class="form-group">
            <label for="query-size">每页条数</label>
            <input type="number" id="query-size" value="10" min="1" placeholder="每页显示条数">
        </div>
        <div class="form-group">
            <label for="query-audience">目标受众</label>
            <input type="text" id="query-audience" placeholder="如STUDENT/TEACHER/ADMIN">
        </div>
        <div class="form-group">
            <label for="query-type">通知类型</label>
            <input type="text" id="query-type" placeholder="如ANNOUNCEMENT/REMINDER">
        </div>
        <div class="form-group">
            <label for="query-publisher-id">发布者ID</label>
            <input type="number" id="query-publisher-id" placeholder="请输入发布者ID" min="1">
        </div>
        <button class="btn" onclick="getActiveNotifications()">获取所有活跃通知（分页）</button>
        <button class="btn" onclick="getNotificationsByAudience()">按受众查询</button>
        <button class="btn" onclick="getNotificationsByType()">按类型查询</button>
        <button class="btn" onclick="getNotificationsByPublisher()">按发布者查询</button>
        <button class="btn" onclick="getNotificationsByTimeRange()">按时间范围查询</button>
        <button class="btn" onclick="getCurrentActiveNotifications()">获取当前活跃通知</button>
        <button class="btn" onclick="getActiveNotificationsForAudiences()">按多受众查询活跃通知</button>

        <!-- 通知列表表格 -->
        <div class="table-area">
            <table id="notification-table">
                <thead>
                <tr>
                    <th>通知ID</th>
                    <th>标题</th>
                    <th>内容</th>
                    <th>受众</th>
                    <th>类型</th>
                    <th>发布者ID</th>
                    <th>发布时间</th>
                    <th>是否活跃</th>
                </tr>
                </thead>
                <tbody id="notification-tbody">
                <!-- 数据将通过JS动态填充 -->
                </tbody>
            </table>
        </div>

        <!-- 分页控件 -->
        <div class="pagination">
            <button class="btn btn-default" onclick="changePage(-1)">上一页</button>
            <span id="page-info">当前页码：0，总页数：0</span>
            <button class="btn btn-default" onclick="changePage(1)">下一页</button>
        </div>
    </div>

    <!-- 2. 创建通知标签页 -->
    <div id="create-tab" class="tab-content hidden">
        <h3>创建新通知</h3>
        <div class="form-group">
            <label for="create-title">通知标题</label>
            <input type="text" id="create-title" placeholder="请输入通知标题" required>
        </div>
        <div class="form-group">
            <label for="create-content">通知内容</label>
            <textarea id="create-content" placeholder="请输入通知详细内容" required></textarea>
        </div>
        <div class="form-group">
            <label for="create-audience">目标受众</label>
            <input type="text" id="create-audience" placeholder="如STUDENT/TEACHER/ADMIN" required>
        </div>
        <div class="form-group">
            <label for="create-type">通知类型</label>
            <input type="text" id="create-type" placeholder="如ANNOUNCEMENT/REMINDER" required>
        </div>
        <div class="form-group">
            <label for="create-publisher-id">发布者ID</label>
            <input type="number" id="create-publisher-id" placeholder="请输入发布者ID" min="1" required>
        </div>
        <div class="form-group">
            <label for="create-is-active">是否活跃</label>
            <select id="create-is-active" required>
                <option value="true">是</option>
                <option value="false">否</option>
            </select>
        </div>
        <div class="form-group">
            <label for="create-publish-time">发布时间</label>
            <input type="datetime-local" id="create-publish-time" placeholder="选择发布时间">
        </div>
        <button class="btn" onclick="createNotification()">创建通知</button>
    </div>

    <!-- 3. 更新通知标签页 -->
    <div id="update-tab" class="tab-content hidden">
        <h3>更新现有通知</h3>
        <div class="form-group">
            <label for="update-id">通知ID</label>
            <input type="number" id="update-id" placeholder="请输入要更新的通知ID" min="1" required>
        </div>
        <div class="form-group">
            <label for="update-title">新标题</label>
            <input type="text" id="update-title" placeholder="请输入新的通知标题">
        </div>
        <div class="form-group">
            <label for="update-content">新内容</label>
            <textarea id="update-content" placeholder="请输入新的通知详细内容"></textarea>
        </div>
        <div class="form-group">
            <label for="update-audience">新受众</label>
            <input type="text" id="update-audience" placeholder="如STUDENT/TEACHER/ADMIN">
        </div>
        <div class="form-group">
            <label for="update-type">新类型</label>
            <input type="text" id="update-type" placeholder="如ANNOUNCEMENT/REMINDER">
        </div>
        <div class="form-group">
            <label for="update-is-active">是否活跃</label>
            <select id="update-is-active">
                <option value="">保持不变</option>
                <option value="true">是</option>
                <option value="false">否</option>
            </select>
        </div>
        <button class="btn" onclick="updateNotification()">更新通知</button>
    </div>

    <!-- 4. 通知操作标签页 -->
    <div id="operate-tab" class="tab-content hidden">
        <h3>通知删除操作</h3>
        <div class="form-group">
            <label for="delete-id">通知ID</label>
            <input type="number" id="delete-id" placeholder="请输入要删除的通知ID" min="1">
        </div>
        <button class="btn btn-danger" onclick="deleteNotification()">删除通知（软删除）</button>
    </div>

    <!-- 5. 通知统计标签页 -->
    <div id="count-tab" class="tab-content hidden">
        <h3>通知数量统计</h3>
        <button class="btn" onclick="getActiveNotificationsCount()">获取活跃通知总数</button>
        <div class="info-area" id="count-info">
            点击上方按钮获取活跃通知数量...
        </div>
    </div>
</div>

<script>
    // 全局变量：当前页码、总页数
    let currentPage = 0;
    let totalPages = 0;
    const API_BASE_URL = "/api/notifications"; // 接口基础路径，与后端一致

    // 1. 标签切换功能
    function switchTab(tabId) {
        // 隐藏所有标签内容
        document.querySelectorAll('.tab-content').forEach(item => {
            item.classList.add('hidden');
        });
        // 移除所有标签激活状态
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        // 显示目标标签，激活目标按钮
        document.getElementById(tabId).classList.remove('hidden');
        event.target.classList.add('active');
    }

    // 2. 获取请求头（携带登录token，与现有项目逻辑一致）
    function getRequestHeaders() {
        const token = localStorage.getItem("token");
        return {
            "Content-Type": "application/json",
            "Authorization": token ? `Bearer ${token}` : ""
        };
    }

    // 3. 通知查询相关方法
    // 获取所有活跃通知（分页）
    function getActiveNotifications() {
        const page = parseInt(document.getElementById("query-page").value);
        const size = parseInt(document.getElementById("query-size").value);
        currentPage = page;

        fetch(`${API_BASE_URL}?page=${page}&size=${size}`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("获取活跃通知失败：" + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                renderNotificationTable(data);
                updatePageInfo(data);
            })
            .catch(err => {
                alert(err.message);
            });
    }

    // 按受众查询通知
    function getNotificationsByAudience() {
        const audience = document.getElementById("query-audience").value.trim();
        if (!audience) {
            alert("请输入目标受众！");
            return;
        }

        fetch(`${API_BASE_URL}/audience/${audience}`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("按受众查询失败：" + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                renderSimpleNotificationList(data);
            })
            .catch(err => {
                alert(err.message);
            });
    }

    // 按类型查询通知
    function getNotificationsByType() {
        const type = document.getElementById("query-type").value.trim();
        if (!type) {
            alert("请输入通知类型！");
            return;
        }

        fetch(`${API_BASE_URL}/type/${type}`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("按类型查询失败：" + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                renderSimpleNotificationList(data);
            })
            .catch(err => {
                alert(err.message);
            });
    }

    // 按发布者查询通知（分页）
    function getNotificationsByPublisher() {
        const publisherId = document.getElementById("query-publisher-id").value;
        if (!publisherId) {
            alert("请输入发布者ID！");
            return;
        }
        const page = parseInt(document.getElementById("query-page").value);
        const size = parseInt(document.getElementById("query-size").value);
        currentPage = page;

        fetch(`${API_BASE_URL}/publisher/${publisherId}?page=${page}&size=${size}`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("按发布者查询失败：" + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                renderNotificationTable(data);
                updatePageInfo(data);
            })
            .catch(err => {
                alert(err.message);
            });
    }

    // 按时间范围查询通知
    function getNotificationsByTimeRange() {
        const start = prompt("请输入开始时间（格式：yyyy-MM-dd'T'HH:mm:ss，如2025-12-01T00:00:00）");
        const end = prompt("请输入结束时间（格式：yyyy-MM-dd'T'HH:mm:ss，如2025-12-22T23:59:59）");
        if (!start || !end) {
            alert("开始时间和结束时间不能为空！");
            return;
        }

        fetch(`${API_BASE_URL}/time-range?start=${start}&end=${end}`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("按时间范围查询失败：" + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                renderSimpleNotificationList(data);
            })
            .catch(err => {
                alert(err.message);
            });
    }

    // 获取当前活跃通知
    function getCurrentActiveNotifications() {
        fetch(`${API_BASE_URL}/active`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("获取当前活跃通知失败：" + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                renderSimpleNotificationList(data);
            })
            .catch(err => {
                alert(err.message);
            });
    }

    // 按多受众查询活跃通知
    function getActiveNotificationsForAudiences() {
        const audiencesStr = prompt("请输入多个受众，用英文逗号分隔（如STUDENT,TEACHER,ADMIN）");
        if (!audiencesStr) {
            alert("请输入受众列表！");
            return;
        }
        const audiences = audiencesStr.split(",").map(item => item.trim());

        fetch(`${API_BASE_URL}/active/audiences`, {
            method: "POST",
            headers: getRequestHeaders(),
            body: JSON.stringify(audiences)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("按多受众查询活跃通知失败：" + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                renderSimpleNotificationList(data);
            })
            .catch(err => {
                alert(err.message);
            });
    }

    // 渲染分页通知表格
    function renderNotificationTable(pageData) {
        const tbody = document.getElementById("notification-tbody");
        tbody.innerHTML = ""; // 清空原有数据

        if (!pageData.content || pageData.content.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="8" style="text-align: center; color: #999;">暂无通知数据</td>`;
            tbody.appendChild(tr);
            return;
        }

        // 遍历数据渲染行
        pageData.content.forEach(notification => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                    <td>${notification.id || ""}</td>
                    <td>${notification.title || ""}</td>
                    <td title="${notification.content || ""}">${(notification.content || "").length > 30 ? (notification.content.substring(0, 30) + "...") : notification.content}</td>
                    <td>${notification.targetAudience || ""}</td>
                    <td>${notification.type || ""}</td>
                    <td>${notification.publisherId || ""}</td>
                    <td>${notification.publishTime || ""}</td>
                    <td>${notification.active ? "是" : "否"}</td>
                `;
            tbody.appendChild(tr);
        });
    }

    // 渲染非分页通知列表
    function renderSimpleNotificationList(notificationList) {
        const tbody = document.getElementById("notification-tbody");
        tbody.innerHTML = ""; // 清空原有数据

        if (!notificationList || notificationList.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="8" style="text-align: center; color: #999;">暂无通知数据</td>`;
            tbody.appendChild(tr);
            return;
        }

        // 遍历数据渲染行
        notificationList.forEach(notification => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                    <td>${notification.id || ""}</td>
                    <td>${notification.title || ""}</td>
                    <td title="${notification.content || ""}">${(notification.content || "").length > 30 ? (notification.content.substring(0, 30) + "...") : notification.content}</td>
                    <td>${notification.targetAudience || ""}</td>
                    <td>${notification.type || ""}</td>
                    <td>${notification.publisherId || ""}</td>
                    <td>${notification.publishTime || ""}</td>
                    <td>${notification.active ? "是" : "否"}</td>
                `;
            tbody.appendChild(tr);
        });

        // 重置分页信息
        document.getElementById("page-info").innerText = "当前为非分页查询，无分页信息";
    }

    // 更新分页信息
    function updatePageInfo(pageData) {
        totalPages = pageData.totalPages || 0;
        document.getElementById("page-info").innerText = `当前页码：${currentPage}，总页数：${totalPages}，总条数：${pageData.totalElements || 0}`;
    }

    // 切换页码
    function changePage(type) {
        const newPage = currentPage + type;
        if (newPage < 0 || newPage >= totalPages) {
            alert(type === -1 ? "已经是第一页" : "已经是最后一页");
            return;
        }
        document.getElementById("query-page").value = newPage;
        getActiveNotifications(); // 重新查询
    }

    // 4. 创建通知方法
    function createNotification() {
        const title = document.getElementById("create-title").value.trim();
        const content = document.getElementById("create-content").value.trim();
        const targetAudience = document.getElementById("create-audience").value.trim();
        const type = document.getElementById("create-type").value.trim();
        const publisherId = document.getElementById("create-publisher-id").value;
        const isActive = document.getElementById("create-is-active").value === "true";
        const publishTime = document.getElementById("create-publish-time").value ? (document.getElementById("create-publish-time").value + ":00") : null;

        // 校验必填项
        if (!title || !content || !targetAudience || !type || !publisherId) {
            alert("标题、内容、受众、类型、发布者ID为必填项！");
            return;
        }

        // 构造通知对象
        const notification = {
            title,
            content,
            targetAudience,
            type,
            publisherId: parseInt(publisherId),
            active: isActive,
            publishTime: publishTime
        };

        fetch(`${API_BASE_URL}`, {
            method: "POST",
            headers: getRequestHeaders(),
            body: JSON.stringify(notification)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("创建通知失败：" + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                alert("通知创建成功！通知ID：" + data.id);
                // 清空表单
                document.getElementById("create-title").value = "";
                document.getElementById("create-content").value = "";
                document.getElementById("create-audience").value = "";
                document.getElementById("create-type").value = "";
                document.getElementById("create-publisher-id").value = "";
                document.getElementById("create-publish-time").value = "";
                getActiveNotifications(); // 刷新列表
            })
            .catch(err => {
                alert(err.message);
            });
    }

    // 5. 更新通知方法
    function updateNotification() {
        const id = document.getElementById("update-id").value;
        if (!id) {
            alert("请输入要更新的通知ID！");
            return;
        }

        // 构造更新对象（仅填充非空值）
        const notification = {};
        const title = document.getElementById("update-title").value.trim();
        const content = document.getElementById("update-content").value.trim();
        const targetAudience = document.getElementById("update-audience").value.trim();
        const type = document.getElementById("update-type").value.trim();
        const isActive = document.getElementById("update-is-active").value;

        if (title) notification.title = title;
        if (content) notification.content = content;
        if (targetAudience) notification.targetAudience = targetAudience;
        if (type) notification.type = type;
        if (isActive !== "") notification.active = (isActive === "true");

        fetch(`${API_BASE_URL}/${id}`, {
            method: "PUT",
            headers: getRequestHeaders(),
            body: JSON.stringify(notification)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("更新通知失败：" + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                alert("通知更新成功！");
                // 清空表单
                document.getElementById("update-id").value = "";
                document.getElementById("update-title").value = "";
                document.getElementById("update-content").value = "";
                document.getElementById("update-audience").value = "";
                document.getElementById("update-type").value = "";
                document.getElementById("update-is-active").value = "";
                getActiveNotifications(); // 刷新列表
            })
            .catch(err => {
                alert(err.message);
            });
    }

    // 6. 删除通知方法
    function deleteNotification() {
        const id = document.getElementById("delete-id").value;
        if (!id) {
            alert("请输入要删除的通知ID！");
            return;
        }

        if (!confirm("确定要删除该通知吗？（软删除，可后台恢复）")) {
            return;
        }

        fetch(`${API_BASE_URL}/${id}`, {
            method: "DELETE",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("删除通知失败：" + response.statusText);
                }
                alert("通知删除成功！");
                document.getElementById("delete-id").value = "";
                getActiveNotifications(); // 刷新列表
            })
            .catch(err => {
                alert(err.message);
            });
    }

    // 7. 获取活跃通知数量
    function getActiveNotificationsCount() {
        fetch(`${API_BASE_URL}/count/active`, {
            method: "GET",
            headers: getRequestHeaders()
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("获取活跃通知数量失败：" + response.statusText);
                }
                return response.json();
            })
            .then(count => {
                document.getElementById("count-info").innerText = `当前系统活跃通知总数：${count} 条`;
            })
            .catch(err => {
                alert(err.message);
                document.getElementById("count-info").innerText = "获取活跃通知数量失败：" + err.message;
            });
    }

    // 页面加载完成后，默认查询一次活跃通知
    window.onload = function() {
        getActiveNotifications();
    };
</script>
</body>
</html>