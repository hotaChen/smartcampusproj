<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>预约模块</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">预约模块</h1>
    
    <div class="toolbar">
        <button class="btn secondary" onclick="goBack()">返回首页</button>
    </div>

    <div id="appointment-section" class="form-section">
        <p class="empty-state">正在加载功能...</p>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    let currentUser = null;

    function goBack() { window.location.href = '../index.html'; }

    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);
    }

    document.addEventListener('DOMContentLoaded', function() {
        SidebarManager.init({ currentPage: 'appointment' });
        HeaderComponent.init();
    });

    if (!token) {
        document.getElementById('appointment-section').innerHTML = '<p class="empty-state">未检测到登录信息，请重新登录</p>';
    } else {
        apiRequest(API_ENDPOINTS.USER_INFO + `?token=${token}`)
            .then(resp => resp.json())
            .then(user => {
                currentUser = user;
                const section = document.getElementById('appointment-section');
                let html = '';
                if (user.userType === 'STUDENT') {
                    html = `
                        <div class="toolbar" style="margin-bottom: 20px;">
                            <button class="btn primary" onclick="createAppointment()">创建预约</button>
                            <button class="btn secondary" onclick="viewMyAppointments()">查看我的预约</button>
                        </div>
                        <div id="student-appointments"></div>
                    `;
                } else if (user.userType === 'ADMIN') {
                    html = `
                        <div class="toolbar" style="margin-bottom: 20px;">
                            <button class="btn secondary" onclick="viewAllAppointments()">查看所有预约</button>
                        </div>
                        <div id="admin-appointments"></div>
                    `;
                } else {
                    html = '<p class="empty-state">无预约权限</p>';
                }
                section.innerHTML = html;
            })
            .catch(err => {
                console.error(err);
                showToast('获取用户信息失败');
            });
    }

    function createAppointment() {
        const serviceType = prompt('请输入预约服务类型:');
        const appointmentTime = prompt('请输入预约时间 (格式: 2025-12-21T10:00):');

        if (!serviceType || !appointmentTime) {
            showToast('服务类型和预约时间不能为空');
            return;
        }

        apiRequest(API_ENDPOINTS.APPOINTMENTS, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `serviceType=${encodeURIComponent(serviceType)}&appointmentTime=${encodeURIComponent(appointmentTime)}`
        })
            .then(resp => {
                if (!resp.ok) return resp.text().then(text => { throw new Error(text); });
                return resp.json();
            })
            .then(data => {
                showToast('预约成功！ID: ' + data.id);
                viewMyAppointments();
            })
            .catch(err => {
                console.error(err);
                showToast('创建失败: ' + err.message);
            });
    }

    function viewMyAppointments() {
        apiRequest(API_ENDPOINTS.MY_APPOINTMENTS)
            .then(resp => resp.json())
            .then(list => {
                const container = document.getElementById('student-appointments');
                if (!list.length) {
                    container.innerHTML = '<p class="empty-state">暂无预约记录</p>';
                    return;
                }
                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>服务类型</th>
                                <th>预约时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${list.map(a => `
                                <tr>
                                    <td>${a.serviceType}</td>
                                    <td>${a.appointmentTime}</td>
                                    <td>${a.status}</td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="action-btn delete" onclick="cancelAppointment(${a.id})">取消</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            })
            .catch(err => {
                console.error(err);
                showToast('加载预约记录失败');
            });
    }

    function cancelAppointment(id) {
        if (!confirm('确定取消该预约吗？')) return;
        apiRequest(API_ENDPOINTS.CANCEL_APPOINTMENT(id), { method: 'PUT' })
            .then(resp => resp.json())
            .then(() => {
                showToast('已取消预约');
                viewMyAppointments();
            })
            .catch(err => {
                console.error(err);
                showToast('取消失败');
            });
    }

    function viewAllAppointments() {
        apiRequest(API_ENDPOINTS.APPOINTMENTS)
            .then(resp => resp.json())
            .then(list => {
                const container = document.getElementById('admin-appointments');
                if (!list.length) {
                    container.innerHTML = '<p class="empty-state">暂无预约记录</p>';
                    return;
                }
                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>服务类型</th>
                                <th>预约时间</th>
                                <th>学生姓名</th>
                                <th>学号</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${list.map(a => {
                                const studentName = a.student ? a.student.realName : '-';
                                const studentNo = a.student ? a.student.studentId : '-';
                                let actionBtns = '';
                                if (a.status === 'PENDING') {
                                    actionBtns += `<button class="action-btn" onclick="approveAppointment(${a.id})">审批</button>`;
                                }
                                if (a.status !== 'COMPLETED') {
                                    actionBtns += `<button class="action-btn" onclick="completeAppointment(${a.id})">完成</button>`;
                                }
                                return `
                                    <tr>
                                        <td>${a.serviceType}</td>
                                        <td>${a.appointmentTime}</td>
                                        <td>${studentName}</td>
                                        <td>${studentNo}</td>
                                        <td>${a.status}</td>
                                        <td>
                                            <div class="table-actions">${actionBtns}</div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            })
            .catch(err => {
                console.error(err);
                showToast('加载预约记录失败');
            });
    }

    function approveAppointment(id) {
        apiRequest(API_ENDPOINTS.APPROVE_APPOINTMENT(id), { method: 'PUT' })
            .then(resp => resp.json())
            .then(() => {
                showToast('预约已审批');
                viewAllAppointments();
            })
            .catch(err => {
                console.error(err);
                showToast('审批失败');
            });
    }

    function completeAppointment(id) {
        apiRequest(API_ENDPOINTS.COMPLETE_APPOINTMENT(id), { method: 'PUT' })
            .then(resp => resp.json())
            .then(() => {
                showToast('预约已完成');
                viewAllAppointments();
            })
            .catch(err => {
                console.error(err);
                showToast('操作失败');
            });
    }
</script>
</body>
</html>
