<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>教室管理</title>
    <link rel="stylesheet" href="../css/style.css?v=egg-final">
    <link rel="stylesheet" href="../css/page.css?v=egg-final">
    <link rel="stylesheet" href="../css/sidebar.css?v=egg-final">
</head>
<body class="with-sidebar">
<canvas id="bg"></canvas>
<script src="../js/api.js"></script>
<script src="../js/particles.js?v=egg-final"></script>
<script src="../js/egg.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/header.js"></script>

<div id="header-container"></div>
<div id="toast" class="toast"></div>

<div class="page-content">
    <h1 class="page-title">教室管理</h1>
    
    <div class="toolbar">
        <button class="btn secondary" onclick="goBack()">返回首页</button>
        <button class="btn primary" id="addBtn" style="display:none;" onclick="openAddModal()">新增教室</button>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>楼栋</th>
                <th>房间号</th>
                <th>容量</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="classroomTableBody">
            <tr><td colspan="5" class="empty-state">正在加载教室信息...</td></tr>
        </tbody>
    </table>
</div>

<div class="modal" id="classroomModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">新增教室</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <input type="hidden" id="classroomId">
        <div class="form-group">
            <label>楼栋</label>
            <input type="text" id="building" placeholder="请输入楼栋">
        </div>
        <div class="form-group">
            <label>房间号</label>
            <input type="text" id="roomNumber" placeholder="请输入房间号">
        </div>
        <div class="form-group">
            <label>容量</label>
            <input type="number" id="capacity" placeholder="请输入容量">
        </div>
        <p id="modalMsg" class="message error" style="display:none;"></p>
        <div class="form-actions">
            <button class="btn primary" onclick="submitClassroom()">提交</button>
            <button class="btn secondary" onclick="closeModal()">取消</button>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    let currentUser = null;
    let classrooms = [];

    function goBack() { window.location.href = '../index.html'; }

    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);
    }

    document.addEventListener('DOMContentLoaded', function() {
        SidebarManager.init({ currentPage: 'classroom' });
        HeaderComponent.init();
    });

    if (!token) {
        document.getElementById('classroomTableBody').innerHTML = '<tr><td colspan="5" class="empty-state">未检测到登录信息，请重新登录</td></tr>';
    } else {
        apiRequest(API_ENDPOINTS.USER_INFO + `?token=${token}`)
            .then(resp => resp.json())
            .then(user => {
                currentUser = user;
                if (user.userType === 'ADMIN') {
                    document.getElementById('addBtn').style.display = 'inline-block';
                }
                loadClassrooms();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('classroomTableBody').innerHTML = '<tr><td colspan="5" class="empty-state">获取用户信息失败</td></tr>';
            });
    }

    function loadClassrooms() {
        apiRequest(API_ENDPOINTS.CLASSROOMS)
            .then(resp => resp.json())
            .then(data => {
                classrooms = Array.isArray(data) ? data : [];
                renderTable();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('classroomTableBody').innerHTML = '<tr><td colspan="5" class="empty-state">加载失败，请检查接口或权限</td></tr>';
            });
    }

    function renderTable() {
        const tbody = document.getElementById('classroomTableBody');
        if (!classrooms.length) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state">暂无教室信息</td></tr>';
            return;
        }
        tbody.innerHTML = '';
        classrooms.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${c.id}</td>
                <td>${c.building}</td>
                <td>${c.roomNumber}</td>
                <td>${c.capacity}</td>
                <td>
                    <div class="table-actions">
                        ${currentUser.userType === 'ADMIN' ? `
                            <button class="action-btn edit" onclick="openEditModal(${c.id})">编辑</button>
                            <button class="action-btn delete" onclick="deleteClassroom(${c.id})">删除</button>
                        ` : ''}
                    </div>
                </td>`;
            tbody.appendChild(tr);
        });
    }

    function openAddModal() {
        document.getElementById('modalTitle').innerText = '新增教室';
        document.getElementById('classroomId').value = '';
        document.getElementById('building').value = '';
        document.getElementById('roomNumber').value = '';
        document.getElementById('capacity').value = '';
        document.getElementById('modalMsg').style.display = 'none';
        document.getElementById('classroomModal').classList.add('show');
    }

    function openEditModal(id) {
        const c = classrooms.find(x => x.id === id);
        if (!c) return;
        document.getElementById('modalTitle').innerText = '编辑教室';
        document.getElementById('classroomId').value = c.id;
        document.getElementById('building').value = c.building;
        document.getElementById('roomNumber').value = c.roomNumber;
        document.getElementById('capacity').value = c.capacity;
        document.getElementById('modalMsg').style.display = 'none';
        document.getElementById('classroomModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('classroomModal').classList.remove('show');
        document.getElementById('modalMsg').style.display = 'none';
    }

    function submitClassroom() {
        const id = document.getElementById('classroomId').value;
        const building = document.getElementById('building').value;
        const roomNumber = document.getElementById('roomNumber').value;
        const capacity = document.getElementById('capacity').value;

        if (!building || !roomNumber || !capacity) {
            const msgEl = document.getElementById('modalMsg');
            msgEl.innerText = '请填写完整信息';
            msgEl.style.display = 'block';
            return;
        }

        const payload = { building, roomNumber, capacity };
        let url = API_ENDPOINTS.CLASSROOMS;
        let method = 'POST';
        if (id) { url = API_ENDPOINTS.CLASSROOM(id); method = 'PUT'; }

        apiRequest(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(resp => {
                if (!resp.ok) throw new Error('操作失败');
                return resp.json();
            })
            .then(() => {
                closeModal();
                showToast('操作成功');
                loadClassrooms();
            })
            .catch(err => {
                console.error(err);
                const msgEl = document.getElementById('modalMsg');
                msgEl.innerText = '操作失败';
                msgEl.style.display = 'block';
            });
    }

    function deleteClassroom(id) {
        if (!confirm('确定删除该教室吗？')) return;
        apiRequest(API_ENDPOINTS.CLASSROOM(id), { method: 'DELETE' })
            .then(resp => {
                if (!resp.ok) throw new Error('删除失败');
                showToast('删除成功');
                loadClassrooms();
            })
            .catch(err => {
                console.error(err);
                showToast('删除失败');
            });
    }
</script>
</body>
</html>
